const config = require('./config');
const Keyboards = require('./keyboards');
const Database = require('./database');

class Handlers {
    constructor(bot, db) {
        this.bot = bot;
        this.db = db;
        this.setupHandlers();
    }

    setupHandlers() {
        // –ö–æ–º–∞–Ω–¥–∞ /start
        this.bot.onText(/\/start(.*)/, (msg, match) => {
            this.handleStart(msg, match);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ callback_query
        this.bot.on('callback_query', (callbackQuery) => {
            this.handleCallbackQuery(callbackQuery);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        this.bot.on('message', (msg) => {
            this.handleMessage(msg);
        });
    }

    async handleStart(msg, match) {
        const chatId = msg.chat.id;
        const telegramId = msg.from.id;
        const username = msg.from.username;
        const firstName = msg.from.first_name;
        const lastName = msg.from.last_name;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
        const referralCode = match[1] ? match[1].trim() : null;
        let referredBy = null;

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let user = await this.db.getUser(telegramId);
        if (!user) {
            const userReferralCode = this.db.generateReferralCode(telegramId);
            await this.db.createUser({
                telegramId,
                username,
                firstName,
                lastName,
                referralCode: userReferralCode,
                referredBy
            });
            user = await this.db.getUser(telegramId);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
        if (referralCode && referralCode !== user.referral_code) {
            const referrer = await this.findUserByReferralCode(referralCode);
            if (referrer && !user.referred_by) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await this.db.db.run(
                    'UPDATE users SET referred_by = ? WHERE telegram_id = ?',
                    [referrer.telegram_id, telegramId]
                );

                // –°–æ–∑–¥–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª
                await this.db.createReferral(referrer.telegram_id, telegramId, config.REFERRAL_BONUS);
                
                // –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å —Ä–µ—Ñ–µ—Ä–µ—Ä—É
                await this.db.updateUserBalance(referrer.telegram_id, config.REFERRAL_BONUS);
                
                // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                await this.db.createTransaction(
                    referrer.telegram_id,
                    'referral_bonus',
                    config.REFERRAL_BONUS,
                    `–ë–æ–Ω—É—Å –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ ${firstName || username}`
                );

                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
                this.bot.sendMessage(
                    referrer.telegram_id,
                    `üéâ –í–∞—à —Å—á–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${config.REFERRAL_BONUS}$!\n` +
                    `üë§ –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ: ${firstName || username}\n` +
                    `üéÆ –ó–∞—Ö–æ–¥–∏—Ç–µ –≤ –∏–≥—Ä—É –∏ —Ç—Ä–∞—Ç—å—Ç–µ –±–æ–Ω—É—Å—ã!`
                );
            }
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å —Ñ–æ—Ç–æ
        this.bot.sendPhoto(
            chatId,
            config.MEDIA.WELCOME_PHOTO,
            {
                caption: config.MESSAGES.WELCOME,
                ...Keyboards.getMainMenu()
            }
        );
    }

    async handleCallbackQuery(callbackQuery) {
        const chatId = callbackQuery.message.chat.id;
        const messageId = callbackQuery.message.message_id;
        const data = callbackQuery.data;

        try {
            await this.bot.answerCallbackQuery(callbackQuery.id);

            switch (data) {
                case 'main_menu':
                    await this.showMainMenu(chatId, messageId);
                    break;

                case 'about_project':
                    await this.showAboutProject(chatId, messageId);
                    break;

                case 'get_clients':
                    await this.showGetClients(chatId, messageId);
                    break;

                case 'earn_money':
                    await this.showEarnMoney(chatId, messageId);
                    break;

                case 'play_game':
                    await this.showPlayGame(chatId, messageId);
                    break;

                case 'community':
                    await this.showCommunity(chatId, messageId);
                    break;

                case 'become_master':
                    await this.handleBecomeMaster(chatId, messageId);
                    break;

                case 'invite_friend':
                    await this.showInviteFriend(chatId, messageId);
                    break;

                case 'my_partners':
                    await this.showMyPartners(chatId, messageId);
                    break;

                case 'partner_stats':
                    await this.showPartnerStats(chatId, messageId);
                    break;

                case 'partner_list':
                    await this.showPartnerList(chatId, messageId);
                    break;

                case 'watch_about_video':
                    await this.showAboutVideo(chatId, messageId);
                    break;

                case 'watch_community_video':
                    await this.showCommunityVideo(chatId, messageId);
                    break;

                case 'watch_game_video':
                    await this.showGameVideo(chatId, messageId);
                    break;

                case 'close':
                    await this.bot.deleteMessage(chatId, messageId);
                    break;

                default:
                    if (data.startsWith('copy_link_')) {
                        const referralCode = data.replace('copy_link_', '');
                        await this.copyReferralLink(chatId, referralCode);
                    }
                    break;
            }
        } catch (error) {
            console.error('Error handling callback query:', error);
        }
    }

    async handleMessage(msg) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
    async showMainMenu(chatId, messageId) {
        await this.bot.editMessageText(
            'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª:',
            {
                chat_id: chatId,
                message_id: messageId,
                ...Keyboards.getMainMenu()
            }
        );
    }

    async showAboutProject(chatId, messageId) {
        await this.bot.editMessageText(
            config.MESSAGES.ABOUT_PROJECT,
            {
                chat_id: chatId,
                message_id: messageId,
                ...Keyboards.getAboutProjectKeyboard()
            }
        );
    }

    async showGetClients(chatId, messageId) {
        await this.bot.editMessageText(
            config.MESSAGES.GET_CLIENTS,
            {
                chat_id: chatId,
                message_id: messageId,
                ...Keyboards.getGetClientsKeyboard()
            }
        );
    }

    async showEarnMoney(chatId, messageId) {
        await this.bot.editMessageText(
            config.MESSAGES.EARN_MONEY,
            {
                chat_id: chatId,
                message_id: messageId,
                ...Keyboards.getEarnMoneyKeyboard()
            }
        );
    }

    async showPlayGame(chatId, messageId) {
        await this.bot.editMessageText(
            config.MESSAGES.PLAY_GAME,
            {
                chat_id: chatId,
                message_id: messageId,
                ...Keyboards.getPlayGameKeyboard()
            }
        );
    }

    async showCommunity(chatId, messageId) {
        await this.bot.editMessageText(
            config.MESSAGES.COMMUNITY,
            {
                chat_id: chatId,
                message_id: messageId,
                ...Keyboards.getCommunityKeyboard()
            }
        );
    }

    async handleBecomeMaster(chatId, messageId) {
        const user = await this.db.getUser(chatId);
        if (!user) return;

        // –°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É –Ω–∞ –º–∞—Å—Ç–µ—Ä–∞
        await this.db.createMasterApplication(chatId);

        await this.bot.editMessageText(
            '‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!\n\nüë®‚Äçüíº –° –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞.\n\nüìû –ú—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤–∞—à—É –∑–∞—è–≤–∫—É –∏ –¥–∞–¥–∏–º –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.',
            {
                chat_id: chatId,
                message_id: messageId,
                ...Keyboards.getCloseKeyboard()
            }
        );
    }

    async showInviteFriend(chatId, messageId) {
        const user = await this.db.getUser(chatId);
        if (!user) return;

        const referralLink = `https://t.me/your_bot_username?start=${user.referral_code}`;
        
        await this.bot.editMessageText(
            `üë• –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –∏ –ø–æ–ª—É—á–∏ ${config.REFERRAL_BONUS}$!\n\n` +
            `üîó –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n` +
            `\`${referralLink}\`\n\n` +
            `üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:\n` +
            `‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É\n` +
            `‚Ä¢ –î—Ä—É–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ —Å—Å—ã–ª–∫–µ\n` +
            `‚Ä¢ –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ ${config.REFERRAL_BONUS}$ –Ω–∞ —Å—á–µ—Ç\n` +
            `‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ 10% –æ—Ç –≤—Å–µ—Ö —Ç—Ä–∞—Ç –¥—Ä—É–≥–∞ –≤ –∏–≥—Ä–µ`,
            {
                chat_id: chatId,
                message_id: messageId,
                parse_mode: 'Markdown',
                ...Keyboards.getReferralLinkKeyboard(user.referral_code)
            }
        );
    }

    async showMyPartners(chatId, messageId) {
        await this.bot.editMessageText(
            'üë• –ú–æ–∏ –ø–∞—Ä—Ç–Ω–µ—Ä—ã\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
            {
                chat_id: chatId,
                message_id: messageId,
                ...Keyboards.getMyPartnersKeyboard()
            }
        );
    }

    async showPartnerStats(chatId, messageId) {
        const stats = await this.db.getReferralStats(chatId);
        
        await this.bot.editMessageText(
            `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤\n\n` +
            `üë• –í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ: ${stats.total_referrals}\n` +
            `üí∞ –û–±—â–∏–π –±–æ–Ω—É—Å: ${stats.total_bonus}$\n` +
            `‚úÖ –ü–æ–ª—É—á–µ–Ω–æ: ${stats.completed_bonus}$\n` +
            `‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ: ${stats.total_bonus - stats.completed_bonus}$`,
            {
                chat_id: chatId,
                message_id: messageId,
                ...Keyboards.getBackKeyboard('my_partners')
            }
        );
    }

    async showPartnerList(chatId, messageId) {
        const partners = await this.db.getReferralList(chatId);
        
        let message = 'üë• –°–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤:\n\n';
        
        if (partners.length === 0) {
            message += 'üòî –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤.\n–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π –∏ –Ω–∞—á–Ω–∏—Ç–µ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å!';
        } else {
            partners.forEach((partner, index) => {
                const name = partner.username || `${partner.first_name} ${partner.last_name}`.trim();
                const date = new Date(partner.created_at).toLocaleDateString('ru-RU');
                message += `${index + 1}. ${name}\n`;
                message += `   üí∞ –ë–æ–Ω—É—Å: ${partner.bonus_amount}$\n`;
                message += `   üìÖ –î–∞—Ç–∞: ${date}\n\n`;
            });
        }
        
        await this.bot.editMessageText(
            message,
            {
                chat_id: chatId,
                message_id: messageId,
                ...Keyboards.getBackKeyboard('my_partners')
            }
        );
    }

    async copyReferralLink(chatId, referralCode) {
        const referralLink = `https://t.me/your_bot_username?start=${referralCode}`;
        
        await this.bot.sendMessage(
            chatId,
            `üìã –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!\n\n\`${referralLink}\`\n\nüí° –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –µ—é —Å –¥—Ä—É–∑—å—è–º–∏!`,
            { parse_mode: 'Markdown' }
        );
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤–∏–¥–µ–æ
    async showAboutVideo(chatId, messageId) {
        await this.bot.sendVideo(
            chatId,
            config.MEDIA.ABOUT_PROJECT,
            {
                caption: 'üìπ –í–∏–¥–µ–æ –æ –ø—Ä–æ–µ–∫—Ç–µ "–≠–Ω–µ—Ä–≥–∏—è –¥–µ–Ω–µ–≥"'
            }
        );
    }

    async showCommunityVideo(chatId, messageId) {
        await this.bot.sendVideo(
            chatId,
            config.MEDIA.COMMUNITY,
            {
                caption: 'üìπ –í–∏–¥–µ–æ –æ –Ω–∞—à–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ'
            }
        );
    }

    async showGameVideo(chatId, messageId) {
        await this.bot.sendVideo(
            chatId,
            config.MEDIA.PLAY_GAME,
            {
                caption: 'üìπ –ö–∞–∫ –∏–≥—Ä–∞—Ç—å –≤ "–≠–Ω–µ—Ä–≥–∏—é –¥–µ–Ω–µ–≥"'
            }
        );
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    async findUserByReferralCode(referralCode) {
        return new Promise((resolve, reject) => {
            this.db.db.get(
                'SELECT * FROM users WHERE referral_code = ?',
                [referralCode],
                (err, row) => {
                    if (err) reject(err);
                    else resolve(row);
                }
            );
        });
    }
}

module.exports = Handlers;

