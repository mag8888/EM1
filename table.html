<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Игровой стол - Энергия денег</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    
    <!-- Банковский модуль v3 -->
    <link rel="stylesheet" href="bank-module-v3/bank-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Using system fonts to avoid connection issues */
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #0c1445 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            pointer-events: none;
        }

        .game-container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Игровое поле */
        .game-board {
            flex: 1;
            background: rgba(22, 33, 62, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .board-wrapper {
            position: relative;
            width: 88vh;
            height: 88vh;
            max-width: 880px;
            max-height: 880px;
            filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.1));
        }

        /* Внешний периметр - 650x650 */
        .outer-perimeter {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 650px;
            height: 650px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 0;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 
                inset 0 0 0 1px rgba(255, 255, 255, 0.1),
                0 0 20px rgba(255, 255, 255, 0.05);
        }

        .outer-squares {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .outer-square {
            position: absolute;
            width: 58px;
            height: 58px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .outer-square::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .outer-square:hover {
            transform: scale(1.1) translateY(-2px);
            z-index: 10;
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.3),
                0 0 15px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .outer-square:hover::before {
            opacity: 1;
        }

        .outer-square .square-icon {
            font-size: 23px;
            margin-bottom: 2px;
        }

        .outer-square .square-number {
            font-size: 15px;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Маркер сердечка на клетке (мечта игрока) */
        .cell-heart {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 16px;
            z-index: 20;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
            pointer-events: none;
        }
        .cell-heart.p0 { color: #ef4444; }
        .cell-heart.p1 { color: #10b981; }
        .cell-heart.p2 { color: #3b82f6; }

        /* Внутренний спиральный трек */
        .inner-track {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 66%;
            height: 66%;
        }

        .inner-squares {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .inner-square {
            position: absolute;
            width: 59px;
            height: 59px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .inner-square::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .inner-square:hover {
            transform: scale(1.25) translateY(-2px);
            z-index: 10;
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.3),
                0 0 15px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .inner-square:hover::before {
            opacity: 1;
        }



        /* Цифры в углу клеток */
        .square-number {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        /* Цифры в левом нижнем углу для клеток 11-24 */
        .square-number.bottom-left {
            top: auto;
            right: auto;
            bottom: 4px;
            left: 4px;
        }

        /* Цифра в правом верхнем углу для клетки 24 */
        .square-number.top-right {
            top: 4px;
            right: 4px;
            bottom: auto;
            left: auto;
        }

        /* Цифра в правом нижнем углу для клетки 2 */
        .square-number.bottom-right {
            top: auto;
            right: 4px;
            bottom: 4px;
            left: auto;
        }

        /* Крупные однотонные иконки */
        .square-icon {
            font-size: 32px;
            filter: grayscale(100%) brightness(1.2);
            opacity: 0.9;
        }

        .inner-square .square-icon {
            font-size: 28px;
        }

        /* Центральный логотип */
        .center-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 8px 32px rgba(255, 215, 0, 0.4),
                0 0 0 4px rgba(255, 215, 0, 0.2);
            z-index: 20;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .center-logo:hover {
            transform: translate(-50%, -50%) scale(1.05);
        }

        .logo-inner {
            width: 140px;
            height: 140px;
            background: radial-gradient(circle, #000000 0%, #1a1a1a 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .dice {
            font-size: 48px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 40px rgba(255, 165, 0, 0.6);
            z-index: 3;
            position: relative;
        }

        .dice.rolling {
            animation: diceRoll 0.1s infinite;
        }

        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(0.9); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        /* Энергетические линии */
        .energy-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(255, 215, 0, 0.3) 45deg,
                transparent 90deg,
                rgba(255, 165, 0, 0.3) 135deg,
                transparent 180deg,
                rgba(255, 140, 0, 0.3) 225deg,
                transparent 270deg,
                rgba(255, 215, 0, 0.3) 315deg,
                transparent 360deg
            );
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Светящиеся точки */
        .glow-dots {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        .glow-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #FFD700;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            animation: pulse 2s ease-in-out infinite;
        }

        .glow-dot:nth-child(1) {
            transform: translate(-50%, -50%) rotate(0deg) translateY(-50px);
            animation-delay: 0s;
        }

        .glow-dot:nth-child(2) {
            transform: translate(-50%, -50%) rotate(60deg) translateY(-50px);
            animation-delay: 0.3s;
        }

        .glow-dot:nth-child(3) {
            transform: translate(-50%, -50%) rotate(120deg) translateY(-50px);
            animation-delay: 0.6s;
        }

        .glow-dot:nth-child(4) {
            transform: translate(-50%, -50%) rotate(180deg) translateY(-50px);
            animation-delay: 0.9s;
        }

        .glow-dot:nth-child(5) {
            transform: translate(-50%, -50%) rotate(240deg) translateY(-50px);
            animation-delay: 1.2s;
        }

        .glow-dot:nth-child(6) {
            transform: translate(-50%, -50%) rotate(300deg) translateY(-50px);
            animation-delay: 1.5s;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 0.3;
                transform: translate(-50%, -50%) scale(1);
            }
            50% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        /* Внешние монеты */
        .outer-coins {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .coin {
            position: absolute;
            width: 24px;
            height: 24px;
            background: radial-gradient(circle, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.6);
            border: 2px solid #FFD700;
        }

        .coin:nth-child(1) {
            transform: translate(-50%, -50%) rotate(45deg) translateY(-70px);
        }

        .coin:nth-child(2) {
            transform: translate(-50%, -50%) rotate(135deg) translateY(-70px);
        }

        .coin:nth-child(3) {
            transform: translate(-50%, -50%) rotate(225deg) translateY(-70px);
        }

        .coin:nth-child(4) {
            transform: translate(-50%, -50%) rotate(315deg) translateY(-70px);
        }

        .coin-symbol {
            font-size: 12px;
            font-weight: bold;
            color: #000000;
        }

        /* Угловые карточки */
        .corner-cards {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .corner-card {
            position: absolute;
            width: 80px;
            height: 100px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid #475569;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            pointer-events: auto;
            cursor: pointer;
        }

        .corner-card:hover {
            transform: scale(1.05);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .card-icon {
            font-size: 24px;
            margin-bottom: 4px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .card-title {
            font-size: 10px;
            font-weight: bold;
            color: #e2e8f0;
            text-align: center;
            margin-bottom: 6px;
            line-height: 1.2;
        }

        .card-counter {
            display: flex;
            gap: 4px;
            font-size: 8px;
            color: #94a3b8;
        }

        .deck-count {
            background: #059669;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }

        .discard-count {
            background: #dc2626;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Позиционирование карточек по углам - смещены внутрь на 10% */
        .big-deal-card {
            top: 15%;
            left: 15%;
            transform: translate(-50%, -50%) translate(8px, 8px);
        }

        .small-deal-card {
            top: 15%;
            right: 15%;
            transform: translate(50%, -50%) translate(-8px, 8px);
        }

        .market-card {
            bottom: 15%;
            left: 15%;
            transform: translate(-50%, 50%) translate(8px, -8px);
        }

        .expenses-card {
            bottom: 15%;
            right: 15%;
            transform: translate(50%, 50%) translate(-8px, -8px);
        }
        /* Фишки игроков */
        .player-token {
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 800;
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.9);
            z-index: 15;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }

        .player-token:hover {
            transform: scale(1.3) translateY(-3px);
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.4),
                0 0 30px rgba(255, 255, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .player-1 { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
            box-shadow: 
                0 4px 12px rgba(239, 68, 68, 0.4),
                0 0 20px rgba(239, 68, 68, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .player-2 { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.4),
                0 0 20px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .player-3 { 
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            box-shadow: 
                0 4px 12px rgba(16, 185, 129, 0.4),
                0 0 20px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Боковая панель */
        .sidebar {
            width: 320px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            box-shadow: 
                -10px 0 30px rgba(0, 0, 0, 0.3),
                inset 1px 0 0 rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            max-height: 100vh;
        }

        /* Стилизация скроллбара */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.5);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.7);
        }

        .section {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .section:hover {
            background: rgba(30, 41, 59, 0.8);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .assets-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 15px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .assets-button:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 50%, #065f46 100%);
            transform: translateY(-3px);
            box-shadow: 
                0 8px 25px rgba(16, 185, 129, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .roll-dice-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 18px;
            box-shadow: 
                0 6px 20px rgba(16, 185, 129, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .roll-dice-button:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 50%, #065f46 100%);
            transform: translateY(-4px);
            box-shadow: 
                0 12px 30px rgba(16, 185, 129, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .roll-dice-button:disabled {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 50%, #374151 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .turn-timer {
            margin-bottom: 15px;
        }

        .timer-bar {
            width: 100%;
            height: 8px;
            background: #374151;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        .timer-fill {
            height: 100%;
            background: #10b981;
            transition: width 1s linear, background-color 0.3s ease;
        }

        .timer-fill.warning {
            background: #f59e0b;
        }

        .timer-fill.danger {
            background: #ef4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .timer-text {
            font-size: 12px;
            color: #94a3b8;
            text-align: center;
        }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #374151;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .player-item:hover {
            background: #4b5563;
        }

        .player-item.current {
            background: #1e40af;
        }

        .player-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .player-role {
            font-size: 10px;
            color: #94a3b8;
        }

        .player-status {
            font-size: 10px;
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-your-turn {
            color: #3b82f6;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .status-waiting-turn {
            color: #6b7280;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .current-player {
            margin-top: 15px;
        }

        .current-player-title {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .current-player-info {
            padding: 10px;
            background: #374151;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            color: #e5e7eb;
        }

        /* Bank preview (external card) */
        .bank-preview {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            cursor: pointer;
        }
        .bank-preview:hover { background: rgba(30,41,59,0.75); }
        .bank-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .bank-title { display: flex; align-items: center; gap: 8px; color: #e2e8f0; font-weight: 700; }
        .bank-icon { width: 24px; height: 24px; background: linear-gradient(135deg,#10b981,#059669); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .bank-status { background: rgba(16,185,129,.2); color:#10b981; padding:4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; }
        .bank-balance { text-align:center; margin: 6px 0 8px; }
        .bank-balance .balance-amount { font-size: 32px; font-weight: 800; color:#10b981; line-height: 1; }
        .bank-balance .balance-label { color:#94a3b8; font-size:12px; }
        .bank-card { background: rgba(0,0,0,.2); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; }
        .bank-stats { display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
        .bank-stat { display:flex; align-items:center; justify-content:space-between; font-size:14px; }
        .bank-stat .label { color:#94a3b8; display:flex; align-items:center; gap:8px; }
        .bank-stat .value { font-weight:700; }
        .value.income { color:#10b981; }
        .value.expenses { color:#ef4444; }
        .value.payday { color:#f59e0b; }
        .credit-section { margin-top:12px; }
        .credit-row { display:flex; align-items:center; justify-content:space-between; font-size:14px; padding:4px 0; }
        .credit-row .label { color:#94a3b8; }
        .credit-row .value { font-weight:700; color:#94a3b8; }
        .credit-row .value.max { color:#8b5cf6; }
        .bank-actions { display:flex; gap:10px; margin-top:12px; }
        .bank-btn { flex:1; padding:10px 12px; border:none; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; }
        .bank-btn.secondary { background: rgba(16,185,129,.15); color:#10b981; border:1px solid rgba(16,185,129,.35); display:flex; align-items:center; justify-content:center; gap:8px; }
        .bank-btn.primary { background: linear-gradient(135deg,#ef4444,#dc2626); color:#fff; display:flex; align-items:center; justify-content:center; gap:8px; }

        .exit-game-button {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .exit-game-button:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .exit-game-button:active {
            transform: translateY(0);
        }

        /* Банковское модальное окно */
        .bank-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            justify-content: center;
            align-items: center;
            padding: 0;
            box-sizing: border-box;
        }
        .bank-modal-content {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: none;
            border-radius: 0;
            padding: 0;
            max-width: none;
            width: 100vw;
            max-height: none;
            height: 100vh;
            overflow: hidden;
            position: relative;
            box-shadow: none;
            animation: none;
        }

        /* Шапка банка */
        .bank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bank-header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .bank-logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .bank-icon {
            font-size: 32px;
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
        }

        .bank-title h2 {
            color: #f8fafc;
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            line-height: 1.2;
        }

        .bank-subtitle {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
        }

        .bank-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .bank-status span {
            color: #10b981;
            font-size: 14px;
            font-weight: 600;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #94a3b8;
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* Основной контент */
        .bank-content {
            display: flex;
            height: calc(100vh - 88px);
            overflow: hidden;
        }

        .bank-left-column {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.02);
        }

        .bank-right-column {
            flex: 1.2;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Карточки */
        .balance-card, .finances-card, .credit-card, .transfer-card, .history-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .balance-card:hover, .finances-card:hover, .credit-card:hover, .transfer-card:hover, .history-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-icon {
            font-size: 20px;
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.3));
        }

        .card-header h3 {
            color: #f8fafc;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        /* Карточка баланса */
        .balance-amount {
            font-size: 48px;
            font-weight: 800;
            color: #10b981;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .balance-label {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
        }

        /* Карточка финансов */
        .finances-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .finance-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .finance-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .finance-icon.income {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .finance-icon.expenses {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .finance-icon.payday {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .finance-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .finance-label {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
        }

        .finance-value {
            color: #f8fafc;
            font-size: 18px;
            font-weight: 700;
        }

        /* Карточка кредита */
        .credit-info {
            margin-bottom: 20px;
        }

        .credit-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .credit-row:last-child {
            border-bottom: none;
        }

        .credit-label {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
        }

        .credit-value {
            color: #f8fafc;
            font-size: 16px;
            font-weight: 600;
        }

        .credit-actions {
            display: flex;
            gap: 12px;
        }

        /* Форма переводов */
        .transfer-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 600;
        }

        .modern-select, .modern-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .modern-select:focus, .modern-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-with-icon {
            position: relative;
        }

        .input-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 16px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
        }

        .modern-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .modern-btn.primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .modern-btn.primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .modern-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modern-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .modern-btn.credit {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .modern-btn.credit:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }

        .btn-icon {
            font-size: 16px;
        }

        /* История операций */
        .history-count {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .transfers-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .no-transfers {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #64748b;
            text-align: center;
        }

        .no-transfers-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .no-transfers p {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
        }

        /* Стили для элементов истории переводов */
        .transfer-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .transfer-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .transfer-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .transfer-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .transfer-description {
            color: #f8fafc;
            font-size: 14px;
            font-weight: 600;
        }

        .transfer-direction {
            color: #94a3b8;
            font-size: 12px;
            font-weight: 500;
        }

        .transfer-date {
            color: #64748b;
            font-size: 11px;
            font-weight: 400;
        }

        .transfer-amount {
            font-size: 16px;
            font-weight: 700;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .transfer-amount.positive {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .transfer-amount.negative {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .transfer-status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .transfer-status.completed {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        /* Стили для карточки игрока */
        .player-profile-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .player-profile-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        .player-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            border-bottom: 1px solid #e5e7eb;
        }

        .player-profile-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .player-profile-icon {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 12px;
            color: white;
        }

        .player-profile-title h2 {
            color: #1f2937;
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            line-height: 1.2;
        }

        .player-profile-title span {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        .player-profile-body {
            padding: 32px;
        }

        .player-financial-summary {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
        }

        .financial-box {
            flex: 1;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .financial-box.salary {
            background: #dbeafe;
        }

        .financial-box.expenses {
            background: #fed7aa;
        }
        .financial-box.cashflow {
            background: #dcfce7;
            flex: 2;
        }

        .financial-amount {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .financial-box.salary .financial-amount {
            color: #10b981;
        }

        .financial-box.expenses .financial-amount {
            color: #f59e0b;
        }

        .financial-box.cashflow .financial-amount {
            color: #10b981;
        }

        .financial-label {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        .player-expenses-details {
            margin-bottom: 24px;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .expense-item:last-child {
            border-bottom: none;
        }
        
        .expense-label {
            color: #374151;
            font-size: 14px;
            font-weight: 500;
            min-width: 140px;
        }
        
        .expense-amounts {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        
        .expense-amount {
            color: #ef4444;
            font-size: 14px;
            font-weight: 600;
        }
        
        .expense-principal {
            color: #6b7280;
            font-size: 12px;
        }
        
        .payoff-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 70px;
        }
        
        .payoff-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .payoff-btn:active {
            transform: translateY(0);
        }
        
        .payoff-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
            margin-left: 8px;
        }
        
        /* Анимации для банковского модуля */
        .balance-updated {
            animation: balanceUpdate 0.5s ease-in-out;
        }
        
        @keyframes balanceUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); color: #10b981; }
            100% { transform: scale(1); }
        }
        
        .modal-show {
            animation: modalShow 0.3s ease-out;
        }
        
        /* Generic Modal (overlay) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            animation: modalShow 0.25s ease-out;
        }
        .modal .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            margin: 10% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 560px;
            color: #e5e7eb;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        /* Deal quantity modern controls */
        .qty-row { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 14px; }
        .qty-label { font-size: 13px; color: #a0aec0; }
        .qty-control { display: grid; grid-template-columns: 140px 1fr; gap: 12px; align-items: center; }
        .qty-number { display: grid; grid-template-columns: 36px 1fr 36px; align-items: center; background: #1f2937; border: 1px solid #374151; border-radius: 10px; height: 40px; }
        .qty-number button { background: transparent; border: none; color: #e5e7eb; font-size: 18px; height: 100%; cursor: pointer; transition: background .15s ease; }
        .qty-number button:hover { background: #111827; }
        .qty-number input[type="number"] { width: 100%; height: 100%; background: transparent; border: none; color: #e5e7eb; text-align: center; font-size: 15px; appearance: textfield; -webkit-appearance: textfield; outline: none; }
        .qty-number input[type=number]::-webkit-outer-spin-button,
        .qty-number input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .qty-slider { position: relative; height: 40px; display: flex; align-items: center; }
        .qty-slider input[type=range] { -webkit-appearance: none; width: 100%; height: 4px; background: linear-gradient(90deg,#22c55e 0%, #16a34a 100%); border-radius: 999px; outline: none; }
        .qty-slider input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: #10b981; border: 2px solid #0ea5a4; border-radius: 50%; cursor: pointer; box-shadow: 0 0 0 4px rgba(16,185,129,0.25); transition: transform .12s ease; }
        .qty-slider input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.05); }
        .qty-bubble { position: absolute; top: -26px; transform: translateX(-50%); background: #111827; color: #e5e7eb; border: 1px solid #374151; padding: 2px 8px; border-radius: 8px; font-size: 12px; white-space: nowrap; }
        .qty-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; font-size: 13px; color: #94a3b8; }
        .total-cost { font-weight: 700; color: #fbbf24; }
        /* Color badge for cell popup */
        .color-badge {
            display: inline-block;
            width: 34px;
            height: 14px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: inset 0 0 6px rgba(0,0,0,0.2);
            vertical-align: middle;
        }
        
        /* Cell Popup Modal Styles */
        .cell-popup-modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            animation: modalShow 0.3s ease-out;
        }

        .cell-popup-content {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            margin: 10% auto;
            padding: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        .cell-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-radius: 20px 20px 0 0;
        }

        .cell-popup-header h3 {
            margin: 0;
            color: #fff;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .cell-popup-close {
            color: #94a3b8;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .cell-popup-close:hover {
            color: #fff;
        }

        .cell-popup-body {
            padding: 30px;
        }

        .cell-popup-info {
            margin-bottom: 30px;
        }
        .cell-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .cell-info-row:last-child {
            border-bottom: none;
        }

        .cell-label {
            color: #94a3b8;
            font-weight: 600;
            font-size: 14px;
        }
        .cell-value {
            color: #fff;
            font-weight: 500;
            font-size: 14px;
            text-align: right;
        }
        .cell-popup-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .cell-btn-primary, .cell-btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cell-btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .cell-btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-2px);
        }

        .cell-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .cell-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        /* Deal Choice Modal Styles */
        .deal-choice-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }

        .deal-option {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            flex: 1;
            max-width: 300px;
        }

        .deal-option:hover {
            border-color: #3b82f6;
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .deal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .deal-option h3 {
            color: #fff;
            margin: 0 0 8px 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .deal-option p {
            color: #94a3b8;
            margin: 0 0 16px 0;
            font-size: 14px;
        }

        .deal-count {
            color: #3b82f6;
            font-size: 12px;
            font-weight: 600;
        }

        /* Card Modal Styles */
        .card-info {
            margin-bottom: 30px;
        }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-info-row:last-child {
            border-bottom: none;
        }

        .card-label {
            color: #94a3b8;
            font-weight: 600;
            font-size: 14px;
        }

        .card-value {
            color: #fff;
            font-weight: 500;
            font-size: 14px;
            text-align: right;
        }

        .card-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        /* Credit Modal Styles */
        .credit-modal {
            max-width: 500px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .credit-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .info-item:last-child {
            margin-bottom: 0;
        }
        
        .info-item .label {
            color: #cbd5e1;
            font-weight: 500;
        }
        
        .info-item .value {
            color: #10b981;
            font-weight: 600;
            font-size: 18px;
        }
        
        .credit-form {
            margin-bottom: 20px;
        }
        
        .amount-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .amount-input input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 16px;
            text-align: center;
        }
        
        .amount-input input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .amount-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .amount-buttons button {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .amount-buttons button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #3b82f6;
        }
        
        .credit-preview {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .preview-item:last-child {
            margin-bottom: 0;
        }
        
        .preview-item span:first-child {
            color: #cbd5e1;
        }
        
        .preview-item span:last-child {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .credit-actions {
            display: flex;
            gap: 12px;
        }
        
        .credit-actions .modern-btn {
            flex: 1;
        }
        
        @keyframes modalShow {
            0% { 
                opacity: 0; 
                transform: scale(0.9) translateY(-20px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }
        
        /* Стили для истории переводов */
        .transfer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s ease;
        }
        
        .transfer-item:hover {
            background-color: #f9fafb;
        }
        
        .transfer-item:last-child {
            border-bottom: none;
        }
        
        .transfer-info {
            flex: 1;
        }
        
        .transfer-participants {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .transfer-arrow {
            color: #6b7280;
            font-size: 14px;
        }
        
        .transfer-description {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 2px;
        }
        
        .transfer-time {
            font-size: 11px;
            color: #9ca3af;
        }
        
        .transfer-amount {
            font-weight: 600;
            font-size: 16px;
        }
        
        .transfer-amount.income {
            color: #10b981;
        }
        
        .transfer-amount.outgoing {
            color: #ef4444;
        }
        
        .no-transfers {
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
            font-style: italic;
        }
        
        /* Индикатор загрузки */
        #loadingIndicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
            align-items: center;
            gap: 12px;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff40;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .player-total-credits {
            margin-bottom: 32px;
        }

        .total-credits-line {
            height: 2px;
            background: #e5e7eb;
            margin-bottom: 16px;
        }

        .total-credits-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-credits-label {
            color: #1f2937;
            font-size: 16px;
            font-weight: 700;
        }

        .total-credits-amount {
            color: #1f2937;
            font-size: 16px;
            font-weight: 700;
        }

        .player-profile-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .profile-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .profile-btn.business {
            background: #f59e0b;
            color: white;
        }

        .profile-btn.business:hover {
            background: #d97706;
        }

        .profile-btn.complex {
            background: #ef4444;
            color: white;
        }

        .profile-btn.complex:hover {
            background: #dc2626;
        }

        /* Стили для модального окна кредитов */
        .credit-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .credit-modal-content {
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        .credit-info {
            margin-bottom: 30px;
        }

        .credit-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            display: block;
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .stat-value {
            display: block;
            font-size: 24px;
            font-weight: bold;
            color: #10b981;
        }

        .credit-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .credit-section {
            background: rgba(255, 255, 255, 0.03);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .credit-section h4 {
            color: #f1f5f9;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .credit-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .credit-info-text {
            background: rgba(16, 185, 129, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }

        .credit-info-text p {
            margin: 5px 0;
            font-size: 14px;
            color: #94a3b8;
        }

        .take-credit-btn, .repay-credit-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .take-credit-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .repay-credit-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .take-credit-btn:hover, .repay-credit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .take-credit-btn:active, .repay-credit-btn:active {
            transform: translateY(0);
        }

        /* Стили для владения клетками */
        .owned-by-player-0 {
            border: 3px solid #3b82f6 !important; /* Синий для игрока 1 */
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .owned-by-player-1 {
            border: 3px solid #10b981 !important; /* Зеленый для игрока 2 */
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .owned-by-player-2 {
            border: 3px solid #f59e0b !important; /* Оранжевый для игрока 3 */
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .owned-by-player-3 {
            border: 3px solid #ef4444 !important; /* Красный для игрока 4 */
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .owned-by-player-4 {
            border: 3px solid #8b5cf6 !important; /* Фиолетовый для игрока 5 */
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        .owned-by-player-6 {
            border: 3px solid #06b6d4 !important; /* Голубой для игрока 7 */
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }

        .owned-by-player-7 {
            border: 3px solid #84cc16 !important; /* Лаймовый для игрока 8 */
            box-shadow: 0 0 10px rgba(132, 204, 22, 0.5);
        }
        .transfer-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #10b981;
        }

        .transfer-icon {
            font-size: 20px;
        }

        .transfer-details {
            flex: 1;
        }

        .transfer-description {
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .transfer-direction {
            color: #94a3b8;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .transfer-date {
            color: #94a3b8;
            font-size: 12px;
        }

        .transfer-amount {
            font-weight: bold;
            font-size: 16px;
            margin-right: 10px;
        }

        .transfer-amount.positive {
            color: #10b981;
        }

        .transfer-amount.negative {
            color: #ef4444;
        }

        .transfer-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .transfer-status.completed {
            background: #10b981;
            color: white;
        }

        .no-transfers {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
            padding: 40px 20px;
        }

        .bank-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Анимация кубика под кнопкой */
        .dice-animation-container {
            display: flex;
            justify-content: center;
            margin-top: 12px;
            padding: 8px;
        }

        .mini-dice {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #000;
            box-shadow: 
                0 4px 12px rgba(255, 215, 0, 0.4),
                0 0 0 2px rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
            animation: miniDiceIdle 2s ease-in-out infinite;
        }

        .mini-dice.rolling {
            animation: miniDiceRoll 0.1s infinite;
        }

        @keyframes miniDiceIdle {
            0%, 100% { 
                transform: rotate(0deg) scale(1);
                box-shadow: 
                    0 4px 12px rgba(255, 215, 0, 0.4),
                    0 0 0 2px rgba(255, 215, 0, 0.2);
            }
            50% { 
                transform: rotate(5deg) scale(1.05);
                box-shadow: 
                    0 6px 16px rgba(255, 215, 0, 0.6),
                    0 0 0 3px rgba(255, 215, 0, 0.3);
            }
        }

        @keyframes miniDiceRoll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(0.9); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        /* Цвета квадратов */
        .square-green { background: #10b981; color: white; }
        .square-pink { background: #ec4899; color: white; }
        .square-yellow { background: #fbbf24; color: #1f2937; }
        .square-red { background: #ef4444; color: white; }
        .square-blue { background: #3b82f6; color: white; }
        .square-orange { background: #f97316; color: white; }
        .square-charity { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: white; box-shadow: 0 0 10px rgba(255, 107, 107, 0.3); }
        .square-light-blue { background: #06b6d4; color: white; }
        .square-black { background: #1f2937; color: white; }
        .square-purple { background: #8b5cf6; color: white; }
        .square-cyan { background: #06b6d4; color: white; }
        .square-gold { background: #f59e0b; color: white; }

        /* Анимации */
        @keyframes rollDice {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
            100% { transform: rotate(360deg); }
        }

        .dice.rolling {
            animation: rollDice 0.5s ease-in-out;
        }

        @keyframes moveToken {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .player-token.moving {
            animation: moveToken 0.5s ease-in-out;
        }

        /* Кнопка перехода на скоростную дорогу */
        .fast-track-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.35);
            display: none;
            z-index: 30;
        }
        .fast-track-btn:hover { filter: brightness(1.05); }

        .btn-primary, .btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Стили для модала кубика */
        .dice-container {
            text-align: center;
            margin: 20px 0;
        }

        .dice-result {
            font-size: 48px;
            font-weight: bold;
            color: #10b981;
            margin: 20px 0;
            padding: 20px;
            border: 3px solid #10b981;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
        }

        .dice-info {
            background: rgba(16, 185, 129, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .dice-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Стили для модала бесплатных карточек */
        .free-cards-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .free-card-section {
            flex: 1;
            background: rgba(16, 185, 129, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .free-card-section h3 {
            margin-bottom: 15px;
            color: #10b981;
        }

        .free-cards-actions {
            text-align: center;
            margin-top: 20px;
        }

        /* Стили для модала активов */
        .assets-info {
            background: rgba(16, 185, 129, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .assets-info p {
            margin: 5px 0;
            font-weight: 500;
        }

        .assets-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .asset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .asset-item.sellable {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .asset-item.not-sellable {
            background: rgba(107, 114, 128, 0.1);
            border-color: rgba(107, 114, 128, 0.3);
            opacity: 0.7;
        }

        .asset-info h4 {
            margin: 0 0 5px 0;
            color: #10b981;
        }

        .asset-info p {
            margin: 2px 0;
            font-size: 14px;
            color: #e2e8f0;
        }

        .asset-type {
            font-style: italic;
            color: #94a3b8 !important;
        }

        .dividend-badge {
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .sell-restriction {
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .asset-actions {
            margin-left: 15px;
        }

        .modern-btn.disabled {
            background: #6b7280;
            color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .modern-btn.disabled:hover {
            background: #6b7280;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Игровое поле -->
        <div class="game-board">
            <div class="board-wrapper">
                <!-- Внешний периметр -->
                <div class="outer-perimeter">
                    <div class="outer-squares" id="outerSquares"></div>
                </div>

                <!-- Внутренний трек -->
                <div class="inner-track">
                    <div class="inner-squares" id="innerSquares"></div>
                </div>

                <!-- Центральный логотип -->
                <div class="center-logo" onclick="rollDice()">
                    <div class="logo-inner">
                        <!-- Центральный результат броска кубика -->
                        <div class="dice" id="dice">$</div>
                        
                        <!-- Энергетические линии -->
                        <div class="energy-lines"></div>
                        
                        <!-- Дополнительные светящиеся точки -->
                        <div class="glow-dots">
                            <div class="glow-dot"></div>
                            <div class="glow-dot"></div>
                            <div class="glow-dot"></div>
                            <div class="glow-dot"></div>
                            <div class="glow-dot"></div>
                            <div class="glow-dot"></div>
                        </div>
                    </div>
                    
                    <!-- Внешние монеты -->
                    <div class="outer-coins">
                        <div class="coin"><span class="coin-symbol">$</span></div>
                        <div class="coin"><span class="coin-symbol">$</span></div>
                        <div class="coin"><span class="coin-symbol">$</span></div>
                        <div class="coin"><span class="coin-symbol">$</span></div>
                    </div>
                </div>

                <!-- Угловые карточки -->
                <div class="corner-cards">
                    <!-- Большая сделка -->
                    <div class="corner-card big-deal-card" id="bigDealCard">
                        <div class="card-icon">🏢</div>
                        <div class="card-title">Большая сделка</div>
                        <div class="card-counter">
                            <span class="deck-count" id="bigDealDeck">0</span>
                            <span class="discard-count" id="bigDealDiscard">0</span>
                        </div>
                    </div>

                    <!-- Малая сделка -->
                    <div class="corner-card small-deal-card" id="smallDealCard">
                        <div class="card-icon">🏠</div>
                        <div class="card-title">Малая сделка</div>
                        <div class="card-counter">
                            <span class="deck-count" id="smallDealDeck">0</span>
                            <span class="discard-count" id="smallDealDiscard">0</span>
                        </div>
                    </div>

                    <!-- Рынок -->
                    <div class="corner-card market-card" id="marketCard">
                        <div class="card-icon">📈</div>
                        <div class="card-title">Рынок</div>
                        <div class="card-counter">
                            <span class="deck-count" id="marketDeck">0</span>
                            <span class="discard-count" id="marketDiscard">0</span>
                        </div>
                    </div>

                    <!-- Расходы -->
                    <div class="corner-card expenses-card" id="expensesCard">
                        <div class="card-icon">💸</div>
                        <div class="card-title">Расходы</div>
                        <div class="card-counter">
                            <span class="deck-count" id="expensesDeck">0</span>
                            <span class="discard-count" id="expensesDiscard">0</span>
                        </div>
                    </div>
                </div>

                <!-- Фишки игроков -->
                <div class="player-token player-1" id="player1" style="top: 50%; left: 50%;">1</div>
                <div class="player-token player-2" id="player2" style="top: 50%; left: 50%;">2</div>
                <div class="player-token player-3" id="player3" style="top: 50%; left: 50%;">3</div>
                <button id="fastTrackBtn" class="fast-track-btn" onclick="switchToFastTrack()">Перейти на скоростную дорогу</button>
            </div>
        </div>

        <!-- Боковая панель -->
        <div class="sidebar">
            <!-- Bank v3 - External preview card -->
            <div class="bank-preview" onclick="openBankV3()">
                <div class="bank-header">
                    <div class="bank-title">
                        <div class="bank-icon">🏦</div>
                        <span>Банк</span>
                    </div>
                    <div class="bank-status">Активен</div>
                </div>
                
                <div class="bank-balance">
                    <div class="balance-amount" id="bankBalance">$0</div>
                    <div class="balance-label">Доступно для операций</div>
                </div>
                
                <div class="bank-card">
                <div class="bank-stats">
                    <div class="bank-stat">
                            <div class="label">📈 Доход:</div>
                            <div class="value income" id="totalIncome">$0</div>
                    </div>
                    <div class="bank-stat">
                            <div class="label">📉 Расходы:</div>
                            <div class="value expenses" id="totalExpenses">$0</div>
                        </div>
                    <div id="expensesDetails" style="display:none; margin: 6px 0 10px 0; padding: 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px;"><span>Базовые расходы</span><span id="expenseBase">$0</span></div>
                        <div style="display:flex; justify-content:space-between;"><span>Платежи по кредиту</span><span id="expenseCredit">$0</span></div>
                    </div>
                    <div class="bank-stat" style="cursor: pointer; display: flex; align-items: center; gap: 6px; margin-top: 8px;" onclick="toggleExpensesDetails()">
                        <div class="label" style="margin: 0;">Детали расходов</div>
                        <span id="expensesCaret">▾</span>
                    </div>
                    <div class="bank-stat">
                            <div class="label">💰 PAYDAY:</div>
                            <div class="value payday" id="monthlyIncome">$0/мес</div>
                        </div>
                    </div>
                    <div class="credit-section">
                        <div class="credit-row">
                            <div class="label">Кредит:</div>
                            <div class="value" id="currentCredit">$0</div>
                </div>
                        <div class="credit-row">
                            <div class="label">Макс. кредит:</div>
                            <div class="value max" id="maxCredit">$0</div>
                        </div>
                <div class="bank-actions">
                            <button class="bank-btn secondary" onclick="payoffCredit()">✅ Без кредитов</button>
                            <button type="button" class="bank-btn primary" onclick="openCreditModalV3()">🧾 Взять</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Активы -->
            <div class="section">
                <button class="assets-button">
                    <span>💰</span>
                    <span>Мои активы</span>
                </button>
            </div>

            <!-- 3. Очередность игроков -->
            <div class="section">
                <div class="section-title">Очередность игроков</div>
                <div class="players-list">
                    <div class="player-item current" id="player1Item">
                        <div class="player-avatar player-1">1</div>
                        <div class="player-info">
                            <div class="player-name">Игрок 1</div>
                            <div class="player-role">Врач</div>
                        </div>
                        <div class="player-status">
                            <span>✓</span>
                            <span>Готов</span>
                        </div>
                    </div>
                    <div class="player-item" id="player2Item">
                        <div class="player-avatar player-2">2</div>
                        <div class="player-info">
                            <div class="player-name">Игрок 2</div>
                            <div class="player-role">Инвестор</div>
                        </div>
                        <div class="player-status">
                            <span>✓</span>
                            <span>Готов</span>
                        </div>
                    </div>
                    <div class="player-item" id="player3Item">
                        <div class="player-avatar player-3">3</div>
                        <div class="player-info">
                            <div class="player-name">Игрок 3</div>
                            <div class="player-role">Финансист</div>
                        </div>
                        <div class="player-status">
                            <span>✓</span>
                            <span>Готов</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 4. Бросить кубик -->
            <div class="section">
                <button class="roll-dice-button" id="rollDiceBtn">
                    <span>🎲</span>
                    <span>Бросить кубик</span>
                </button>
            </div>

            <!-- 5. Шкала тайминга -->
            <div class="section">
                <div class="section-title">Время хода</div>
                <div class="turn-timer">
                    <div class="timer-bar">
                        <div class="timer-fill" id="timerFill" style="width: 100%;"></div>
                    </div>
                    <div class="timer-text" id="timerText">2:00 / 2:00</div>
                </div>
            </div>

            <!-- Текущий игрок -->
            <div class="section current-player">
                <div class="current-player-title">Имя</div>
                <div class="current-player-info" id="currentPlayerInfo">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <div class="player-avatar player-1" style="width: 20px; height: 20px; font-size: 10px;">1</div>
                        <div>
                            <div style="font-weight: bold;">Игрок 1</div>
                            <div style="font-size: 12px; color: #94a3b8;">Врач</div>
                        </div>
                    </div>
                    <div style="font-size: 14px; font-weight: bold; color: #10b981;">$10000</div>
                </div>
            </div>

            <!-- Выход из игры -->
            <div class="section">
                <button class="exit-game-button" onclick="exitGame()">
                    <span>🚪</span>
                    <span>Выход из игры</span>
                </button>
            </div>
        </div>
    </div>


    <!-- Удалён встроенный банк-модал; используется v2 из bank-module-v2/bank-modal.html -->

    <!-- Модальное окно карточки игрока -->
    <div class="player-profile-modal" id="playerProfileModal" onclick="closePlayerProfileModalOnBackdrop(event)">
        <div class="player-profile-content" onclick="event.stopPropagation()">
            <div class="player-profile-header">
                <div class="player-profile-left">
                    <div class="player-profile-icon">🚀</div>
                    <div class="player-profile-title">
                        <h2 id="playerProfessionName">Предприниматель</h2>
                        <span id="playerProfessionDesc">Владелец успешного бизнеса</span>
                    </div>
                </div>
                <button class="close-btn" onclick="closePlayerProfileModal()">
                    <span>&times;</span>
                </button>
            </div>

            <div class="player-profile-body">
                <!-- Финансовая сводка -->
                <div class="player-financial-summary">
                    <div class="financial-box salary">
                        <div class="financial-amount" id="playerSalary">$10,000</div>
                        <div class="financial-label">Зарплата</div>
                    </div>
                    <div class="financial-box expenses">
                        <div class="financial-amount" id="playerExpenses">$6,200</div>
                        <div class="financial-label">Расходы</div>
                    </div>
                    <div class="financial-box cashflow">
                        <div class="financial-amount" id="playerCashFlow">$3,800</div>
                        <div class="financial-label">Денежный поток</div>
                    </div>
                </div>

                   <!-- Детальные расходы и кредиты -->
                   <div class="player-expenses-details">
                       <div class="expense-item">
                           <span class="expense-label">Налоги:</span>
                           <span class="expense-amount" id="playerTaxes">$1,300 (13%)</span>
                       </div>
                       <div class="expense-item">
                           <span class="expense-label">Прочие расходы:</span>
                           <span class="expense-amount" id="playerOtherExpenses">$1,500</span>
                       </div>
                       <div class="expense-item">
                           <span class="expense-label">Кредит на авто:</span>
                           <div class="expense-amounts">
                               <span class="expense-amount" id="playerCarLoan">$700</span>
                               <span class="expense-principal" id="playerCarLoanPrincipal">$14,000 (тело)</span>
                           </div>
                           <button class="payoff-btn" onclick="payOffLoan('car')">Погасить</button>
                       </div>
                       <div class="expense-item">
                           <span class="expense-label">Образовательный кредит:</span>
                           <div class="expense-amounts">
                               <span class="expense-amount" id="playerEduLoan">$500</span>
                               <span class="expense-principal" id="playerEduLoanPrincipal">$10,000 (тело)</span>
                           </div>
                           <button class="payoff-btn" onclick="payOffLoan('edu')">Погасить</button>
                       </div>
                       <div class="expense-item">
                           <span class="expense-label">Ипотека:</span>
                           <div class="expense-amounts">
                               <span class="expense-amount" id="playerMortgage">$1,200</span>
                               <span class="expense-principal" id="playerMortgagePrincipal">$240,000 (тело)</span>
                           </div>
                           <button class="payoff-btn" onclick="payOffLoan('mortgage')">Погасить</button>
                       </div>
                       <div class="expense-item">
                           <span class="expense-label">Кредитные карты:</span>
                           <div class="expense-amounts">
                               <span class="expense-amount" id="playerCreditCards">$1,000</span>
                               <span class="expense-principal" id="playerCreditCardsPrincipal">$20,000 (тело)</span>
                           </div>
                           <button class="payoff-btn" onclick="payOffLoan('credit')">Погасить</button>
                       </div>
                   </div>

                <!-- Итого кредитов -->
                <div class="player-total-credits">
                    <div class="total-credits-line"></div>
                    <div class="total-credits-item">
                        <span class="total-credits-label">Итого тело кредитов</span>
                        <span class="total-credits-amount" id="playerTotalCredits">$284,000</span>
                    </div>
                </div>

                <!-- Кнопки действий -->
                <div class="player-profile-actions">
                    <button class="profile-btn business" onclick="openBusinessModal()">
                        Business
                    </button>
                    <button class="profile-btn complex" onclick="openComplexModal()">
                        Сложный
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно кредитов -->
    <div class="credit-modal" id="creditModal" onclick="closeCreditModalOnBackdrop(event)">
        <div class="modal-content credit-modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="header-left">
                    <span class="credit-icon">💳</span>
                    <h3>Кредитные операции</h3>
                </div>
                <span class="close" onclick="closeCreditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="credit-info">
                    <div class="credit-stats">
                        <div class="stat-item">
                            <span class="stat-label">Денежный поток:</span>
                            <span class="stat-value" id="cashFlowDisplay">$0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Текущий кредит:</span>
                            <span class="stat-value" id="currentCreditDisplay">$0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Максимальный кредит:</span>
                            <span class="stat-value" id="maxCreditDisplay">$0</span>
                        </div>
                    </div>
                </div>

                <div class="credit-actions">
                    <div class="credit-section">
                        <h4>Взять кредит</h4>
                        <div class="credit-form">
                            <div class="form-group">
                                <label>Сумма кредита (кратно 1000$)</label>
                                <input type="number" id="creditAmount" class="form-input" placeholder="0" min="1000" step="1000">
                                <span class="input-icon">💵</span>
                            </div>
                            <div class="credit-info-text">
                                <p>За каждые 1000$ кредита денежный поток снижается на 100$</p>
                                <p>Максимальная сумма: <span id="maxCreditAmount">$0</span></p>
                            </div>
                            <button class="take-credit-btn" onclick="requestCredit()">
                                <span class="btn-icon">📈</span>
                                Взять кредит
                            </button>
                        </div>
                    </div>

                    <div class="credit-section">
                        <h4>Погасить кредит</h4>
                        <div class="credit-form">
                            <div class="form-group">
                                <label>Сумма погашения</label>
                                <input type="number" id="repayAmount" class="form-input" placeholder="0" min="1000" step="1000">
                                <span class="input-icon">💰</span>
                            </div>
                            <div class="credit-info-text">
                                <p>При погашении кредита денежный поток увеличивается</p>
                                <p>Доступно для погашения: <span id="availableRepay">$0</span></p>
                            </div>
                            <button class="repay-credit-btn" onclick="repayCredit()">
                                <span class="btn-icon">📉</span>
                                Погасить кредит
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Индикатор загрузки -->
    <div id="loadingIndicator">
        <div class="loading-spinner"></div>
        <span>Загрузка...</span>
    </div>

    <script>
        // Система карточек сделок
        // Обновленная система карточек сделок (полный список из Energy money проекта)
const dealCards = {
    // Малые сделки (58 карточек)
    smallDeals: [
        // Tesla акции (5 карточек)
        { id: 15, name: "Tesla акции ($10)", cost: 10, income: 0, description: "Tesla акции (диапазон цены $10-$40) - стоимость: $10, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "TSLA" },
        { id: 16, name: "Tesla акции ($20)", cost: 20, income: 0, description: "Tesla акции (диапазон цены $10-$40) - стоимость: $20, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "TSLA" },
        { id: 17, name: "Tesla акции ($30)", cost: 30, income: 0, description: "Tesla акции (диапазон цены $10-$40) - стоимость: $30, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "TSLA" },
        { id: 18, name: "Tesla акции ($40)", cost: 40, income: 0, description: "Tesla акции (диапазон цены $10-$40) - стоимость: $40, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "TSLA" },
        { id: 19, name: "Tesla акции ($50)", cost: 50, income: 0, description: "Tesla акции (диапазон цены $10-$40) - стоимость: $50, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "TSLA" },
        
        // Microsoft акции (6 карточек)
        { id: 20, name: "Microsoft акции ($10)", cost: 10, income: 0, description: "Microsoft акции (диапазон цены $10-$40) - стоимость: $10, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "MSFT" },
        { id: 21, name: "Microsoft акции ($20)", cost: 20, income: 0, description: "Microsoft акции (диапазон цены $10-$40) - стоимость: $20, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "MSFT" },
        { id: 22, name: "Microsoft акции ($20)", cost: 20, income: 0, description: "Microsoft акции (диапазон цены $10-$40) - стоимость: $20, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "MSFT" },
        { id: 23, name: "Microsoft акции ($30)", cost: 30, income: 0, description: "Microsoft акции (диапазон цены $10-$40) - стоимость: $30, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "MSFT" },
        { id: 24, name: "Microsoft акции ($30)", cost: 30, income: 0, description: "Microsoft акции (диапазон цены $10-$40) - стоимость: $30, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "MSFT" },
        { id: 25, name: "Microsoft акции ($40)", cost: 40, income: 0, description: "Microsoft акции (диапазон цены $10-$40) - стоимость: $40, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "MSFT" },
        { id: 26, name: "Microsoft акции ($50)", cost: 50, income: 0, description: "Microsoft акции (диапазон цены $10-$40) - стоимость: $50, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "MSFT" },
        
        // Nvidia акции (7 карточек)
        { id: 27, name: "Nvidia акции ($10)", cost: 10, income: 0, description: "Nvidia акции (диапазон цены $10-$40) - стоимость: $10, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "NVDA" },
        { id: 28, name: "Nvidia акции ($20)", cost: 20, income: 0, description: "Nvidia акции (диапазон цены $10-$40) - стоимость: $20, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "NVDA" },
        { id: 29, name: "Nvidia акции ($20)", cost: 20, income: 0, description: "Nvidia акции (диапазон цены $10-$40) - стоимость: $20, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "NVDA" },
        { id: 30, name: "Nvidia акции ($30)", cost: 30, income: 0, description: "Nvidia акции (диапазон цены $10-$40) - стоимость: $30, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "NVDA" },
        { id: 31, name: "Nvidia акции ($30)", cost: 30, income: 0, description: "Nvidia акции (диапазон цены $10-$40) - стоимость: $30, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "NVDA" },
        { id: 32, name: "Nvidia акции ($40)", cost: 40, income: 0, description: "Nvidia акции (диапазон цены $10-$40) - стоимость: $40, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "NVDA" },
        { id: 33, name: "Nvidia акции ($50)", cost: 50, income: 0, description: "Nvidia акции (диапазон цены $10-$40) - стоимость: $50, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "NVDA" },
        
        // Apple акции (7 карточек)
        { id: 34, name: "Apple акции ($10)", cost: 10, income: 0, description: "Apple акции (диапазон цены $10-$40) - стоимость: $10, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "AAPL" },
        { id: 35, name: "Apple акции ($20)", cost: 20, income: 0, description: "Apple акции (диапазон цены $10-$40) - стоимость: $20, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "AAPL" },
        { id: 36, name: "Apple акции ($20)", cost: 20, income: 0, description: "Apple акции (диапазон цены $10-$40) - стоимость: $20, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "AAPL" },
        { id: 37, name: "Apple акции ($30)", cost: 30, income: 0, description: "Apple акции (диапазон цены $10-$40) - стоимость: $30, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "AAPL" },
        { id: 38, name: "Apple акции ($30)", cost: 30, income: 0, description: "Apple акции (диапазон цены $10-$40) - стоимость: $30, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "AAPL" },
        { id: 39, name: "Apple акции ($40)", cost: 40, income: 0, description: "Apple акции (диапазон цены $10-$40) - стоимость: $40, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "AAPL" },
        { id: 40, name: "Apple акции ($50)", cost: 50, income: 0, description: "Apple акции (диапазон цены $10-$40) - стоимость: $50, доход: нет. Максимум: 100000. Продажа только в свой ход.", type: "stocks", maxQuantity: 100000, isDividendStock: false, stockSymbol: "AAPL" },
        
        // BTC (биткоин - 8 карточек)
        { id: 41, name: "BTC ($1000)", cost: 1000, income: 100, description: "Биткоин высокорисковый актив с колебанием цен 1000-100 000$. Максимум: 1000. Продажа только в свой ход.", type: "crypto", maxQuantity: 1000, isDividendStock: false, cryptoSymbol: "BTC" },
        { id: 42, name: "BTC ($5000)", cost: 5000, income: 500, description: "Биткоин высокорисковый актив с колебанием цен 1000-100 000$. Максимум: 1000. Продажа только в свой ход.", type: "crypto", maxQuantity: 1000, isDividendStock: false, cryptoSymbol: "BTC" },
        { id: 43, name: "BTC ($10000)", cost: 10000, income: 1000, description: "Биткоин высокорисковый актив с колебанием цен 1000-100 000$. Максимум: 1000. Продажа только в свой ход.", type: "crypto", maxQuantity: 1000, isDividendStock: false, cryptoSymbol: "BTC" },
        { id: 44, name: "BTC ($20000)", cost: 20000, income: 2000, description: "Биткоин высокорисковый актив с колебанием цен 1000-100 000$. Максимум: 1000. Продажа только в свой ход.", type: "crypto", maxQuantity: 1000, isDividendStock: false, cryptoSymbol: "BTC" },
        { id: 45, name: "BTC ($1000)", cost: 1000, income: 100, description: "Биткоин высокорисковый актив с колебанием цен 1000-100 000$. Максимум: 1000. Продажа только в ход, когда карточка выходит.", type: "crypto", maxQuantity: 1000, isDividendStock: false, cryptoSymbol: "BTC" },
        { id: 46, name: "BTC ($5000)", cost: 5000, income: 500, description: "Биткоин высокорисковый актив с колебанием цен 1000-100 000$. Максимум: 1000. Продажа только в ход, когда карточка выходит.", type: "crypto", maxQuantity: 1000, isDividendStock: false, cryptoSymbol: "BTC" },
        { id: 47, name: "BTC ($10000)", cost: 10000, income: 1000, description: "Биткоин высокорисковый актив с колебанием цен 1000-100 000$. Максимум: 1000. Продажа только в ход, когда карточка выходит.", type: "crypto", maxQuantity: 1000, isDividendStock: false, cryptoSymbol: "BTC" },
        { id: 48, name: "BTC ($20000)", cost: 20000, income: 2000, description: "Биткоин высокорисковый актив с колебанием цен 1000-100 000$. Максимум: 1000. Продажа только в ход, когда карточка выходит.", type: "crypto", maxQuantity: 1000, isDividendStock: false, cryptoSymbol: "BTC" },
        { id: 49, name: "BTC ($50000)", cost: 50000, income: 5000, description: "Биткоин высокорисковый актив с колебанием цен 1000-100 000$. Максимум: 1000. Продажа только в ход, когда карточка выходит.", type: "crypto", maxQuantity: 1000, isDividendStock: false, cryptoSymbol: "BTC" },
        { id: 50, name: "BTC ($100000)", cost: 100000, income: 10000, description: "Биткоин высокорисковый актив с колебанием цен 1000-100 000$. Максимум: 1000. Продажа только в ход, когда карточка выходит.", type: "crypto", maxQuantity: 1000, isDividendStock: false, cryptoSymbol: "BTC" },
        
        // Дивидендные акции (4 карточки)
        { id: 51, name: "AT&T привилегированные акции (T)", cost: 5000, income: 30, description: "Привилегированные акции дают доход AT&T. Дивиденды: $30/мес. Продажа в любое время.", type: "dividend_stocks", maxQuantity: 1000, isDividendStock: true, dividendYield: 30, stockSymbol: "T" },
        { id: 52, name: "AT&T привилегированные акции (T)", cost: 5000, income: 30, description: "Привилегированные акции дают доход AT&T. Дивиденды: $30/мес. Продажа в любое время.", type: "dividend_stocks", maxQuantity: 1000, isDividendStock: true, dividendYield: 30, stockSymbol: "T" },
        { id: 53, name: "Procter & Gamble привилегированные акции (PG)", cost: 2000, income: 10, description: "Привилегированные акции дают доход Procter & Gamble. Дивиденды: $10/мес. Продажа в любое время.", type: "dividend_stocks", maxQuantity: 1000, isDividendStock: true, dividendYield: 10, stockSymbol: "PG" },
        { id: 54, name: "Procter & Gamble привилегированные акции (PG)", cost: 2000, income: 10, description: "Привилегированные акции дают доход Procter & Gamble. Дивиденды: $10/мес. Продажа в любое время.", type: "dividend_stocks", maxQuantity: 1000, isDividendStock: true, dividendYield: 10, stockSymbol: "PG" },
        
        // Недвижимость и бизнес (22 карточки)
        { id: 55, name: "Комната в пригороде", cost: 3000, income: 250, description: "Комната в пригороде для сдачи в аренду", type: "real_estate" },
        { id: 56, name: "Комната в пригороде", cost: 3000, income: 250, description: "Комната в пригороде для сдачи в аренду", type: "real_estate" },
        { id: 57, name: "Комната в пригороде", cost: 3000, income: 250, description: "Комната в пригороде для сдачи в аренду", type: "real_estate" },
        { id: 58, name: "Комната в пригороде", cost: 3000, income: 250, description: "Комната в пригороде для сдачи в аренду", type: "real_estate" },
        { id: 59, name: "Комната в пригороде", cost: 3000, income: 250, description: "Комната в пригороде для сдачи в аренду", type: "real_estate" },
        { id: 60, name: "Студия маникюра на 1 место", cost: 4900, income: 200, description: "Студия маникюра на 1 рабочее место", type: "beauty_salon" },
        { id: 61, name: "Студия маникюра на 1 место", cost: 4900, income: 200, description: "Студия маникюра на 1 рабочее место", type: "beauty_salon" },
        { id: 62, name: "Кофейня", cost: 4900, income: 100, description: "Небольшая кофейня", type: "coffee_shop" },
        { id: 63, name: "Кофейня", cost: 4900, income: 100, description: "Небольшая кофейня", type: "coffee_shop" },
        { id: 64, name: "Партнёрство в автомастерской", cost: 4500, income: 350, description: "Партнёрство в автомастерской", type: "partnership" },
        { id: 65, name: "Партнёрство в автомастерской", cost: 4500, income: 350, description: "Партнёрство в автомастерской", type: "partnership" },
        { id: 66, name: "Друг просит в займ", cost: 5000, income: 0, description: "Другу нужны деньги, он вам будет благодарен", type: "charity", isFriendMoneyCard: true, friendCardNumber: 1 },
        { id: 67, name: "Приют для кошек", cost: 5000, income: 0, description: "Пожертвование в приют для кошек", type: "charity" },
        { id: 68, name: "Накормить бездомных", cost: 5000, income: 0, description: "Благотворительность - накормить бездомных", type: "charity" },
        { id: 69, name: "Участок земли 20га", cost: 5000, income: 0, description: "Участок земли 20 га - инвестиция в недвижимость", type: "land" },
        { id: 70, name: "Крыша протекла", cost: 5000, income: 0, description: "Крыша протекла — возможность обновить крышу (если у игрока есть недвижимость)", type: "expense", isExpense: true },
        { id: 71, name: "Покупка дрона для съёмок", cost: 3000, income: 50, description: "Покупка дрона для съёмок - дополнительный доход", type: "equipment" },
        { id: 72, name: "Флипинг студии", cost: 5000, income: 50, description: "Флипинг студии - перепродажа недвижимости", type: "flipping" },
        { id: 73, name: "Прорыв канализации", cost: 2000, income: 0, description: "Прорыв канализации (у вас есть возможность починить канализацию)", type: "expense", isExpense: true },
        { id: 74, name: "Другу нужны деньги", cost: 5000, income: 0, description: "Другу нужны деньги, он вам будет благодарен", type: "charity", isFriendMoneyCard: true, friendCardNumber: 2 },
        { id: 75, name: "Другу нужны деньги", cost: 5000, income: 0, description: "Другу нужны деньги, он вам будет благодарен", type: "charity", isFriendMoneyCard: true, friendCardNumber: 3 },
        
        // Новые карточки "Другу нужны деньги" с разными эффектами
        { id: 76, name: "Другу нужны деньги", cost: 5000, income: 0, description: "Другу нужны деньги, он вам будет благодарен", type: "charity", isFriendMoneyCard: true, friendCardNumber: 4, effect: "nothing" },
        { id: 77, name: "Другу нужны деньги", cost: 5000, income: 0, description: "Другу нужны деньги, он вам будет благодарен. Друг вам настолько благодарен что передает свой ход", type: "charity", isFriendMoneyCard: true, friendCardNumber: 5, effect: "extra_turn" },
        { id: 78, name: "Другу нужны деньги", cost: 5000, income: 0, description: "Другу нужны деньги, он вам будет благодарен. Друг вам настолько благодарен что дарит одну карточку большой возможности и одну малой", type: "charity", isFriendMoneyCard: true, friendCardNumber: 6, effect: "free_cards" },
        
        // Франшиза Plazma Life water
        { id: 79, name: "Франшиза Plazma Life water", cost: 200, income: 0, description: "Молодая компания Plazma Life water с сильным продуктом быстро развивается, вы можете стать партнером и получать доход от партнеров (каждый партнер приносит 100$). Бросьте кубик и выберите количество партнеров", type: "franchise", isDiceCard: true, diceMultiplier: 100, franchiseName: "Plazma Life water" }
    ],
    // Большие сделки (24 карточки)
    bigDeals: [
        // Крупный бизнес (6 карточек)
        { id: 9, name: "Отель", cost: 100000, income: 8000, description: "Небольшой отель в центре города", type: "hotel" },
        { id: 10, name: "Торговый центр", cost: 200000, income: 20000, description: "Торговый центр", type: "mall" },
        { id: 11, name: "Завод", cost: 300000, income: 35000, description: "Производственное предприятие", type: "factory" },
        { id: 12, name: "Университет", cost: 500000, income: 60000, description: "Частный университет", type: "university" },
        { id: 13, name: "Больница", cost: 400000, income: 45000, description: "Частная клиника", type: "hospital" },
        { id: 14, name: "Аэропорт", cost: 1000000, income: 150000, description: "Региональный аэропорт", type: "airport" },
        
        // Дома в пригороде (10 карточек)
        { id: 70, name: "Дом в пригороде", cost: 7000, income: 100, description: "Небольшой дом в пригороде для сдачи в аренду", type: "house" },
        { id: 71, name: "Дом в пригороде", cost: 7500, income: 120, description: "Небольшой дом в пригороде для сдачи в аренду", type: "house" },
        { id: 72, name: "Дом в пригороде", cost: 8000, income: 140, description: "Небольшой дом в пригороде для сдачи в аренду", type: "house" },
        { id: 73, name: "Дом в пригороде", cost: 8500, income: 160, description: "Небольшой дом в пригороде для сдачи в аренду", type: "house" },
        { id: 74, name: "Дом в пригороде", cost: 9000, income: 180, description: "Небольшой дом в пригороде для сдачи в аренду", type: "house" },
        { id: 75, name: "Дом в пригороде", cost: 9500, income: 200, description: "Небольшой дом в пригороде для сдачи в аренду", type: "house" },
        { id: 76, name: "Дом в пригороде", cost: 10000, income: 220, description: "Небольшой дом в пригороде для сдачи в аренду", type: "house" },
        { id: 77, name: "Дом в пригороде", cost: 8000, income: 150, description: "Небольшой дом в пригороде для сдачи в аренду", type: "house" },
        { id: 78, name: "Дом в пригороде", cost: 8500, income: 170, description: "Небольшой дом в пригороде для сдачи в аренду", type: "house" },
        { id: 79, name: "Дом в пригороде", cost: 9000, income: 190, description: "Небольшой дом в пригороде для сдачи в аренду", type: "house" },
        
        // Средний бизнес (8 карточек)
        { id: 80, name: "Мини-отель", cost: 80000, income: 3000, description: "Бутик-отель на 10 номеров, стабильно приносит доход", type: "mini_hotel" },
        { id: 81, name: "Сеть кафе быстрого питания", cost: 200000, income: 7000, description: "Прибыльный бизнес, несколько точек в центре города", type: "fast_food" },
        { id: 82, name: "Ферма органических овощей", cost: 120000, income: 4500, description: "Экологичное хозяйство с контрактами на поставку", type: "farm" },
        { id: 83, name: "Сеть автомоек", cost: 150000, income: 5000, description: "Хорошее расположение, стабильный трафик клиентов", type: "car_wash_chain" },
        { id: 84, name: "Коворкинг-центр", cost: 250000, income: 8000, description: "Большое пространство для аренды под стартапы и фрилансеров", type: "coworking" },
        { id: 85, name: "Мини-отель", cost: 80000, income: 3000, description: "Бутик-отель на 10 номеров, стабильно приносит доход", type: "mini_hotel" },
        { id: 86, name: "Сеть кафе быстрого питания", cost: 200000, income: 7000, description: "Прибыльный бизнес, несколько точек в центре города", type: "fast_food" },
        { id: 87, name: "Франшиза \"Энергия денег\"", cost: 100000, income: 10000, description: "Франшиза на страну игры \"Энергия денег\" - прибыльный образовательный бизнес", type: "franchise" }
    ]
};
        // Карты рынка (24 карты)
        const marketCards = [
            { id: 1, name: "Старое жилье под снос", description: "Комната в пригороде: оффер $25,000", offer: 25000, profit: 22000, assetType: "real_estate" },
            { id: 2, name: "Покупатель квартиры‑студии", description: "Оффер $7,000", offer: 7000, profit: 5000, assetType: "real_estate" },
            { id: 3, name: "Покупатель земли", description: "Оффер $100,000", offer: 100000, profit: 50000, assetType: "land" },
            { id: 4, name: "Покупатель дома", description: "Оффер $200,000", offer: 200000, profit: 50000, assetType: "real_estate" },
            { id: 5, name: "Покупатель квартиры", description: "Оффер $120,000", offer: 120000, profit: 40000, assetType: "real_estate" },
            { id: 6, name: "Сеть выкупает салоны", description: "Салон красоты $100,000", offer: 100000, loss: 400000, assetType: "beauty_salon" },
            { id: 7, name: "Покупатель кофейни", description: "Оффер $25,000", offer: 25000, loss: 75000, assetType: "coffee_shop" },
            { id: 8, name: "Партнерство в любом бизнесе", description: "Дополнительный доход", bonus: 50000, type: "bonus" },
            { id: 9, name: "Покупатель спа‑центра", description: "Оффер $150,000", offer: 150000, loss: 120000, assetType: "spa" },
            { id: 10, name: "Покупатель мобильного приложения", description: "Оффер $200,000", offer: 200000, loss: 220000, assetType: "app" },
            { id: 11, name: "Покупатель агентства маркетинга", description: "Оффер $80,000", offer: 80000, loss: 80000, assetType: "marketing" },
            { id: 12, name: "Покупатель автомоек", description: "Оффер $80,000", offer: 80000, loss: 40000, assetType: "car_wash" },
            { id: 13, name: "Покупатель франшизы ресторана", description: "Оффер $180,000", offer: 180000, loss: 140000, assetType: "restaurant" },
            { id: 14, name: "Покупатель йога‑центра", description: "Оффер $100,000", offer: 100000, loss: 70000, assetType: "yoga" },
            { id: 15, name: "Покупатель мини‑отеля", description: "Оффер $300,000", offer: 300000, profit: 100000, assetType: "hotel" },
            { id: 16, name: "Покупатель эко‑ранчо", description: "Оффер $800,000", offer: 800000, loss: 200000, assetType: "ranch" },
            { id: 17, name: "Покупатель школы языков", description: "Оффер $50,000", offer: 50000, profit: 30000, assetType: "school" },
            { id: 18, name: "Покупатель киностудии", description: "Оффер $300,000", offer: 300000, loss: 200000, assetType: "studio" },
            { id: 19, name: "Покупатель пекарни", description: "Оффер $200,000", offer: 200000, loss: 100000, assetType: "bakery" },
            { id: 20, name: "Покупатель сети фитнес‑студий", description: "Оффер $400,000", offer: 400000, loss: 350000, assetType: "fitness" },
            { id: 21, name: "Покупатель коворкинга", description: "Оффер $300,000", offer: 300000, loss: 200000, assetType: "coworking" },
            { id: 22, name: "Очередной скам биржи", description: "Все теряют BTC", type: "crypto_crash", affects: "all" },
            { id: 23, name: "Покупатель акций", description: "Оффер $40,000", offer: 40000, profit: 15000, assetType: "stocks" },
            { id: 24, name: "Биржевой крах", description: "Все акции −50%", type: "stock_crash", affects: "all" }
        ];

        // Карты расходов (24 карты)
        const expenseCards = [
            { id: 1, name: "Новый смартфон", amount: 800, description: "Обязательная покупка" },
            { id: 2, name: "Ноутбук", amount: 1200, description: "Обязательная покупка" },
            { id: 3, name: "Планшет", amount: 500, description: "Обязательная покупка" },
            { id: 4, name: "Игровая приставка", amount: 400, description: "Обязательная покупка" },
            { id: 5, name: "Наушники", amount: 150, description: "Обязательная покупка" },
            { id: 6, name: "Ремонт автомобиля", amount: 800, description: "Обязательная покупка" },
            { id: 7, name: "Шиномонтаж", amount: 300, description: "Обязательная покупка" },
            { id: 8, name: "Такси", amount: 80, description: "Обязательная покупка" },
            { id: 9, name: "Заправка", amount: 60, description: "Обязательная покупка" },
            { id: 10, name: "Билет на самолет", amount: 400, description: "Обязательная покупка" },
            { id: 11, name: "Отель", amount: 200, description: "Обязательная покупка" },
            { id: 12, name: "Экскурсия", amount: 100, description: "Обязательная покупка" },
            { id: 13, name: "Ресторан", amount: 120, description: "Обязательная покупка" },
            { id: 14, name: "Пицца", amount: 50, description: "Обязательная покупка" },
            { id: 15, name: "Кофе", amount: 8, description: "Обязательная покупка" },
            { id: 16, name: "Продукты", amount: 150, description: "Обязательная покупка" },
            { id: 17, name: "Визит к врачу", amount: 100, description: "Обязательная покупка" },
            { id: 18, name: "Спа‑процедуры", amount: 200, description: "Обязательная покупка" },
            { id: 19, name: "Аптека", amount: 80, description: "Обязательная покупка" },
            { id: 20, name: "Фитнес‑клуб", amount: 100, description: "Обязательная покупка" },
            { id: 21, name: "Кино", amount: 25, description: "Обязательная покупка" },
            { id: 22, name: "Бар", amount: 60, description: "Обязательная покупка" },
            { id: 23, name: "Цветы", amount: 40, description: "Обязательная покупка" },
            { id: 24, name: "Печать документов", amount: 15, description: "Обязательная покупка" }
        ];

        // Система управления колодами
        let dealDecks = {
            smallDeals: [...dealCards.smallDeals],
            bigDeals: [...dealCards.bigDeals],
            smallDealsDiscard: [],
            bigDealsDiscard: []
        };

        // Колоды карт рынка и расходов
        let gameDecks = {
            market: [...marketCards],
            marketDiscard: [],
            expense: [...expenseCards],
            expenseDiscard: []
        };

        // Активы игроков
        let playerAssets = {
            0: [],
            1: [],
            2: []
        };
        
        // Пассивный доход игроков
        let playerPassiveIncome = {
            0: 0,
            1: 0,
            2: 0
        };

        // Текущая карточка в руке игрока
        let currentPlayerCard = null;

        // Данные о клетках малого круга (0-23) - согласно оригинальной игре "Поток денег"
        const innerCellData = {
            // Клетка 1 (0) - Зеленая возможность
            0: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 2 (1) - Трата
            1: { name: "Трата", type: "Трата", cost: 100, income: 0, description: "Обязательные траты от 100 до 4000$ на разные нужды", color: "pink", icon: "💸" },
            
            // Клетка 3 (2) - Зеленая возможность
            2: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 4 (3) - Оранжевая благотворительность
            3: { name: "Оранжевая благотворительность", type: "Благотворительность", cost: 0, income: 0, description: "Пожертвовать 10% от дохода для возможности бросать 2 кубика", color: "orange", icon: "❤️" },
            
            // Клетка 5 (4) - Зеленая возможность
            4: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 6 (5) - Желтая PayDay
            5: { name: "Желтая PayDay", type: "PayDay", cost: 0, income: 0, description: "Получить зарплату", color: "yellow", icon: "💰" },
            
            // Клетка 7 (6) - Зеленая возможность
            6: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 8 (7) - Рынок
            7: { name: "Рынок", type: "Рынок", cost: 0, income: 0, description: "Появляются покупатели на разные активы", color: "blue", icon: "🏪" },
            
            // Клетка 9 (8) - Зеленая возможность
            8: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 10 (9) - Трата
            9: { name: "Трата", type: "Трата", cost: 100, income: 0, description: "Обязательные траты от 100 до 4000$ на разные нужды", color: "pink", icon: "💸" },
            
            // Клетка 11 (10) - Зеленая возможность
            10: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 12 (11) - Фиолетовая ребенок
            11: { name: "Фиолетовая ребенок", type: "Ребенок", cost: 0, income: 0, description: "Родился ребенок, увеличиваются ежемесячные расходы", color: "purple", icon: "👶" },
            
            // Клетка 13 (12) - Зеленая возможность
            12: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 14 (13) - Желтая PayDay
            13: { name: "Желтая PayDay", type: "PayDay", cost: 0, income: 0, description: "Получить зарплату", color: "yellow", icon: "💰" },
            
            // Клетка 15 (14) - Зеленая возможность
            14: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 16 (15) - Рынок
            15: { name: "Рынок", type: "Рынок", cost: 0, income: 0, description: "Появляются покупатели на разные активы", color: "blue", icon: "🏪" },
            
            // Клетка 17 (16) - Зеленая возможность
            16: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 18 (17) - Трата
            17: { name: "Трата", type: "Трата", cost: 100, income: 0, description: "Обязательные траты от 100 до 4000$ на разные нужды", color: "pink", icon: "💸" },
            
            // Клетка 19 (18) - Зеленая возможность
            18: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 20 (19) - Черная потеря
            19: { name: "Черная потеря", type: "Потеря", cost: 0, income: 0, description: "Увольнение - оплатите расходы или пропустите ходы", color: "black", icon: "💸" },
            
            // Клетка 21 (20) - Зеленая возможность
            20: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 22 (21) - Желтая PayDay
            21: { name: "Желтая PayDay", type: "PayDay", cost: 0, income: 0, description: "Получить зарплату", color: "yellow", icon: "💰" },
            
            // Клетка 23 (22) - Зеленая возможность
            22: { name: "Зеленая возможность", type: "Возможность", cost: 0, income: 0, description: "Малая / большая сделка (на выбор)", color: "green", icon: "📈" },
            
            // Клетка 24 (23) - Рынок
            23: { name: "Рынок", type: "Рынок", cost: 0, income: 0, description: "Появляются покупатели на разные активы", color: "blue", icon: "🏪" }
        };
        // Данные о клетках внешнего круга (Fast Track) - 51 клетка
        const cellData = {
            // 🟡 ДЕНЬГИ (5 клеток) - СЕРЫЕ
            1: { name: "Вам выплачивается доход от ваших инвестиций", type: "Доход", cost: 0, income: "Все пассивные доходы", description: "Получение дохода от ранее приобретенных активов", color: "gray", icon: "💰" },
            14: { name: "Выплата дивиденды второго круга", type: "Доход", cost: 0, income: 0, description: "Выплата дивиденды второго круга", color: "gray", icon: "💰" },
            27: { name: "Выплата дивиденды второго круга", type: "Доход", cost: 0, income: 0, description: "Выплата дивиденды второго круга", color: "gray", icon: "💰" },
            40: { name: "Вам выплачивается доход от ваших инвестиций", type: "Доход", cost: 0, income: "Все пассивные доходы", description: "Получение дохода от ранее приобретенных активов", color: "gray", icon: "💰" },
            41: { name: "(пустая)", type: "Пустая", cost: 0, income: 0, description: "(пустая)", color: "gray", icon: "💰" },

            // 🟣 МЕЧТЫ (17 клеток) - СЕРЫЕ
            2: { name: "Построить дом мечты для семьи", type: "Мечта", cost: 100000, income: 0, description: "Реализация мечты о собственном доме для семьи", color: "gray", icon: "🏠" },
            6: { name: "Посетить Антарктиду", type: "Мечта", cost: 150000, income: 0, description: "Экстремальное путешествие на самый южный континент", color: "gray", icon: "✈️" },
            12: { name: "Подняться на все высочайшие вершины мира", type: "Мечта", cost: 500000, income: 0, description: "Покорение семи высочайших вершин планеты (Seven Summits)", color: "gray", icon: "⛰️" },
            16: { name: "Жить год на яхте в Средиземном море", type: "Мечта", cost: 300000, income: 0, description: "Годовая жизнь на роскошной яхте в прекрасном климате", color: "gray", icon: "⛵" },
            18: { name: "Создать фонд поддержки талантов", type: "Мечта", cost: 300000, income: 0, description: "Основание благотворительного фонда для помощи одаренным людям", color: "gray", icon: "🎗️" },
            20: { name: "Организовать мировой фестиваль", type: "Мечта", cost: 200000, income: 0, description: "Проведение масштабного международного культурного события", color: "gray", icon: "🎪" },
            24: { name: "Туристический комплекс (эко-ранчо)", type: "Мечта", cost: 1000000, income: 0, description: "Создание экологического туристического комплекса", color: "gray", icon: "🏞️" },
            26: { name: "Биржа", type: "Мечта", cost: 50000, income: "500,000$ (5-6)", description: "Разово выплачивается 500 000$ если выпало 5 или 6 на кубике", color: "gray", icon: "📈" },
            28: { name: "NFT-платформа", type: "Мечта", cost: 400000, income: 0, description: "Создание платформы для торговли NFT", color: "gray", icon: "💎" },
            30: { name: "Полет на Марс", type: "Мечта", cost: 300000, income: 0, description: "Реализация мечты о космическом путешествии на Красную планету", color: "gray", icon: "🚀" },
            32: { name: "Создать школу будущего для детей", type: "Мечта", cost: 300000, income: 0, description: "Создание инновационной школы для детей", color: "gray", icon: "🏫" },
            35: { name: "Кругосветное плавание на паруснике", type: "Мечта", cost: 200000, income: 0, description: "Кругосветное путешествие на парусном судне", color: "gray", icon: "⛵" },
            37: { name: "Белоснежная Яхта", type: "Мечта", cost: 300000, income: 0, description: "Приобретение роскошной белоснежной яхты", color: "gray", icon: "⛵" },
            42: { name: "Белоснежная Яхта", type: "Мечта", cost: 300000, income: 0, description: "Приобретение роскошной белоснежной яхты", color: "gray", icon: "⛵" },
            44: { name: "Организовать благотворительный фонд", type: "Мечта", cost: 200000, income: 0, description: "Создание благотворительного фонда", color: "gray", icon: "🎗️" },
            46: { name: "Полёт в космос", type: "Мечта", cost: 250000, income: 0, description: "Реализация мечты о космическом путешествии", color: "gray", icon: "🚀" },
            48: { name: "Кругосветное путешествие", type: "Мечта", cost: 300000, income: 0, description: "Путешествие вокруг света для изучения разных стран", color: "gray", icon: "🌍" },

            // 🟢 БИЗНЕС (21 клетка) - СЕРЫЕ
            3: { name: "Кофейня в центре города", type: "Бизнес", cost: 100000, income: 3000, description: "Прибыльный бизнес в центре города с высоким трафиком", color: "gray", icon: "☕" },
            5: { name: "Центр здоровья и спа", type: "Бизнес", cost: 270000, income: 5000, description: "Премиальный центр здоровья и спа-услуг", color: "gray", icon: "🧘" },
            7: { name: "Мобильное приложение (подписка)", type: "Бизнес", cost: 420000, income: 10000, description: "Разработка и запуск мобильного приложения с подписочной моделью", color: "gray", icon: "📱" },
            9: { name: "Агентство цифрового маркетинга", type: "Бизнес", cost: 160000, income: 4000, description: "Современное агентство по продвижению в цифровой среде", color: "gray", icon: "📊" },
            11: { name: "Мини-отель/бутик-гостиница", type: "Бизнес", cost: 200000, income: 5000, description: "Создание небольшого, но престижного отеля", color: "gray", icon: "🏨" },
            13: { name: "Франшиза популярного ресторана", type: "Бизнес", cost: 320000, income: 8000, description: "Приобретение франшизы известной сети ресторанов", color: "gray", icon: "🍽️" },
            15: { name: "Йога- и медитационный центр", type: "Бизнес", cost: 170000, income: 4500, description: "Центр для духовного развития и физического здоровья", color: "gray", icon: "🧘" },
            17: { name: "Салон красоты/барбершоп", type: "Бизнес", cost: 500000, income: 15000, description: "Салон красоты для мужчин и женщин", color: "gray", icon: "💇" },
            19: { name: "Сеть автомоек самообслуживания", type: "Бизнес", cost: 120000, income: 3000, description: "Создание сети автоматических автомоек", color: "gray", icon: "🚿" },
            21: { name: "Построить ретрит-центр", type: "Бизнес", cost: 500000, income: 0, description: "Создание места для духовного развития и медитаций", color: "gray", icon: "🧘" },
            23: { name: "Сеть автомоек самообслуживания", type: "Бизнес", cost: 120000, income: 3500, description: "Создание сети автоматических автомоек", color: "gray", icon: "🚿" },
            25: { name: "Кругосветное плавание на паруснике", type: "Бизнес", cost: 300000, income: 0, description: "Кругосветное путешествие на парусном судне", color: "gray", icon: "⛵" },
            27: { name: "Купить частный самолёт", type: "Бизнес", cost: 1000000, income: 0, description: "Приобретение собственного воздушного судна для путешествий", color: "gray", icon: "✈️" },
            29: { name: "Стать мировым лидером мнений", type: "Бизнес", cost: 1000000, income: 0, description: "Достижение статуса влиятельного человека в своей области", color: "gray", icon: "👑" },
            31: { name: "Биржа", type: "Бизнес", cost: 50000, income: "500,000$ (5-6)", description: "Разово выплачивается 500 000$ если выпало 5 или 6 на кубике", color: "gray", icon: "📈" },
            33: { name: "Снять полнометражный фильм", type: "Бизнес", cost: 500000, income: 0, description: "Создание художественного фильма для широкой аудитории", color: "gray", icon: "🎬" },
            38: { name: "Франшиза 'поток денег'", type: "Бизнес", cost: 100000, income: 10000, description: "Приобретение франшизы игры 'Поток денег'", color: "gray", icon: "🎮" },
            43: { name: "Пекарня с доставкой", type: "Бизнес", cost: 300000, income: 7000, description: "Создание пекарни с услугой доставки", color: "gray", icon: "🥖" },
            45: { name: "Онлайн-образовательная платформа", type: "Бизнес", cost: 200000, income: 5000, description: "Создание платформы для онлайн-образования", color: "gray", icon: "💻" },
            47: { name: "Сеть фитнес-студий", type: "Бизнес", cost: 750000, income: 20000, description: "Создание сети фитнес-студий", color: "gray", icon: "💪" },
            49: { name: "Коворкинг-пространство", type: "Бизнес", cost: 500000, income: 10000, description: "Создание современного рабочего пространства", color: "gray", icon: "🏢" },

            // 🔴 ПОТЕРИ (5 клеток) - СЕРЫЕ
            4: { name: "Аудит", type: "Потеря", cost: 0, income: 0, loss: "-50% активов", description: "Неожиданные расходы на аудит, которые могут повлиять на бизнес", color: "gray", icon: "⚠️" },
            10: { name: "Кража 100% наличных", type: "Потеря", cost: 0, income: 0, loss: "-100% наличных", description: "Полная потеря всех наличных средств", color: "gray", icon: "🦹" },
            22: { name: "Развод", type: "Потеря", cost: 0, income: 0, loss: "-50% активов", description: "Неожиданные расходы на развод, которые могут повлиять на финансы", color: "gray", icon: "💔" },
            34: { name: "Рейдерский захват", type: "Потеря", cost: 0, income: 0, loss: "-100% бизнеса", description: "Вы теряете бизнес с крупным доходом", color: "gray", icon: "⚔️" },
            39: { name: "Санкции заблокировали все счета", type: "Потеря", cost: 0, income: 0, loss: "-100% счетов", description: "Санкции приводят к блокировке всех банковских счетов", color: "gray", icon: "🚫" },

            // 🎗️ БЛАГОТВОРИТЕЛЬНОСТЬ (1 клетка) - СЕРАЯ
            8: { name: "Благотворительность", type: "Благотворительность", cost: 0, income: 0, description: "Возможность помочь нуждающимся и внести вклад в общество", color: "gray", icon: "🎗️" },

            // ДОПОЛНИТЕЛЬНЫЕ КЛЕТКИ - СЕРЫЕ
            50: { name: "Создать собственный остров", type: "Мечта", cost: 2000000, income: 0, description: "Приобретение частного острова для отдыха и инвестиций", color: "gray", icon: "🏝️" },
            51: { name: "Криптовалютная биржа", type: "Бизнес", cost: 800000, income: 25000, description: "Создание собственной криптовалютной торговой платформы", color: "gray", icon: "₿" }
        };

        // Игровые переменные
        let currentPlayer = 1;
        let gameTimer = 120; // 2 минуты в секундах
        let maxTimer = 120; // Максимальное время хода
        let timerInterval;
        let isRolling = false;
        let cellOwners = {}; // Владельцы клеток
        
        // Переменные для отслеживания продажи акций
        let currentTurnCards = {}; // Карточки, которые можно продавать в текущем ходу
        let currentTurn = 1; // Номер текущего хода
        let playerPositions = [1, 1, 1]; // Позиции игроков на поле
        let playerTracks = ['inner', 'inner', 'inner']; // 'inner' | 'outer' по игрокам
        let diceRolled = false; // Флаг броска кубика
        let turnTransitionTimeout; // Таймаут для перехода хода
        let warningSoundPlayed = false; // Флаг для предотвращения повторных сигналов
        // Настройки благотворительности: сколько кубиков может выбрать игрок в текущем треке
        // На внутреннем круге: 1 или 2 (после оплаты 10% дохода)
        // На внешнем круге: 1..3 (после оплаты $100,000)
        let fastTrackDiceChoice = {}; // playerIndex -> 1|2|3
        
        // Переменные для кредитов
        let currentBalance = 0; // Текущий баланс
        let totalCredit = 0; // Общая сумма кредита
        let creditPayment = 0; // Ежемесячный платеж по кредиту
        let monthlyIncome = 0; // Ежемесячный доход
        let monthlyExpenses = 0; // Ежемесячные расходы
        let expensesBreakdown = { base: 0, credit: 0 };
        const CHILD_MONTHLY_COST = 2000; // платеж по ребенку (мес)
        
        // Игровое поле
        let gameBoardUI = null;
        let gameBoardService = null;
        

        // Инициализация финансовых переменных (без перезаписи серверных значений)
        function initializeFinances() {
            // Не перетираем значения константами — ждём данные из банковского модуля
            currentBalance = currentBalance || 0;
            monthlyIncome = monthlyIncome || 0;
            monthlyExpenses = monthlyExpenses || 0;
            totalCredit = totalCredit || 0;
            creditPayment = creditPayment || 0;
            if (!expensesBreakdown) expensesBreakdown = { base: 0, credit: 0 };
            
            updateBalanceDisplay();
            updateFinancesDisplay();
            updateCreditDisplay();
        }

        // Добавить ежемесячный доход
        function addMonthlyIncome(amount, description) {
            monthlyIncome += amount;
            console.log(`📈 Добавлен ежемесячный доход: $${amount.toLocaleString()} - ${description}`);
            console.log(`📊 Общий ежемесячный доход: $${monthlyIncome.toLocaleString()}`);
            
            // Обновляем отображение
            updateFinancesDisplay();
            updateCreditDisplay();
        }

        // Bank v3 functions
        function openBankV3() {
            if (typeof window.openBankV3 === 'function') {
                window.openBankV3();
            } else {
                console.error('Bank v3 module not loaded');
            }
        }
        
        function closeBankModal() {
            const modal = document.getElementById('bankModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Инициализация игры
        async function initGame() {
            // Инициализируем игровое поле
            await initializeGameBoard();
            
            // Проверяем клетки малого круга
            validateInnerCells();
            
            // Сохраняем roomId в localStorage как резерв
            try {
                const roomIdForSave = getRoomIdFromURL();
                if (roomIdForSave) {
                    localStorage.setItem('lastRoomId', roomIdForSave);
                }
            } catch (e) {
                console.warn('Cannot persist lastRoomId:', e);
            }

            createOuterPerimeter();
            createInnerTrack();
            initializePlayerTokens(); // Инициализируем фишки игроков
            initializeCornerCards(); // Инициализируем угловые карточки
            
            // Инициализируем финансовые переменные (без жёстких значений)
            initializeFinances();
            
            // Bank v3 will auto-initialize when needed
            
            loadTurnInfo(); // Загружаем информацию о ходе
            startTimer();
            updateCurrentPlayer();
            
            // Bank v3 handles its own updates
            setInterval(loadTurnInfo, 1000); // Обновляем информацию о ходе каждую секунду
        }

        // Функции для работы с карточками сделок
        function shuffleDeck(deck) {
            const shuffled = [...deck];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        function drawCard(deckType) {
            const deck = dealDecks[deckType];
            if (deck.length === 0) {
                // Перемешиваем отбой и возвращаем в колоду
                const discardDeck = dealDecks[deckType + 'Discard'];
                dealDecks[deckType] = shuffleDeck(discardDeck);
                dealDecks[deckType + 'Discard'] = [];
                updateDeckCounters();
            }
            
            if (dealDecks[deckType].length === 0) {
                return null; // Нет карточек
            }
            
            // Получаем все карточки у игроков
            const allPlayerCards = [];
            for (let playerId in playerAssets) {
                allPlayerCards.push(...playerAssets[playerId]);
            }
            
            // Ищем карточку, которой нет у игроков
            let availableCard = null;
            for (let i = deck.length - 1; i >= 0; i--) {
                const card = deck[i];
                const isOwnedByPlayer = allPlayerCards.some(playerCard => 
                    playerCard.id === card.id && playerCard.name === card.name
                );
                
                if (!isOwnedByPlayer) {
                    availableCard = deck.splice(i, 1)[0];
                    break;
                }
            }
            
            // Если не нашли доступную карточку, берем любую
            if (!availableCard && deck.length > 0) {
                availableCard = deck.pop();
            }
            
            return availableCard;
        }

        function discardCard(card, deckType) {
            dealDecks[deckType + 'Discard'].push(card);
            updateDeckCounters();
        }

        function updateDeckCounters() {
            // Счетчики сделок
            document.getElementById('smallDealDeck').textContent = dealDecks.smallDeals.length;
            document.getElementById('smallDealDiscard').textContent = dealDecks.smallDealsDiscard.length;
            document.getElementById('bigDealDeck').textContent = dealDecks.bigDeals.length;
            document.getElementById('bigDealDiscard').textContent = dealDecks.bigDealsDiscard.length;
            
            // Счетчики рынка
            if (gameDecks && gameDecks.market) {
                document.getElementById('marketDeck').textContent = gameDecks.market.length;
                document.getElementById('marketDiscard').textContent = gameDecks.marketDiscard.length;
            }
            
            // Счетчики расходов
            if (gameDecks && gameDecks.expense) {
                document.getElementById('expensesDeck').textContent = gameDecks.expense.length;
                document.getElementById('expensesDiscard').textContent = gameDecks.expenseDiscard.length;
            }
        }

        // Функция для показа модального окна рынка
        function showMarketModal() {
            console.log('🏪 Показываем модальное окно рынка');
            
            // Берем случайную карточку из колоды рынка
            if (gameDecks.market.length === 0) {
                // Если колода пуста, перемешиваем отбой
                if (gameDecks.marketDiscard.length > 0) {
                    gameDecks.market = [...gameDecks.marketDiscard];
                    gameDecks.marketDiscard = [];
                    shuffleDeck(gameDecks.market);
                    console.log('🔄 Колода рынка перемешана из отбоя');
                } else {
                    // Если отбой тоже пуст, восстанавливаем из исходных карточек
                    gameDecks.market = [...marketCards];
                    shuffleDeck(gameDecks.market);
                    console.log('🔄 Колода рынка восстановлена из исходных карточек');
                }
            }
            
            const randomIndex = Math.floor(Math.random() * gameDecks.market.length);
            const marketCard = gameDecks.market[randomIndex];
            
            // Удаляем карточку из колоды
            gameDecks.market.splice(randomIndex, 1);
            
            // Показываем модальное окно с карточкой
            showMarketCardModal(marketCard);
        }
        
        // Функция для показа модального окна с карточкой рынка
        function showMarketCardModal(card) {
            console.log('📈 Показываем карточку рынка:', card);
            
            // Создаем модальное окно если его нет
            let modal = document.getElementById('marketCardModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'marketCardModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="marketCardTitle">Карточка рынка</h3>
                            <span class="close" onclick="closeMarketCardModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="card-info">
                                <div class="card-name" id="marketCardName">-</div>
                                <div class="card-description" id="marketCardDescription">-</div>
                                <div class="card-offer" id="marketCardOffer">-</div>
                                <div class="card-profit" id="marketCardProfit">-</div>
                            </div>
                            <div class="card-actions">
                                <button class="btn-primary" id="marketCardSellBtn" onclick="sellAssetFromMarket()">Продать актив</button>
                                <button class="btn-secondary" id="marketCardRefuseBtn" onclick="refuseMarketCard()">Отказаться</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Заполняем данными
            document.getElementById('marketCardName').textContent = card.name;
            document.getElementById('marketCardDescription').textContent = card.description;
            
            if (card.offer) {
                document.getElementById('marketCardOffer').textContent = `Предложение: $${card.offer.toLocaleString()}`;
            }
            
            if (card.profit) {
                document.getElementById('marketCardProfit').textContent = `Прибыль: $${card.profit.toLocaleString()}`;
            } else if (card.loss) {
                document.getElementById('marketCardProfit').textContent = `Убыток: $${card.loss.toLocaleString()}`;
            } else if (card.bonus) {
                document.getElementById('marketCardProfit').textContent = `Бонус: $${card.bonus.toLocaleString()}`;
            }
            
            // Сохраняем карточку для обработки
            window.currentMarketCard = card;
            
            // Показываем модальное окно
            modal.style.display = 'block';
        }
        
        // Функция для закрытия модального окна рынка
        function closeMarketCardModal() {
            const modal = document.getElementById('marketCardModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Функция для продажи актива через рынок
        function sellAssetFromMarket() {
            const card = window.currentMarketCard;
            if (!card) return;
            
            console.log('💰 Продаем актив через рынок:', card);
            
            // Здесь должна быть логика проверки наличия актива у игрока
            // и его продажи за указанную цену
            
            if (card.profit) {
                addBalance(card.offer, `Продажа актива: ${card.name}`);
                showNotification(`✅ Актив продан за $${card.offer.toLocaleString()} (прибыль: $${card.profit.toLocaleString()})`, 'success');
            } else if (card.loss) {
                addBalance(card.offer, `Продажа актива: ${card.name}`);
                showNotification(`⚠️ Актив продан за $${card.offer.toLocaleString()} (убыток: $${card.loss.toLocaleString()})`, 'warning');
            } else if (card.bonus) {
                addBalance(card.bonus, `Бонус: ${card.name}`);
                showNotification(`🎉 Получен бонус $${card.bonus.toLocaleString()}`, 'success');
            }
            
            // Отправляем карточку в отбой
            gameDecks.marketDiscard.push(card);
            updateDeckCounters();
            
            closeMarketCardModal();
        }
        // Функция для отказа от карточки рынка
        function refuseMarketCard() {
            const card = window.currentMarketCard;
            if (!card) return;
            
            console.log('❌ Отказываемся от карточки рынка:', card);
            
            // Отправляем карточку в отбой
            gameDecks.marketDiscard.push(card);
            updateDeckCounters();
            
            showNotification('❌ Отказались от предложения рынка', 'info');
            closeMarketCardModal();
        }
        
        // Функция для показа информации о картах
        function showCardInfo(cardType) {
            console.log(`📋 Показываем информацию о картах: ${cardType}`);
            
            let title = '';
            let description = '';
            let deckCount = 0;
            let discardCount = 0;
            
            if (cardType === 'market') {
                title = 'Карточки рынка';
                description = 'Покупатели на разные активы. Карточки выдаются случайно при попадании на клетку "Рынок".';
                deckCount = gameDecks.market ? gameDecks.market.length : 0;
                discardCount = gameDecks.marketDiscard ? gameDecks.marketDiscard.length : 0;
            } else if (cardType === 'expenses') {
                title = 'Карточки расходов';
                description = 'Обязательные траты. Карточки выдаются при попадании на клетки расходов.';
                deckCount = gameDecks.expense ? gameDecks.expense.length : 0;
                discardCount = gameDecks.expenseDiscard ? gameDecks.expenseDiscard.length : 0;
            }
            
            // Создаем модальное окно
            const modal = document.createElement('div');
            modal.id = 'cardInfoModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <span class="close" onclick="closeCardInfoModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p>${description}</p>
                        <div class="card-stats">
                            <div class="stat-item">
                                <span class="stat-label">В колоде:</span>
                                <span class="stat-value">${deckCount}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">В отбое:</span>
                                <span class="stat-value">${discardCount}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Добавляем стили для статистики
            const style = document.createElement('style');
            style.textContent = `
                .card-stats {
                    margin-top: 20px;
                    padding: 15px;
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 8px;
                }
                .stat-item {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 10px;
                }
                .stat-item:last-child {
                    margin-bottom: 0;
                }
                .stat-label {
                    color: #94a3b8;
                    font-weight: 600;
                }
                .stat-value {
                    color: #ffffff;
                    font-weight: bold;
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }
        
        // Функция для закрытия модального окна информации о картах
        function closeCardInfoModal() {
            const modal = document.getElementById('cardInfoModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Функция для показа модального окна расходов
        function showExpenseModal() {
            console.log('💸 Показываем модальное окно расходов');
            
            // Берем случайную карточку из колоды расходов
            if (gameDecks.expense.length === 0) {
                // Если колода пуста, перемешиваем отбой
                if (gameDecks.expenseDiscard.length > 0) {
                    gameDecks.expense = [...gameDecks.expenseDiscard];
                    gameDecks.expenseDiscard = [];
                    shuffleDeck(gameDecks.expense);
                    console.log('🔄 Колода расходов перемешана из отбоя');
                } else {
                    // Если отбой тоже пуст, восстанавливаем из исходных карточек
                    gameDecks.expense = [...expenseCards];
                    shuffleDeck(gameDecks.expense);
                    console.log('🔄 Колода расходов восстановлена из исходных карточек');
                }
            }
            
            const randomIndex = Math.floor(Math.random() * gameDecks.expense.length);
            const expenseCard = gameDecks.expense[randomIndex];
            
            // Удаляем карточку из колоды
            gameDecks.expense.splice(randomIndex, 1);
            
            // Показываем модальное окно с карточкой
            showExpenseCardModal(expenseCard);
        }
        
        // Функция для показа модального окна с карточкой расходов
        function showExpenseCardModal(card) {
            console.log('💸 Показываем карточку расходов:', card);
            
            // Создаем модальное окно если его нет
            let modal = document.getElementById('expenseCardModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'expenseCardModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="expenseCardTitle">Карточка расходов</h3>
                            <span class="close" onclick="closeExpenseCardModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="card-info">
                                <div class="card-name" id="expenseCardName">-</div>
                                <div class="card-description" id="expenseCardDescription">-</div>
                                <div class="card-amount" id="expenseCardAmount">-</div>
                            </div>
                            <div class="card-actions">
                                <button class="btn-primary" id="expenseCardPayBtn" onclick="payExpense()">Оплатить</button>
                                <button class="btn-secondary" id="expenseCardCreditBtn" onclick="takeCreditForExpense()">Взять кредит</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Заполняем данными
            document.getElementById('expenseCardName').textContent = card.name;
            document.getElementById('expenseCardDescription').textContent = card.description;
            document.getElementById('expenseCardAmount').textContent = `Сумма: $${card.amount.toLocaleString()}`;
            
            // Сохраняем карточку для обработки
            window.currentExpenseCard = card;
            
            // Показываем модальное окно
            modal.style.display = 'block';
        }
        
        // Функция для закрытия модального окна расходов
        function closeExpenseCardModal() {
            const modal = document.getElementById('expenseCardModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        // Функция для оплаты расходов
        function payExpense() {
            const card = window.currentExpenseCard;
            if (!card) return;
            
            console.log('💸 Оплачиваем расходы:', card);
            
            if ((currentBalance || 0) >= card.amount) {
                subtractBalance(card.amount, `Расходы: ${card.name}`);
                showNotification(`✅ Расходы оплачены: $${card.amount.toLocaleString()}`, 'success');
                
                // Отправляем карточку в отбой
                gameDecks.expenseDiscard.push(card);
                updateDeckCounters();
                
                closeExpenseCardModal();
            } else {
                alert(`Недостаточно средств: нужно $${card.amount.toLocaleString()}\nВаш баланс: $${(currentBalance || 0).toLocaleString()}`);
            }
        }
        
        // Функция для взятия кредита на расходы
        function takeCreditForExpense() {
            const card = window.currentExpenseCard;
            if (!card) return;
            
            console.log('💳 Берем кредит на расходы:', card);
            
            // Открываем модальное окно кредита
            openCreditModalV3();
            
            // Сохраняем информацию о расходах для последующей оплаты
            window.pendingExpense = card;
        }

        function showDealChoiceModal() {
            const modal = document.getElementById('dealChoiceModal');
            if (modal) {
                // Обновляем счетчики колод перед показом
                const smallCount = dealDecks.smallDeals.length + dealDecks.smallDealsDiscard.length;
                const bigCount = dealDecks.bigDeals.length + dealDecks.bigDealsDiscard.length;
                const smallCountEl = document.getElementById('smallDealCount');
                const bigCountEl = document.getElementById('bigDealCount');
                if (smallCountEl) smallCountEl.textContent = String(smallCount);
                if (bigCountEl) bigCountEl.textContent = String(bigCount);
                modal.style.display = 'block';
            }
        }

        function closeDealChoiceModal() {
            const modal = document.getElementById('dealChoiceModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function chooseSmallDeal() {
            const card = drawCard('smallDeals');
            if (card) {
                currentPlayerCard = { ...card, deckType: 'smallDeals' };
                showCardModal(card);
                closeDealChoiceModal();
            }
        }

        function chooseBigDeal() {
            const card = drawCard('bigDeals');
            if (card) {
                currentPlayerCard = { ...card, deckType: 'bigDeals' };
                showCardModal(card);
                closeDealChoiceModal();
            }
        }

        function showCardModal(card) {
            const modal = document.getElementById('cardModal');
            if (!modal) return;

            document.getElementById('cardTitle').textContent = card.name;
            document.getElementById('cardCost').textContent = `$${card.cost.toLocaleString()}`;
            document.getElementById('cardIncome').textContent = `$${card.income.toLocaleString()}/мес`;
            document.getElementById('cardDescription').textContent = card.description;

            // Добавляем UI выбора количества для акций/BTC
            const qtyHostId = 'cardQuantityHost';
            let qtyHost = document.getElementById(qtyHostId);
            if (!qtyHost) {
                const host = document.createElement('div');
                host.id = qtyHostId;
                host.style.marginTop = '12px';
                const info = modal.querySelector('.card-info');
                if (info) info.appendChild(host);
            }
            qtyHost = document.getElementById(qtyHostId);
            if (qtyHost) {
                if (card.type === 'stocks' || card.type === 'crypto') {
                    const maxQ = Math.max(1, card.maxQuantity || 100000);
                    qtyHost.innerHTML = `
                        <div class="card-info-row">
                            <span class="card-label">Количество:</span>
                            <span class="card-value" style="width:100%">
                                <div class="qty-row">
                                    <div class="qty-control">
                                        <div class="qty-number">
                                            <button id="dealQtyMinus" type="button">−</button>
                                            <input id="dealQtyInput" type="number" min="1" max="${maxQ}" value="1">
                                            <button id="dealQtyPlus" type="button">+</button>
                                        </div>
                                        <div class="qty-slider">
                                            <input id="dealQtyRange" type="range" min="1" max="${maxQ}" value="1">
                                            <span id="dealQtyBubble" class="qty-bubble">1</span>
                                        </div>
                                    </div>
                                    <div class="qty-footer">
                                        <span>Макс: ${maxQ.toLocaleString()}</span>
                                        <span class="total-cost" id="dealTotalCost">$${card.cost.toLocaleString()}</span>
                                    </div>
                                </div>
                            </span>
                        </div>`;
                    const qtyInput = document.getElementById('dealQtyInput');
                    const qtyRange = document.getElementById('dealQtyRange');
                    const qtyMinus = document.getElementById('dealQtyMinus');
                    const qtyPlus  = document.getElementById('dealQtyPlus');
                    const totalEl  = document.getElementById('dealTotalCost');
                    const bubble   = document.getElementById('dealQtyBubble');

                    const clamp = (v) => Math.min(maxQ, Math.max(1, v|0));
                    const setBubble = () => {
                        const range = qtyRange;
                        const val = (parseInt(range.value,10) - 1) / (maxQ - 1 || 1);
                        const percent = val * 100;
                        bubble.style.left = `calc(${percent}% )`;
                        bubble.textContent = range.value;
                    };
                    const updateTotal = () => {
                        const q = clamp(parseInt(qtyInput.value || '1', 10));
                        qtyInput.value = String(q);
                        qtyRange.value = String(q);
                        setBubble();
                        totalEl.textContent = `$${(card.cost * q).toLocaleString()}`;
                    };
                    qtyInput.oninput = updateTotal;
                    qtyRange.oninput = () => { qtyInput.value = qtyRange.value; updateTotal(); };
                    qtyMinus.onclick = () => { qtyInput.value = String(clamp((parseInt(qtyInput.value||'1',10) - 1))); updateTotal(); };
                    qtyPlus.onclick  = () => { qtyInput.value = String(clamp((parseInt(qtyInput.value||'1',10) + 1))); updateTotal(); };
                    updateTotal();
                } else {
                    qtyHost.innerHTML = '';
                }
            }

            // Показываем кнопки покупки/отказа
            const buyButton = document.getElementById('cardBuyButton');
            const refuseButton = document.getElementById('cardRefuseButton');
            
            if (buyButton) buyButton.style.display = 'inline-block';
            if (refuseButton) refuseButton.style.display = 'inline-block';

            // Кнопка кредита в модале сделки
            let creditBtn = document.getElementById('cardCreditButton');
            if (!creditBtn) {
                creditBtn = document.createElement('button');
                creditBtn.id = 'cardCreditButton';
                creditBtn.className = 'modern-btn secondary';
                creditBtn.style.marginLeft = '8px';
                creditBtn.textContent = 'Кредит';
                const actions = modal.querySelector('.card-actions');
                if (actions) actions.appendChild(creditBtn);
            }
            creditBtn.onclick = () => openCreditModalV3();

            // Кнопка передачи карты прямо из модала сделки (если она в активах)
            let transferBtn = document.getElementById('cardTransferButton');
            if (!transferBtn) {
                transferBtn = document.createElement('button');
                transferBtn.id = 'cardTransferButton';
                transferBtn.className = 'modern-btn secondary';
                transferBtn.style.marginLeft = '8px';
                transferBtn.textContent = 'Передать';
                const actions = modal.querySelector('.card-actions');
                if (actions) actions.appendChild(transferBtn);
            }
            transferBtn.onclick = () => {
                // Найти id карты в активах по имени и типу
                const owned = (playerAssets[currentPlayer]||[]).find(c => c.name === card.name && c.type === card.type);
                if (!owned) { showNotification('Эта карточка еще не у вас в активах', 'error'); return; }
                openTransferModal(owned.id);
            };

            // Обновляем баланс из BankModule, если доступен
            try {
                const bm = window.bankModule || window.BankModule || null;
                const state = bm?.core?.getState ? bm.core.getState() : (bm?.getState ? bm.getState() : null);
                if (state && typeof state.currentBalance === 'number') {
                    currentBalance = state.currentBalance;
                    updateBalanceDisplay();
                }
            } catch {}

            modal.style.display = 'block';
        }

        function closeCardModal() {
            const modal = document.getElementById('cardModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function buyCard() {
            if (!currentPlayerCard) return;

            // Количество для акций/крипты
            let quantity = 1;
            if (currentPlayerCard.type === 'stocks' || currentPlayerCard.type === 'crypto') {
                const input = document.getElementById('dealQtyInput');
                if (input) {
                    quantity = Math.max(1, parseInt(input.value || '1', 10));
                    const maxQ = Math.max(1, currentPlayerCard.maxQuantity || 100000);
                    if (quantity > maxQ) quantity = maxQ;
                }
            }

            // Актуализируем баланс перед покупкой из BankModule, если доступен
            try {
                const bm = window.bankModule || window.BankModule || null;
                const state = bm?.core?.getState ? bm.core.getState() : (bm?.getState ? bm.getState() : null);
                if (state && typeof state.currentBalance === 'number') {
                    currentBalance = state.currentBalance;
                }
            } catch {}

            const totalCost = currentPlayerCard.cost * quantity;
            const canAfford = (currentBalance || 0) >= totalCost;
            if (canAfford) {
                // Списываем деньги
                subtractBalance(totalCost, `Покупка: ${currentPlayerCard.name}${quantity>1?` x${quantity}`:''}`);
                
                // Обрабатываем специальные карточки
                if (currentPlayerCard.isDiceCard) {
                    handleDiceCard(currentPlayerCard);
                    return;
                }
                
                if (currentPlayerCard.isFriendMoneyCard) {
                    handleFriendMoneyCard(currentPlayerCard);
                    return;
                }
                
                // Добавляем в активы игрока
                const cardToAdd = { ...currentPlayerCard };
                if (currentPlayerCard.type === 'stocks' || currentPlayerCard.type === 'crypto') {
                    cardToAdd.quantity = (cardToAdd.quantity || 0) + quantity;
                }
                playerAssets[currentPlayer].push(cardToAdd);
                
                // Отмечаем карточку как доступную для продажи в текущем ходу (только для обычных акций и BTC)
                if ((currentPlayerCard.type === 'stocks' || currentPlayerCard.type === 'crypto') && !currentPlayerCard.isDividendStock) {
                    if (!currentTurnCards[currentPlayer]) {
                        currentTurnCards[currentPlayer] = [];
                    }
                    currentTurnCards[currentPlayer].push({
                        cardId: currentPlayerCard.id,
                        turn: currentTurn,
                        canSell: true
                    });
                }
                
                // Обновляем пассивный доход
                if (playerPassiveIncome && playerPassiveIncome[currentPlayer]) {
                    playerPassiveIncome[currentPlayer] += currentPlayerCard.income * (cardToAdd.quantity || 1);
                } else {
                    playerPassiveIncome = playerPassiveIncome || {};
                    playerPassiveIncome[currentPlayer] = currentPlayerCard.income * (cardToAdd.quantity || 1);
                }
                
                updateFinancesDisplay();
                updateBalanceDisplay();
                
                showNotification(`✅ Куплено: ${currentPlayerCard.name} за $${currentPlayerCard.cost.toLocaleString()}`, 'success');
                
                // Очищаем текущую карточку
                currentPlayerCard = null;
                closeCardModal();
            } else {
                alert(`❌ Недостаточно средств для покупки.\nНужно: $${totalCost.toLocaleString()}\nУ вас: $${(currentBalance || 0).toLocaleString()}`);
            }
        }

        // Обработка карточки с бросом кубика (Plazma Life water)
        function handleDiceCard(card) {
            showDiceModal(card);
        }

        // Обработка карточки "Другу нужны деньги"
        function handleFriendMoneyCard(card) {
            // Списываем деньги
            subtractBalance(card.cost, `Помощь другу: ${card.name}`);
            
            // Обрабатываем эффект
            switch (card.effect) {
                case 'nothing':
                    showNotification(`💝 Помогли другу! Друг благодарен, но ничего не получили.`, 'info');
                    break;
                    
                case 'extra_turn':
                    showNotification(`💝 Помогли другу! Друг настолько благодарен, что передает вам свой ход!`, 'success');
                    // Логика дополнительного хода будет добавлена позже
                    break;
                    
                case 'free_cards':
                    showNotification(`💝 Помогли другу! Друг дарит вам карточки!`, 'success');
                    showFreeCardsModal();
                    break;
                    
                default:
                    showNotification(`💝 Помогли другу! Друг благодарен.`, 'info');
            }
            
            // Очищаем текущую карточку
            currentPlayerCard = null;
            closeCardModal();
            updateBalanceDisplay();
        }

        // Показать модал для броска кубика
        function showDiceModal(card) {
            const modal = document.getElementById('diceModal');
            if (!modal) {
                createDiceModal();
            }
            
            document.getElementById('diceCardName').textContent = card.name;
            document.getElementById('diceCardDescription').textContent = card.description;
            document.getElementById('diceMultiplier').textContent = card.diceMultiplier;
            
            modal.style.display = 'block';
        }
        // Создать модал для броска кубика
        function createDiceModal() {
            const modal = document.createElement('div');
            modal.id = 'diceModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>🎲 Бросок кубика</h2>
                        <button class="close-btn" onclick="closeDiceModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <h3 id="diceCardName">Карточка</h3>
                        <p id="diceCardDescription">Описание</p>
                        <div class="dice-container">
                            <div class="dice-result" id="diceResult">?</div>
                            <button class="modern-btn primary" onclick="rollDiceForCard()">🎲 Бросить кубик</button>
                        </div>
                        <div class="dice-info">
                            <p>Каждый партнер приносит <span id="diceMultiplier">100</span>$ в месяц</p>
                            <p id="diceIncomeInfo" style="display: none;">Ваш пассивный доход: <span id="diceIncomeAmount">0</span>$ в месяц</p>
                        </div>
                        <div class="dice-actions" style="display: none;">
                            <button class="modern-btn primary" onclick="confirmDiceCard()">✅ Подтвердить</button>
                            <button class="modern-btn secondary" onclick="closeDiceModal()">❌ Отказаться</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Бросок кубика для карточки
        function rollDiceForCard() {
            const diceResult = Math.floor(Math.random() * 6) + 1;
            const multiplier = currentPlayerCard.diceMultiplier || 100;
            const income = diceResult * multiplier;
            
            document.getElementById('diceResult').textContent = diceResult;
            document.getElementById('diceIncomeAmount').textContent = income.toLocaleString();
            document.getElementById('diceIncomeInfo').style.display = 'block';
            document.querySelector('.dice-actions').style.display = 'block';
            
            // Сохраняем результат
            currentPlayerCard.diceResult = diceResult;
            currentPlayerCard.income = income;
        }

        // Подтвердить карточку с кубиком
        function confirmDiceCard() {
            if (!currentPlayerCard) return;
            
            // Добавляем в активы игрока
            playerAssets[currentPlayer].push(currentPlayerCard);
            
            // Обновляем пассивный доход
            if (playerPassiveIncome && playerPassiveIncome[currentPlayer]) {
                playerPassiveIncome[currentPlayer] += currentPlayerCard.income;
            } else {
                playerPassiveIncome = playerPassiveIncome || {};
                playerPassiveIncome[currentPlayer] = currentPlayerCard.income;
            }
            
            updateFinancesDisplay();
            updateBalanceDisplay();
            
            showNotification(`✅ Куплено: ${currentPlayerCard.name} за $${currentPlayerCard.cost.toLocaleString()}. Доход: $${currentPlayerCard.income.toLocaleString()}/мес`, 'success');
            
            // Очищаем текущую карточку
            currentPlayerCard = null;
            closeDiceModal();
        }

        // Закрыть модал кубика
        function closeDiceModal() {
            const modal = document.getElementById('diceModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Показать модал бесплатных карточек
        function showFreeCardsModal() {
            const modal = document.getElementById('freeCardsModal');
            if (!modal) {
                createFreeCardsModal();
            }
            
            modal.style.display = 'block';
        }

        // Создать модал бесплатных карточек
        function createFreeCardsModal() {
            const modal = document.createElement('div');
            modal.id = 'freeCardsModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>🎁 Бесплатные карточки</h2>
                        <button class="close-btn" onclick="closeFreeCardsModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Друг дарит вам карточки! Выберите одну малую и одну большую сделку:</p>
                        <div class="free-cards-container">
                            <div class="free-card-section">
                                <h3>Малая сделка</h3>
                                <button class="modern-btn primary" onclick="drawFreeCard('small')">🎯 Вытянуть малую сделку</button>
                            </div>
                            <div class="free-card-section">
                                <h3>Большая сделка</h3>
                                <button class="modern-btn primary" onclick="drawFreeCard('big')">🏢 Вытянуть большую сделку</button>
                            </div>
                        </div>
                        <div class="free-cards-actions">
                            <button class="modern-btn secondary" onclick="closeFreeCardsModal()">Закрыть</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Вытянуть бесплатную карточку
        function drawFreeCard(type) {
            const card = drawCard(type);
            if (card) {
                // Добавляем в активы игрока без оплаты
                playerAssets[currentPlayer].push(card);
                
                // Обновляем пассивный доход
                if (playerPassiveIncome && playerPassiveIncome[currentPlayer]) {
                    playerPassiveIncome[currentPlayer] += card.income;
                } else {
                    playerPassiveIncome = playerPassiveIncome || {};
                    playerPassiveIncome[currentPlayer] = card.income;
                }
                
                updateFinancesDisplay();
                updateBalanceDisplay();
                
                showNotification(`🎁 Получена бесплатная карточка: ${card.name}`, 'success');
            }
        }

        // Закрыть модал бесплатных карточек
        function closeFreeCardsModal() {
            const modal = document.getElementById('freeCardsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Проверить, можно ли продать карточку в текущем ходу
        function canSellCardInCurrentTurn(card) {
            // Дивидендные акции можно продавать в любое время
            if (card.isDividendStock) {
                return true;
            }
            
            // Обычные акции и BTC можно продавать только в ход, когда они были куплены
            if (card.type === 'stocks' || card.type === 'crypto') {
                const playerCards = currentTurnCards[currentPlayer] || [];
                return playerCards.some(turnCard => 
                    turnCard.cardId === card.id && 
                    turnCard.turn === currentTurn && 
                    turnCard.canSell
                );
            }
            
            // Остальные карточки можно продавать в любое время
            return true;
        }

        // Получить доступные для продажи карточки текущего игрока
        function getSellableCards() {
            const playerCards = playerAssets[currentPlayer] || [];
            return playerCards.filter(card => canSellCardInCurrentTurn(card));
        }
        // Показать активы игрока
        function showPlayerAssets() {
            const playerCards = playerAssets[currentPlayer] || [];
            const sellableCards = getSellableCards();
            
            // Создаем модал для отображения активов
            const modal = document.createElement('div');
            modal.id = 'assetsModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>💰 Мои активы</h2>
                        <button class="close-btn" onclick="closeAssetsModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="assets-info">
                            <p>Всего активов: ${playerCards.length}</p>
                            <p>Доступно для продажи в текущем ходу: ${sellableCards.length}</p>
                        </div>
                        <div class="assets-list">
                            ${playerCards.map(card => `
                                <div class="asset-item ${canSellCardInCurrentTurn(card) ? 'sellable' : 'not-sellable'}">
                                    <div class="asset-info">
                                        <h4>${card.name}</h4>
                                        <p>Стоимость: $${card.cost.toLocaleString()}</p>
                                        <p>Доход: $${card.income.toLocaleString()}/мес</p>
                                        <p class="asset-type">Тип: ${getCardTypeName(card.type)}</p>
                                        ${card.isDividendStock ? '<span class="dividend-badge">Дивидендная</span>' : ''}
                                        ${!canSellCardInCurrentTurn(card) && (card.type === 'stocks' || card.type === 'crypto') ? '<span class="sell-restriction">Только в ход покупки</span>' : ''}
                                    </div>
                                <div class="asset-actions">
                                        ${canSellCardInCurrentTurn(card) ? 
                                            `<button class=\"modern-btn secondary\" onclick=\"sellAsset(${card.id})\">Продать</button>` : 
                                            `<button class=\"modern-btn disabled\" disabled>Недоступно</button>`
                                        }
                                        <button class="modern-btn" onclick="openTransferModal(${card.id})">Передать</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        // Открыть модал передачи актива
        async function openTransferModal(cardId) {
            const playerCards = playerAssets[currentPlayer] || [];
            const card = playerCards.find(c => c.id === cardId);
            if (!card) { showNotification('❌ Карточка не найдена', 'error'); return; }

            // Получаем игроков комнаты
            const roomId = getRoomIdFromURL();
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            let players = [];
            try {
                const resp = await fetch(`/api/rooms/${roomId}?user_id=${user.id}`);
                if (resp.ok) { const data = await resp.json(); players = data.players || []; }
            } catch {}

            // Формируем список получателей (кроме себя)
            const recipients = players
                .map((p, idx) => ({ index: idx, name: p.name || `Игрок ${idx+1}` }))
                .filter(p => p.index !== currentPlayer);

            const modal = document.createElement('div');
            modal.id = 'transferModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>🔁 Передать актив</h2>
                        <button class="close-btn" onclick="closeTransferModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom:8px; font-weight:600;">${card.name}</p>
                        <div class="card-info-row">
                            <span class="card-label">Получатель:</span>
                            <span class="card-value">
                                <select id="transferRecipient" style="min-width:220px;">
                                    ${recipients.map(r => `<option value="${r.index}">${r.name}</option>`).join('')}
                                </select>
                            </span>
                        </div>
                        ${ (card.type === 'stocks' || card.type === 'crypto') ? `
                        <div class="card-info-row">
                            <span class="card-label">Количество:</span>
                            <span class="card-value">
                                <input id="transferQty" type="number" min="1" max="${card.quantity || 1}" value="1" style="width:100px;">
                                <span style="opacity:.7; margin-left:6px;">из ${card.quantity || 1}</span>
                            </span>
                        </div>` : ''}
                        <div style="margin-top:14px; display:flex; gap:8px;">
                            <button class="modern-btn primary" onclick="confirmTransfer(${card.id})">Передать</button>
                            <button class="modern-btn secondary" onclick="closeTransferModal()">Отмена</button>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function closeTransferModal() {
            const modal = document.getElementById('transferModal');
            if (modal) modal.remove();
        }

        // Подтвердить передачу
        function confirmTransfer(cardId) {
            const playerCards = playerAssets[currentPlayer] || [];
            const card = playerCards.find(c => c.id === cardId);
            if (!card) { showNotification('❌ Карточка не найдена', 'error'); return; }
            const recipientSelect = document.getElementById('transferRecipient');
            const recipientIndex = parseInt(recipientSelect ? recipientSelect.value : '-1', 10);
            if (Number.isNaN(recipientIndex) || recipientIndex < 0) { showNotification('❌ Выберите получателя', 'error'); return; }

            // Количество
            let qtyToSend = 1;
            if (card.type === 'stocks' || card.type === 'crypto') {
                const qtyInput = document.getElementById('transferQty');
                qtyToSend = Math.max(1, Math.min(parseInt(qtyInput ? qtyInput.value : '1', 10) || 1, card.quantity || 1));
            }

            // Снимаем у отправителя
            const senderPassive = playerPassiveIncome[currentPlayer] || 0;
            const perUnitIncome = (card.type === 'stocks' || card.type === 'crypto') ? (card.income || 0) : card.income;
            playerPassiveIncome[currentPlayer] = Math.max(0, senderPassive - perUnitIncome * qtyToSend);

            if (card.type === 'stocks' || card.type === 'crypto') {
                card.quantity = (card.quantity || 1) - qtyToSend;
                if (card.quantity <= 0) {
                    const idx = playerCards.findIndex(c => c.id === cardId);
                    if (idx !== -1) playerCards.splice(idx, 1);
                }
            } else {
                const idx = playerCards.findIndex(c => c.id === cardId);
                if (idx !== -1) playerCards.splice(idx, 1);
            }

            // Серверная фиксация передачи
            (async () => {
                try {
                    const roomId = getRoomIdFromURL();
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    await fetch(`/api/rooms/${roomId}/transfer-asset`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: user.id, recipient_index: recipientIndex, card, quantity: qtyToSend })
                    });
                } catch (e) { console.warn('Server transfer sync failed:', e); }
                
                // Локально добавляем получателю для мгновенного UI
                if (!playerAssets[recipientIndex]) playerAssets[recipientIndex] = [];
                const receiveCard = { ...card };
                if (card.type === 'stocks' || card.type === 'crypto') {
                    receiveCard.quantity = qtyToSend;
                }
                playerAssets[recipientIndex].push(receiveCard);
                const recPassive = playerPassiveIncome[recipientIndex] || 0;
                playerPassiveIncome[recipientIndex] = recPassive + perUnitIncome * qtyToSend;

                updateFinancesDisplay();
                showNotification(`🔁 Передано: ${card.name}${(card.type === 'stocks' || card.type === 'crypto') ? ` x${qtyToSend}` : ''}`, 'success');
                closeTransferModal();
                closeAssetsModal();
                showPlayerAssets();
            })();
        }

        // Получить название типа карточки
        function getCardTypeName(type) {
            const typeNames = {
                'stocks': 'Акции',
                'crypto': 'Криптовалюта',
                'dividend_stocks': 'Дивидендные акции',
                'real_estate': 'Недвижимость',
                'beauty_salon': 'Салон красоты',
                'coffee_shop': 'Кофейня',
                'partnership': 'Партнерство',
                'charity': 'Благотворительность',
                'land': 'Земля',
                'expense': 'Расходы',
                'equipment': 'Оборудование',
                'flipping': 'Флипинг',
                'franchise': 'Франшиза'
            };
            return typeNames[type] || type;
        }

        // Продать актив
        function sellAsset(cardId) {
            const playerCards = playerAssets[currentPlayer] || [];
            const card = playerCards.find(c => c.id === cardId);
            
            if (!card) {
                showNotification('❌ Карточка не найдена', 'error');
                return;
            }
            
            if (!canSellCardInCurrentTurn(card)) {
                showNotification('❌ Эту карточку нельзя продать в текущем ходу', 'error');
                return;
            }
            
            // Удаляем карточку из активов
            const cardIndex = playerCards.findIndex(c => c.id === cardId);
            if (cardIndex !== -1) {
                playerCards.splice(cardIndex, 1);
            }
            
            // Уменьшаем пассивный доход
            if (playerPassiveIncome && playerPassiveIncome[currentPlayer]) {
                playerPassiveIncome[currentPlayer] -= card.income;
                if (playerPassiveIncome[currentPlayer] < 0) {
                    playerPassiveIncome[currentPlayer] = 0;
                }
            }
            
            // Добавляем деньги за продажу (обычно половина от стоимости)
            const sellPrice = Math.floor(card.cost * 0.5);
            addBalance(sellPrice, `Продажа: ${card.name}`);
            
            updateFinancesDisplay();
            updateBalanceDisplay();
            showNotification(`✅ Продано: ${card.name} за $${sellPrice.toLocaleString()}`, 'success');
            
            // Обновляем модал активов
            closeAssetsModal();
            showPlayerAssets();
        }

        // Закрыть модал активов
        function closeAssetsModal() {
            const modal = document.getElementById('assetsModal');
            if (modal) {
                modal.remove();
            }
        }

        function refuseCard() {
            if (!currentPlayerCard) return;

            // Отправляем карточку в отбой
            discardCard(currentPlayerCard, currentPlayerCard.deckType);
            
            showNotification(`❌ Карточка "${currentPlayerCard.name}" отправлена в отбой`, 'info');
            
            // Очищаем текущую карточку
            currentPlayerCard = null;
            closeCardModal();
        }

        // Функции для работы с картами рынка
        function drawMarketCard() {
            const deck = cardDecks.market;
            if (deck.length === 0) {
                // Перемешиваем отбой и возвращаем в колоду
                cardDecks.market = shuffleDeck(cardDecks.marketDiscard);
                cardDecks.marketDiscard = [];
                updateCardCounters();
            }
            
            if (cardDecks.market.length === 0) {
                return null; // Нет карточек
            }
            
            return cardDecks.market.pop();
        }

        function discardMarketCard(card) {
            cardDecks.marketDiscard.push(card);
            updateCardCounters();
        }

        function processMarketCard(card) {
            if (!card) return;

            // Обрабатываем разные типы карт рынка
            if (card.type === 'crypto_crash') {
                // Крах криптовалюты - влияет на всех игроков
                showNotification('💥 Крах криптовалюты! Все игроки теряют BTC активы', 'warning');
                // Здесь можно добавить логику потери BTC активов
            } else if (card.type === 'stock_crash') {
                // Крах акций - влияет на всех игроков
                showNotification('📉 Биржевой крах! Все акции теряют 50% стоимости', 'warning');
                // Здесь можно добавить логику потери стоимости акций
            } else if (card.type === 'bonus') {
                // Бонус - дополнительный доход
                addBalance(card.bonus, `Бонус: ${card.name}`);
                showNotification(`💰 Получен бонус: $${card.bonus.toLocaleString()}`, 'success');
            } else if (card.offer) {
                // Предложение о продаже актива
                showMarketOfferModal(card);
            }

            // Отправляем карточку в отбой
            discardMarketCard(card);
        }
        function showMarketOfferModal(card) {
            const modal = document.getElementById('marketOfferModal');
            if (!modal) return;

            document.getElementById('marketOfferTitle').textContent = card.name;
            document.getElementById('marketOfferDescription').textContent = card.description;
            document.getElementById('marketOfferAmount').textContent = `$${card.offer.toLocaleString()}`;
            
            if (card.profit) {
                document.getElementById('marketOfferProfit').textContent = `Прибыль: $${card.profit.toLocaleString()}`;
                document.getElementById('marketOfferProfit').style.color = '#10b981';
            } else if (card.loss) {
                document.getElementById('marketOfferProfit').textContent = `Убыток: $${card.loss.toLocaleString()}`;
                document.getElementById('marketOfferProfit').style.color = '#ef4444';
            }

            // Показываем кнопки продажи/отказа
            const sellButton = document.getElementById('marketSellButton');
            const refuseButton = document.getElementById('marketRefuseButton');
            
            if (sellButton) sellButton.style.display = 'inline-block';
            if (refuseButton) refuseButton.style.display = 'inline-block';

            // Сохраняем текущую карточку для обработки
            currentPlayerCard = card;

            modal.style.display = 'block';
        }

        function closeMarketOfferModal() {
            const modal = document.getElementById('marketOfferModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function sellAsset() {
            if (!currentPlayerCard) return;

            // Добавляем деньги от продажи
            addBalance(currentPlayerCard.offer, `Продажа: ${currentPlayerCard.name}`);
            
            // Удаляем актив из активов игрока (если есть)
            // Здесь нужно добавить логику поиска и удаления соответствующего актива
            
            showNotification(`💰 Продано: ${currentPlayerCard.name} за $${currentPlayerCard.offer.toLocaleString()}`, 'success');
            
            // Очищаем текущую карточку
            currentPlayerCard = null;
            closeMarketOfferModal();
        }

        function refuseMarketOffer() {
            if (!currentPlayerCard) return;

            showNotification(`❌ Отклонено предложение: ${currentPlayerCard.name}`, 'info');
            
            // Очищаем текущую карточку
            currentPlayerCard = null;
            closeMarketOfferModal();
        }

        // Функции для работы с картами расходов
        function drawExpenseCard() {
            const deck = cardDecks.expense;
            if (deck.length === 0) {
                // Перемешиваем отбой и возвращаем в колоду
                cardDecks.expense = shuffleDeck(cardDecks.expenseDiscard);
                cardDecks.expenseDiscard = [];
                updateCardCounters();
            }
            
            if (cardDecks.expense.length === 0) {
                return null; // Нет карточек
            }
            
            return cardDecks.expense.pop();
        }

        function discardExpenseCard(card) {
            cardDecks.expenseDiscard.push(card);
            updateCardCounters();
        }

        function processExpenseCard(card) {
            if (!card) return;

            const canAfford = (currentBalance || 0) >= card.amount;
            
            if (canAfford) {
                // Списываем деньги
                subtractBalance(card.amount, `Расход: ${card.name}`);
                showNotification(`💸 Оплачено: ${card.name} - $${card.amount.toLocaleString()}`, 'info');
            } else {
                // Предлагаем взять кредит
                showExpenseModal(card);
            }

            // Отправляем карточку в отбой
            discardExpenseCard(card);
        }

        function showExpenseModal(card) {
            const modal = document.getElementById('expenseModal');
            if (!modal) return;

            document.getElementById('expenseTitle').textContent = card.name;
            document.getElementById('expenseAmount').textContent = `$${card.amount.toLocaleString()}`;
            document.getElementById('expenseDescription').textContent = card.description;

            // Показываем кнопки оплаты/кредита
            const payButton = document.getElementById('expensePayButton');
            const creditButton = document.getElementById('expenseCreditButton');
            
            if (payButton) payButton.style.display = 'inline-block';
            if (creditButton) creditButton.style.display = 'inline-block';

            // Сохраняем текущую карточку для обработки
            currentPlayerCard = card;

            modal.style.display = 'block';
        }

        function closeExpenseModal() {
            const modal = document.getElementById('expenseModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function payExpense() {
            if (!currentPlayerCard) return;

            const canAfford = (currentBalance || 0) >= currentPlayerCard.amount;
            if (canAfford) {
                subtractBalance(currentPlayerCard.amount, `Расход: ${currentPlayerCard.name}`);
                showNotification(`💸 Оплачено: ${currentPlayerCard.name} - $${currentPlayerCard.amount.toLocaleString()}`, 'success');
            } else {
                alert(`❌ Недостаточно средств для оплаты.\nНужно: $${currentPlayerCard.amount.toLocaleString()}\nУ вас: $${(currentBalance || 0).toLocaleString()}`);
                return;
            }

            // Очищаем текущую карточку
            currentPlayerCard = null;
            closeExpenseModal();
        }

        function takeExpenseCredit() {
            if (!currentPlayerCard) return;

            // Открываем банковский модуль для получения кредита
            if (typeof openBankModal === 'function') {
                openBankModal();
                showNotification('🏦 Откройте банк для получения кредита на оплату расходов', 'info');
            } else {
                alert('Банковский модуль недоступен. Нужно взять кредит для оплаты расходов.');
            }

            // Очищаем текущую карточку
            currentPlayerCard = null;
            closeExpenseModal();
        }

        function updateCardCounters() {
            // Обновляем счетчики карт рынка и расходов
            const marketDeckEl = document.getElementById('marketDeck');
            const marketDiscardEl = document.getElementById('marketDiscard');
            const expenseDeckEl = document.getElementById('expenseDeck');
            const expenseDiscardEl = document.getElementById('expenseDiscard');

            if (marketDeckEl) marketDeckEl.textContent = cardDecks.market.length;
            if (marketDiscardEl) marketDiscardEl.textContent = cardDecks.marketDiscard.length;
            if (expenseDeckEl) expenseDeckEl.textContent = cardDecks.expense.length;
            if (expenseDiscardEl) expenseDiscardEl.textContent = cardDecks.expenseDiscard.length;
        }
        // Инициализация игрового поля
        async function initializeGameBoard() {
            try {
                console.log('🎲 Инициализация игрового поля');
                
                // Создаем экземпляры сервисов
                gameBoardService = new GameBoardService();
                gameBoardUI = new GameBoardUI();
                
                // Получаем ID комнаты
                const roomId = getRoomIdFromURL();
                if (!roomId) {
                    console.error('❌ ID комнаты не найден');
                    alert('ID комнаты не найден. Возврат в лобби.');
                    window.location.href = '/lobby';
                    return;
                }
                
                // Инициализируем поле на сервере
                const response = await fetch(`/api/rooms/${roomId}/initialize-board`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Игровое поле инициализировано', data);
                } else {
                    console.error('❌ Ошибка инициализации поля');
                }
                
            } catch (error) {
                console.error('❌ Ошибка инициализации игрового поля:', error);
            }
        }

        // Инициализация угловых карточек
        function initializeCornerCards() {
            try {
                console.log('🃏 Инициализация угловых карточек');
                
                // Перемешиваем колоды карточек
                dealDecks.smallDeals = shuffleDeck(dealDecks.smallDeals);
                dealDecks.bigDeals = shuffleDeck(dealDecks.bigDeals);
                
                // Обновляем счетчики карточек сделок
                updateDeckCounters();
                
                // Инициализируем счетчики других карт
                const cardTypes = ['market', 'expenses'];
                
                cardTypes.forEach(type => {
                    const deckElement = document.getElementById(`${type}Deck`);
                    const discardElement = document.getElementById(`${type}Discard`);
                    
                    if (deckElement && discardElement) {
                        // Устанавливаем начальные значения из gameDecks
                        if (type === 'market' && gameDecks.market) {
                            deckElement.textContent = gameDecks.market.length;
                            discardElement.textContent = gameDecks.marketDiscard.length;
                        } else if (type === 'expenses' && gameDecks.expense) {
                            deckElement.textContent = gameDecks.expense.length;
                            discardElement.textContent = gameDecks.expenseDiscard.length;
                        } else {
                            // Fallback значения
                            deckElement.textContent = '24'; // 24 карточки в каждой колоде
                            discardElement.textContent = '0';
                        }
                        
                        // Добавляем обработчики клика
                        const cardElement = document.getElementById(`${type}Card`);
                        if (cardElement) {
                            cardElement.addEventListener('click', () => {
                                showCardInfo(type);
                            });
                        }
                    }
                });
                
                console.log('✅ Угловые карточки инициализированы');
                
                // Обновляем все счетчики колод
                updateDeckCounters();
                
            } catch (error) {
                console.error('❌ Ошибка инициализации угловых карточек:', error);
            }
        }

        // Показать информацию о карточке
        function showCardInfo(cardType) {
            const cardNames = {
                'bigDeal': 'Большая сделка',
                'smallDeal': 'Малая сделка',
                'market': 'Рынок',
                'expenses': 'Расходы'
            };
            
            const cardDescriptions = {
                'bigDeal': 'Карточки с крупными инвестиционными возможностями',
                'smallDeal': 'Карточки с небольшими инвестиционными возможностями',
                'market': 'Карточки рыночных событий и изменений',
                'expenses': 'Карточки с расходами и обязательствами'
            };
            
            const deckCount = document.getElementById(`${cardType}Deck`).textContent;
            const discardCount = document.getElementById(`${cardType}Discard`).textContent;
            
            alert(`${cardNames[cardType]}\n\n${cardDescriptions[cardType]}\n\nКарт в колоде: ${deckCount}\nКарт в отбое: ${discardCount}`);
        }

        // Загрузка данных банка теперь в банковском модуле
        // Загрузка информации о ходе с сервера
        async function loadTurnInfo() {
            try {
                const roomId = getRoomIdFromURL();
                if (!roomId) return;

                const response = await fetch(`/api/rooms/${roomId}/turn`);
                
                if (!response.ok) {
                    console.warn('Failed to load turn info:', response.status, response.statusText);
                    return;
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    // Получаем информацию о игроках для проверки
                    const user = localStorage.getItem('user');
                    if (user) {
                        const userData = JSON.parse(user);
                        const playersResponse = await fetch(`/api/rooms/${roomId}?user_id=${userData.id}`);
                        const playersData = await playersResponse.json();
                        
                        if (playersResponse.ok && playersData.players && playersData.players.length > 0) {
                            // Проверяем, что current_player в пределах массива игроков
                            if (data.current_player >= 0 && data.current_player < playersData.players.length) {
                                // Проверяем, изменился ли текущий игрок
                                const previousPlayer = currentPlayer;
                                currentPlayer = data.current_player;
                                
                                // Обновляем таймер
                                gameTimer = data.remaining_seconds;
                                maxTimer = data.turn_duration;
                                
                                console.log('Turn info received:', {
                                    current_player: data.current_player,
                                    previous_player: previousPlayer,
                                    remaining_seconds: data.remaining_seconds,
                                    turn_duration: data.turn_duration,
                                    gameTimer: gameTimer,
                                    maxTimer: maxTimer
                                });
                                
                                // Если сменился игрок, перезапускаем таймер
                                if (previousPlayer !== currentPlayer) {
                                    console.log('Player changed, restarting timer');
                                    clearInterval(timerInterval);
                                    startTimer();
                                }
                                
                                // Обновляем UI
                                updateCurrentPlayer();
                                updateTimerDisplay();
                                
                                // Сервер автоматически управляет переходами хода при истечении времени
                            } else {
                                console.warn('Server current_player out of bounds:', data.current_player, 'Players count:', playersData.players.length);
                            }
                        }
                    }
                } else if (response.status === 404) {
                    console.error('Room not found:', roomId);
                    alert('Комната не найдена. Возможно, она была удалена.');
                    // Перенаправляем в лобби
                    window.location.href = '/lobby';
                }
            } catch (error) {
                console.error('Error loading turn info:', error);
            }
        }
        // Получение ID комнаты из URL/пути с резервом из localStorage
        function getRoomIdFromURL() {
            const href = window.location.href;
            const urlParams = new URLSearchParams(window.location.search);
            let roomId = urlParams.get('room');
            const debug = { source: 'query', value: roomId };
            
            // Если нет в query, пытаемся вытащить из пути вида /room/<id>
            if (!roomId) {
                const pathMatch = window.location.pathname.match(/\/(?:room|table)\/([0-9a-fA-F]{24})/);
                if (pathMatch && pathMatch[1]) {
                    roomId = pathMatch[1];
                    debug.source = 'path';
                    debug.value = roomId;
                }
            }

            // Если всё ещё нет, пробуем вытащить 24-символьный hex из полной ссылки
            if (!roomId) {
                const anyHex = href.match(/[0-9a-fA-F]{24}/);
                if (anyHex) {
                    roomId = anyHex[0];
                    debug.source = 'href-hex';
                    debug.value = roomId;
                }
            }

            // Если в URL нет ID комнаты, пробуем взять из localStorage
            if (!roomId) {
                try {
                    const saved = localStorage.getItem('lastRoomId');
                    if (saved) {
                        roomId = saved;
                        // Обновляем URL, чтобы не терять ID при дальнейших переходах
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set('room', roomId);
                        window.history.replaceState({}, '', newUrl.toString());
                        debug.source = 'localStorage';
                        debug.value = roomId;
                    }
                } catch (e) {
                    console.warn('Cannot access localStorage for lastRoomId:', e);
                }
            }
            
            // Фильтруем невалидные значения
            if (roomId === 'undefined' || roomId === 'null' || roomId === '') {
                roomId = null;
            }
            
            console.log('Room ID detection:', {
                href,
                ...debug
            });
            
            return roomId;
        }

        // Получение индекса текущего игрока
        function getCurrentPlayerIndex() {
            try {
                const user = localStorage.getItem('user');
                if (user) {
                    const userData = JSON.parse(user);
                    // Нужно найти индекс игрока в комнате
                    // Пока возвращаем 0, но это нужно будет исправить
                    return 0;
                }
            } catch (error) {
                console.error('Error getting current player index:', error);
            }
            return 0;
        }

        // Обновление позиций фишек игроков
        let tokensInitialized = false;

        // Возвращает сдвиг фишки, если на одной клетке несколько игроков
        function getTokenOffsetForPlayer(playerIndex, cellNumber, cellSizePx) {
            const group = [];
            for (let i = 0; i < playerPositions.length; i++) {
                if (playerPositions[i] === cellNumber) group.push(i);
            }
            const posInGroup = group.indexOf(playerIndex);
            if (posInGroup <= 0) return { x: 0, y: 0 };

            const offset = cellSizePx * 0.10; // 10%
            // Раскладываем по маленькой сетке 2x2, затем 3x2 и т.д.
            const cols = 2;
            const x = (posInGroup % cols) * offset;
            const y = Math.floor(posInGroup / cols) * offset;
            return { x, y };
        }
        function updatePlayerTokenPositions() {
            if (!tokensInitialized) {
                return;
            }
            console.log('Updating player token positions:', playerPositions);
            for (let i = 0; i < playerPositions.length; i++) {
                const playerToken = document.getElementById(`player${i}`);
                if (playerToken && playerPositions[i] !== undefined) {
                    const position = playerPositions[i];
                    const playerTrack = playerTracks[i] || 'inner';
                    const targetCell = playerTrack === 'inner'
                        ? document.querySelector(`.inner-squares [data-cell="${position}"]`)
                        : document.querySelector(`.outer-squares [data-cell="${position}"]`);
                    
                    console.log(`Player ${i} position: ${position}, targetCell:`, targetCell);
                    
                    if (targetCell) {
                        const cellRect = targetCell.getBoundingClientRect();
                        const boardRect = document.querySelector('.game-board').getBoundingClientRect();
                        
                        const x = cellRect.left - boardRect.left + cellRect.width / 2;
                        const y = cellRect.top - boardRect.top + cellRect.height / 2;
                        const { x: offsetX, y: offsetY } = getTokenOffsetForPlayer(i, position, cellRect.width);
                        
                        playerToken.style.left = `${x + offsetX - 12}px`;
                        playerToken.style.top = `${y + offsetY - 12}px`;
                        playerToken.style.position = 'absolute';
                        playerToken.style.zIndex = '100';
                        
                        console.log(`Positioned player ${i} at cell ${position} (${x}, ${y})`);
                    } else {
                        console.warn(`Target cell not found for position ${position}`);
                    }
                } else {
                    console.warn(`Player token not found for player ${i}`);
                }
            }
        }

        // Инициализация фишек игроков в центре стартовой клетки
        async function initializePlayerTokens() {
            try {
                // Загружаем данные комнаты для получения количества игроков
                const roomId = getRoomIdFromURL();
                if (!roomId) return;

                const user = localStorage.getItem('user');
                if (!user) return;
                
                const userData = JSON.parse(user);
                const response = await fetch(`/api/rooms/${roomId}?user_id=${userData.id}`);
                const data = await response.json();
                
                if (response.ok && data.players) {
                    const players = data.players;
                    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#FFB347', '#98D8C8'];
                    
                    // Удаляем все существующие фишки
                    const existingTokens = document.querySelectorAll('.player-token');
                    existingTokens.forEach(token => token.remove());
                    
                    // Настраиваем массивы под фактическое число игроков
                    playerTracks = new Array(players.length).fill('inner');
                    // Загружаем сохранённые позиции с сервера (0..23 на малом круге)
                    let serverPositions = [];
                    try {
                        const posResp = await fetch(`/api/rooms/${roomId}/positions`);
                        if (posResp.ok) {
                            const posData = await posResp.json();
                            serverPositions = Array.isArray(posData.player_positions) ? posData.player_positions : [];
                            console.log('📍 Загружены позиции с сервера:', serverPositions);
                        }
                    } catch (e) { console.warn('Не удалось загрузить позиции игроков:', e); }
                    // Преобразуем 0..23 → 1..24 для UI
                    playerPositions = new Array(players.length).fill(1); // По умолчанию старт
                    for (let i = 0; i < players.length; i++) {
                        const zeroBased = typeof serverPositions[i] === 'number' ? serverPositions[i] : 0;
                        // Позиция 0 = клетка 1 (старт), позиция 1+ = соответствующие клетки
                        playerPositions[i] = (zeroBased % 24) + 1;
                    }
                    console.log('📍 Финальные позиции игроков:', playerPositions);
                    console.log('📍 Детализация позиций:');
                    for (let i = 0; i < players.length; i++) {
                        console.log(`  Игрок ${i}: сервер=${serverPositions[i]}, UI=${playerPositions[i]}`);
                    }
                    // Создаем фишки игроков согласно позициям
                    try {
                        for (let i = 0; i < players.length; i++) {
                            const playerName = players[i].name || `Игрок ${i + 1}`;
                            const color = colors[i % colors.length];
                            const position = playerPositions[i];
                            if (gameBoardUI && typeof gameBoardUI.createPlayerToken === 'function') {
                                gameBoardUI.createPlayerToken(i, playerName, color, position);
                                console.log(`✅ Создана фишка для игрока ${i}: ${playerName} на клетке ${position}`);
                            }
                        }
                        tokensInitialized = true;
                        updatePlayerTokenPositions();
                    } catch (e) {
                        console.warn('Не удалось создать фишки игроков:', e);
                    }
                    // Обновляем информацию о текущем игроке
                    if (players[currentPlayer]) {
                        updateCurrentPlayerInfo(players[currentPlayer]);
                    }
                }
            } catch (error) {
                console.error('Error initializing player tokens:', error);
            }
        }
        // Создание внешнего периметра (44 квадрата) - симметричное расположение, номера 1-48 (без 13, 25, 37, 48)
        function createOuterPerimeter() {
            const outerSquares = document.getElementById('outerSquares');
            
            // Очищаем существующие клетки
            outerSquares.innerHTML = '';
            
            // Размер клетки и расстояние между ними
            const cellSize = 58; // Увеличенный размер клетки (+10% от 53px)
            const spacing = 1; // Расстояние между клетками 1px
            
            // Параметры квадрата
            const sideLength = 650;
            const totalCells = 44;
            const cellsPerSide = Math.floor(totalCells / 4); // 11 клеток на сторону
            
            // Создаем массив клеток с последовательной нумерацией от 1 до 44
            // Сдвигаем нумерацию влево на две позиции (1 -> 43, 2 -> 44, 3 -> 1, и т.д.)
            const cellNumbers = [];
            for (let i = 1; i <= totalCells; i++) {
                // Сдвигаем на две позиции влево: 1->43, 2->44, 3->1, 4->2, ..., 44->42
                const shiftedNumber = i <= 2 ? totalCells - 2 + i : i - 2;
                cellNumbers.push(shiftedNumber);
            }
            
            // Разделяем клетки по сторонам квадрата (сдвинутая нумерация на 2 позиции)
            const topCells = cellNumbers.slice(0, cellsPerSide); // 43, 44, 1-9
            const rightCells = cellNumbers.slice(cellsPerSide, cellsPerSide * 2); // 10-20
            const bottomCells = cellNumbers.slice(cellsPerSide * 2, cellsPerSide * 3); // 21-31
            const leftCells = cellNumbers.slice(cellsPerSide * 3, cellsPerSide * 4); // 32-42
            
            // Вычисляем размеры для центрирования
            const totalCellWidth = (cellsPerSide * cellSize) + ((cellsPerSide - 1) * spacing);
            const totalCellHeight = (cellsPerSide * cellSize) + ((cellsPerSide - 1) * spacing);
            
            // Вычисляем отступы для центрирования
            const offsetX = (sideLength - totalCellWidth) / 2;
            const offsetY = (sideLength - totalCellHeight) / 2;
            
            // Верхняя сторона - слева направо (начинаем с цифры 1)
            topCells.forEach((cellNumber, i) => {
                const cellData = getOuterCellDataNew(cellNumber);
                const square = createOuterCell(cellNumber, cellData);
                const x = offsetX + i * (cellSize + spacing);
                const y = offsetY;
                square.style.left = `${x}px`;
                square.style.top = `${y}px`;
                square.style.position = 'absolute';
                square.style.transform = 'translate(0, 0)';
                outerSquares.appendChild(square);
            });
            
            // Правая сторона - сверху вниз (отодвинута на 1 клетку вправо)
            rightCells.forEach((cellNumber, i) => {
                const cellData = getOuterCellDataNew(cellNumber);
                const square = createOuterCell(cellNumber, cellData);
                const x = offsetX + totalCellWidth - cellSize + (cellSize + spacing); // +1 клетка вправо
                const y = offsetY + i * (cellSize + spacing);
                square.style.left = `${x}px`;
                square.style.top = `${y}px`;
                square.style.position = 'absolute';
                square.style.transform = 'translate(0, 0)';
                outerSquares.appendChild(square);
            });
            
            // Нижняя сторона - справа налево
            bottomCells.forEach((cellNumber, i) => {
                const cellData = getOuterCellDataNew(cellNumber);
                const square = createOuterCell(cellNumber, cellData);
                const x = offsetX + totalCellWidth - cellSize - i * (cellSize + spacing);
                const y = offsetY + totalCellHeight - cellSize;
                square.style.left = `${x}px`;
                square.style.top = `${y}px`;
                square.style.position = 'absolute';
                square.style.transform = 'translate(0, 0)';
                outerSquares.appendChild(square);
            });
            
            // Левая сторона - снизу вверх (отодвинута на 1 клетку влево)
            leftCells.forEach((cellNumber, i) => {
                const cellData = getOuterCellDataNew(cellNumber);
                const square = createOuterCell(cellNumber, cellData);
                const x = offsetX - (cellSize + spacing); // -1 клетка влево
                const y = offsetY + totalCellHeight - cellSize - i * (cellSize + spacing);
                square.style.left = `${x}px`;
                square.style.top = `${y}px`;
                square.style.position = 'absolute';
                square.style.transform = 'translate(0, 0)';
                outerSquares.appendChild(square);
            });
            
            console.log(`✅ Создано ${totalCells} клеток по квадрату (сдвинутая нумерация на 2 позиции):`);
            console.log(`🔝 Верхняя сторона: ${topCells.join(', ')} (начинаем с цифры 43)`);
            console.log(`➡️ Правая сторона: ${rightCells.join(', ')}`);
            console.log(`🔽 Нижняя сторона: ${bottomCells.join(', ')}`);
            console.log(`⬅️ Левая сторона: ${leftCells.join(', ')}`);
            console.log(`🔄 Сдвинутая нумерация: 1->43, 2->44, 3->1, 4->2, ..., 44->42`);
        }

        // Создание внешней клетки
        function createOuterCell(cellNumber, cellData = null) {
            if (!cellData) {
                cellData = getOuterCellData(cellNumber);
            }
            const square = document.createElement('div');
            square.className = `outer-square ${getCellColorClass(cellData.type)}`;
            square.dataset.cell = cellNumber;
            square.onclick = () => showCellPopup(cellNumber);
            
            // Добавляем цифру
                const number = document.createElement('div');
                number.className = 'square-number';
            number.textContent = cellNumber;
                square.appendChild(number);
                
            // Добавляем иконку
                const icon = document.createElement('div');
                icon.className = 'square-icon';
            icon.textContent = cellData.icon;
                square.appendChild(icon);
                
            return square;
        }
        // Новые данные клеток согласно предоставленному списку
        function getOuterCellDataNew(cellNumber) {
            const cellData = {
                1: { name: "Вам выплачивается доход от ваших инвестиций", type: "Деньги", cost: 0, income: "Все пассивные доходы", description: "Получение дохода от ранее приобретенных активов", color: "yellow", icon: "💰" },
                2: { name: "Построить дом мечты для семьи", type: "Мечта", cost: 100000, income: 0, description: "Реализация мечты о собственном доме для семьи", color: "blue", icon: "🏠" },
                3: { name: "Кофейня в центре города", type: "Бизнес", cost: 100000, income: 3000, description: "Открытие кофейни в центре города", color: "green", icon: "☕" },
                4: { name: "Аудит", type: "Потеря", cost: 0, income: -0.5, description: "Аудит - потеря 50% активов", color: "red", icon: "📊" },
                5: { name: "Центр здоровья и спа", type: "Бизнес", cost: 270000, income: 5000, description: "Открытие центра здоровья и спа", color: "green", icon: "🧘" },
                6: { name: "Посетить Антарктиду", type: "Мечта", cost: 150000, income: 0, description: "Экстремальное путешествие на самый южный континент", color: "blue", icon: "❄️" },
                7: { name: "Мобильное приложение (подписка)", type: "Бизнес", cost: 420000, income: 10000, description: "Разработка мобильного приложения с подпиской", color: "green", icon: "📱" },
                8: { name: "Благотворительность", type: "Благотворительность", cost: 0, income: 0, description: "Помощь нуждающимся", color: "pink", icon: "❤️" },
                9: { name: "Агентство цифрового маркетинга", type: "Бизнес", cost: 160000, income: 4000, description: "Открытие агентства цифрового маркетинга", color: "green", icon: "📈" },
                10: { name: "Кража 100% наличных", type: "Потеря", cost: 0, income: -1, description: "Кража всех наличных денег", color: "red", icon: "💸" },
                11: { name: "Мини-отель/бутик-гостиница", type: "Бизнес", cost: 200000, income: 5000, description: "Открытие мини-отеля", color: "green", icon: "🏨" },
                12: { name: "Вам выплачивается доход от ваших инвестиций", type: "Деньги", cost: 0, income: "Все пассивные доходы", description: "Получение дохода от ранее приобретенных активов", color: "yellow", icon: "💰" },
                13: { name: "Франшиза популярного ресторана", type: "Бизнес", cost: 320000, income: 8000, description: "Покупка франшизы популярного ресторана", color: "green", icon: "🍽️" },
                14: { name: "Подняться на все высочайшие вершины мира", type: "Мечта", cost: 500000, income: 0, description: "Покорение всех высочайших вершин мира", color: "blue", icon: "🏔️" },
                15: { name: "Мини-отель/бутик-гостиница", type: "Бизнес", cost: 200000, income: 4000, description: "Открытие мини-отеля", color: "green", icon: "🏨" },
                16: { name: "Стать автором книги-бестселлера", type: "Мечта", cost: 300000, income: 0, description: "Написание и издание книги-бестселлера", color: "blue", icon: "📚" },
                17: { name: "Йога- и медитационный центр", type: "Бизнес", cost: 170000, income: 4500, description: "Открытие центра йоги и медитации", color: "green", icon: "🧘" },
                18: { name: "Развод", type: "Потеря", cost: 0, income: -0.5, description: "Развод - потеря 50% активов", color: "red", icon: "💔" },
                19: { name: "Сеть автомоек самообслуживания", type: "Бизнес", cost: 120000, income: 3000, description: "Открытие сети автомоек самообслуживания", color: "green", icon: "🚗" },
                20: { name: "Жить год на яхте в Средиземном море", type: "Мечта", cost: 300000, income: 0, description: "Год жизни на яхте в Средиземном море", color: "blue", icon: "⛵" },
                21: { name: "Салон красоты/барбершоп", type: "Бизнес", cost: 500000, income: 15000, description: "Открытие салона красоты/барбершопа", color: "green", icon: "💇" },
                22: { name: "Вам выплачивается доход от ваших инвестиций", type: "Деньги", cost: 0, income: "Все пассивные доходы", description: "Получение дохода от ранее приобретенных активов", color: "yellow", icon: "💰" },
                23: { name: "Онлайн-магазин одежды", type: "Бизнес", cost: 110000, income: 3000, description: "Открытие онлайн-магазина одежды", color: "green", icon: "👕" },
                24: { name: "Организовать мировой фестиваль", type: "Мечта", cost: 200000, income: 0, description: "Организация мирового фестиваля", color: "blue", icon: "🎪" },
                25: { name: "Пожар (вы теряете бизнес с мин доходом)", type: "Потеря", cost: 0, income: -1, description: "Пожар - потеря бизнеса с минимальным доходом", color: "red", icon: "🔥" },
                26: { name: "Построить ретрит-центр", type: "Мечта", cost: 500000, income: 0, description: "Строительство ретрит-центра", color: "blue", icon: "🏕️" },
                27: { name: "Создать фонд поддержки талантов", type: "Мечта", cost: 300000, income: 0, description: "Создание фонда поддержки талантов", color: "blue", icon: "🎭" },
                28: { name: "Кругосветное плавание на паруснике", type: "Мечта", cost: 200000, income: 0, description: "Кругосветное плавание на паруснике", color: "blue", icon: "⛵" },
                29: { name: "Туристический комплекс (эко-ранчо)", type: "Бизнес", cost: 1000000, income: 20000, description: "Открытие туристического комплекса", color: "green", icon: "🏞️" },
                30: { name: "Кругосветное плавание на паруснике", type: "Мечта", cost: 300000, income: 0, description: "Кругосветное плавание на паруснике", color: "blue", icon: "⛵" },
                31: { name: "Биржа (Разово выплачивается 500 000$ если выпало 5 или6 на кубике)", type: "Бизнес", cost: 50000, income: 500000, description: "Инвестиции в биржу с возможностью большого выигрыша", color: "green", icon: "📊" },
                32: { name: "Купить частный самолёт", type: "Мечта", cost: 1000000, income: 0, description: "Покупка частного самолета", color: "blue", icon: "✈️" },
                33: { name: "NFT-платформа", type: "Бизнес", cost: 400000, income: 12000, description: "Создание NFT-платформы", color: "green", icon: "🎨" },
                34: { name: "Кругосветное плавание на паруснике", type: "Деньги", cost: 200000, income: 0, description: "Кругосветное плавание на паруснике", color: "yellow", icon: "⛵" },
                35: { name: "Школа иностранных языков", type: "Бизнес", cost: 20000, income: 3000, description: "Открытие школы иностранных языков", color: "green", icon: "🌍" },
                36: { name: "Купить коллекцию суперкаров", type: "Мечта", cost: 1000000, income: 0, description: "Покупка коллекции суперкаров", color: "blue", icon: "🏎️" },
                37: { name: "Создать школу будущего для детей", type: "Бизнес", cost: 300000, income: 10000, description: "Создание школы будущего для детей", color: "green", icon: "🎓" },
                38: { name: "Снять полнометражный фильм", type: "Мечта", cost: 500000, income: 0, description: "Съемка полнометражного фильма", color: "blue", icon: "🎬" },
                39: { name: "Рейдерский захват (Вы теряете бизнес с крупным доходом)", type: "Потеря", cost: 0, income: -1, description: "Рейдерский захват - потеря бизнеса с крупным доходом", color: "red", icon: "⚔️" },
                40: { name: "Стать мировым лидером мнений", type: "Мечта", cost: 1000000, income: 0, description: "Стать мировым лидером мнений", color: "blue", icon: "👑" },
                41: { name: "Сеть автомоек самообслуживания", type: "Бизнес", cost: 120000, income: 3500, description: "Открытие сети автомоек самообслуживания", color: "green", icon: "🚗" },
                42: { name: "Белоснежная Яхта", type: "Мечта", cost: 300000, income: 0, description: "Покупка белоснежной яхты", color: "blue", icon: "⛵" },
                43: { name: "Франшиза \"поток денег\"", type: "Бизнес", cost: 100000, income: 10000, description: "Покупка франшизы \"поток денег\"", color: "green", icon: "💼" },
                44: { name: "Санкции заблокировали все счета", type: "Потеря", cost: 0, income: -1, description: "Санкции заблокировали все счета", color: "red", icon: "🚫" }
            };
            
            return cellData[cellNumber] || null;
        }
        // Создание внутреннего трека (24 квадрата) - ровный круг
        function createInnerTrack() {
            const innerSquares = document.getElementById('innerSquares');
            
            for (let i = 1; i <= 24; i++) {
                const cellIndex = i - 1; // 0-23
                const cellData = innerCellData[cellIndex];
                
                const square = document.createElement('div');
                square.className = `inner-square ${getCellColorClass(cellData.type)}`;
                square.dataset.cell = i; // Добавляем data-cell для позиционирования фишек (1-24)
                square.onclick = () => showCellPopup(i, true);
                
                // Ровное круговое позиционирование
                const angle = (i - 1) * (360 / 24) * (Math.PI / 180);
                let radius = 38.5; // фиксированный радиус для ровного круга (увеличен на 10%)
                
                // Поднимаем клетку 1 выше остальных
                if (i === 1) {
                    radius = 35; // Уменьшаем радиус для клетки 1
                    square.style.zIndex = '20'; // Выше всех остальных клеток
                }
                
                const x = 50 + radius * Math.cos(angle);
                const y = 50 + radius * Math.sin(angle);
                
                square.style.left = `${x}%`;
                square.style.top = `${y}%`;
                square.style.transform = 'translate(-50%, -50%)';
                
                // Добавляем цифру в угол
                const number = document.createElement('div');
                if (i === 24) {
                    // Клетка 24 - цифра в правый верхний угол
                    number.className = 'square-number top-right';
                } else if (i === 2) {
                    // Клетка 2 - цифра в правый нижний угол
                    number.className = 'square-number bottom-right';
                } else {
                number.className = i >= 11 ? 'square-number bottom-left' : 'square-number';
                }
                number.textContent = i;
                square.appendChild(number);
                
                // Добавляем иконку из данных клетки
                const icon = document.createElement('div');
                icon.className = 'square-icon';
                icon.textContent = cellData.icon;
                square.appendChild(icon);
                
                innerSquares.appendChild(square);
            }
        }

        // Функция для получения CSS класса цвета по типу клетки
        function getCellColorClass(type) {
            const colorMap = {
                'Старт': 'square-green',
                'Возможность': 'square-green',
                'Трата': 'square-pink',
                'Благотворительность': 'square-charity',
                'PayDay': 'square-yellow',
                'Рынок': 'square-blue',
                'Ребенок': 'square-purple',
                'Потеря': 'square-black',
                'Деньги': 'square-yellow',
                'Мечта': 'square-blue',
                'Бизнес': 'square-green',
                'Доход': 'square-green',
                'Расход': 'square-red',
                'Инвестиция': 'square-purple',
                'Недвижимость': 'square-orange',
                'Образование': 'square-cyan',
                'Страхование': 'square-pink',
                'Кредит': 'square-red',
                'Пенсия': 'square-blue',
                'Путешествие': 'square-orange',
                'Пустая': 'square-gray',
                'Финиш': 'square-gold'
            };
            return colorMap[type] || 'square-gray';
        }

        // Функция для проверки всех клеток малого круга
        function validateInnerCells() {
            console.log('🔍 Проверка клеток малого круга:');
            const missingCells = [];
            const duplicateTypes = {};
            
            for (let i = 0; i < 24; i++) {
                if (!innerCellData[i]) {
                    missingCells.push(i);
                } else {
                    const type = innerCellData[i].type;
                    if (!duplicateTypes[type]) {
                        duplicateTypes[type] = [];
                    }
                    duplicateTypes[type].push(i);
                }
            }
            
            if (missingCells.length > 0) {
                console.error('❌ Отсутствующие клетки:', missingCells);
            } else {
                console.log('✅ Все 24 клетки определены');
            }
            
            // Проверяем дублирование типов
            Object.keys(duplicateTypes).forEach(type => {
                if (duplicateTypes[type].length > 1) {
                    console.log(`📊 Тип "${type}": клетки ${duplicateTypes[type].join(', ')}`);
                }
            });
            
            return { missingCells, duplicateTypes };
        }
        // Функция для получения данных внешней клетки (46 клеток: 25-70)
        function getOuterCellData(cellNumber) {
            const outerCellData = {
                1: { name: "Вам выплачивается доход от ваших инвестиций", type: "Деньги", cost: 0, income: "Все пассивные доходы", description: "Получение дохода от ранее приобретенных активов", color: "yellow", icon: "💰" },
                2: { name: "Построить дом мечты для семьи", type: "Мечта", cost: 100000, income: 0, description: "Реализация мечты о собственном доме для семьи", color: "blue", icon: "🏠" },
                3: { name: "Кофейня в центре города", type: "Бизнес", cost: 100000, income: 3000, description: "Открытие кофейни в центре города", color: "green", icon: "☕" },
                4: { name: "Аудит", type: "Потеря", cost: 0, income: -0.5, description: "Аудит - потеря 50% активов", color: "red", icon: "📊" },
                5: { name: "Центр здоровья и спа", type: "Бизнес", cost: 270000, income: 5000, description: "Открытие центра здоровья и спа", color: "green", icon: "🧘" },
                6: { name: "Посетить Антарктиду", type: "Мечта", cost: 150000, income: 0, description: "Экстремальное путешествие на самый южный континент", color: "blue", icon: "❄️" },
                7: { name: "Мобильное приложение (подписка)", type: "Бизнес", cost: 420000, income: 10000, description: "Разработка мобильного приложения с подпиской", color: "green", icon: "📱" },
                8: { name: "Благотворительность", type: "Благотворительность", cost: 0, income: 0, description: "Помощь нуждающимся", color: "pink", icon: "❤️" },
                9: { name: "Агентство цифрового маркетинга", type: "Бизнес", cost: 160000, income: 4000, description: "Открытие агентства цифрового маркетинга", color: "green", icon: "📈" },
                10: { name: "Кража 100% наличных", type: "Потеря", cost: 0, income: -1, description: "Кража всех наличных денег", color: "red", icon: "💸" },
                11: { name: "Мини-отель/бутик-гостиница", type: "Бизнес", cost: 200000, income: 5000, description: "Открытие мини-отеля", color: "green", icon: "🏨" },
                12: { name: "Вам выплачивается доход от ваших инвестиций", type: "Деньги", cost: 0, income: "Все пассивные доходы", description: "Получение дохода от ранее приобретенных активов", color: "yellow", icon: "💰" },
                13: { name: "Франшиза популярного ресторана", type: "Бизнес", cost: 320000, income: 8000, description: "Покупка франшизы популярного ресторана", color: "green", icon: "🍽️" },
                14: { name: "Подняться на все высочайшие вершины мира", type: "Мечта", cost: 500000, income: 0, description: "Покорение всех высочайших вершин мира", color: "blue", icon: "🏔️" },
                15: { name: "Мини-отель/бутик-гостиница", type: "Бизнес", cost: 200000, income: 4000, description: "Открытие мини-отеля", color: "green", icon: "🏨" },
                16: { name: "Стать автором книги-бестселлера", type: "Мечта", cost: 300000, income: 0, description: "Написание и издание книги-бестселлера", color: "blue", icon: "📚" },
                17: { name: "Йога- и медитационный центр", type: "Бизнес", cost: 170000, income: 4500, description: "Открытие центра йоги и медитации", color: "green", icon: "🧘" },
                18: { name: "Развод", type: "Потеря", cost: 0, income: -0.5, description: "Развод - потеря 50% активов", color: "red", icon: "💔" },
                19: { name: "Сеть автомоек самообслуживания", type: "Бизнес", cost: 120000, income: 3000, description: "Открытие сети автомоек самообслуживания", color: "green", icon: "🚗" },
                20: { name: "Жить год на яхте в Средиземном море", type: "Мечта", cost: 300000, income: 0, description: "Год жизни на яхте в Средиземном море", color: "blue", icon: "⛵" },
                21: { name: "Салон красоты/барбершоп", type: "Бизнес", cost: 500000, income: 15000, description: "Открытие салона красоты/барбершопа", color: "green", icon: "💇" },
                22: { name: "Создать фонд поддержки талантов", type: "Мечта", cost: 300000, income: 0, description: "Создание фонда поддержки талантов", color: "blue", icon: "🎭" },
                23: { name: "Онлайн-магазин одежды", type: "Бизнес", cost: 110000, income: 3000, description: "Открытие онлайн-магазина одежды", color: "green", icon: "👕" },
                24: { name: "Организовать мировой фестиваль", type: "Мечта", cost: 200000, income: 0, description: "Организация мирового фестиваля", color: "blue", icon: "🎪" },
                25: { name: "Пожар (вы теряете бизнес с мин доходом)", type: "Потеря", cost: 0, income: -1, description: "Пожар - потеря бизнеса с минимальным доходом", color: "red", icon: "🔥" },
                26: { name: "Построить ретрит-центр", type: "Мечта", cost: 500000, income: 0, description: "Строительство ретрит-центра", color: "blue", icon: "🏕️" },
                27: { name: "Вам выплачивается доход от ваших инвестиций", type: "Деньги", cost: 0, income: "Все пассивные доходы", description: "Получение дохода от ранее приобретенных активов", color: "yellow", icon: "💰" },
                28: { name: "Кругосветное плавание на паруснике", type: "Мечта", cost: 200000, income: 0, description: "Кругосветное плавание на паруснике", color: "blue", icon: "⛵" },
                29: { name: "Туристический комплекс (эко-ранчо)", type: "Бизнес", cost: 1000000, income: 20000, description: "Открытие туристического комплекса", color: "green", icon: "🏞️" },
                30: { name: "Кругосветное плавание на паруснике", type: "Мечта", cost: 300000, income: 0, description: "Кругосветное плавание на паруснике", color: "blue", icon: "⛵" },
                31: { name: "Биржа (Разово выплачивается 500 000$ если выпало 5 или6 на кубике)", type: "Бизнес", cost: 50000, income: 500000, description: "Инвестиции в биржу с возможностью большого выигрыша", color: "green", icon: "📊" },
                32: { name: "Купить частный самолёт", type: "Мечта", cost: 1000000, income: 0, description: "Покупка частного самолета", color: "blue", icon: "✈️" },
                33: { name: "NFT-платформа", type: "Бизнес", cost: 400000, income: 12000, description: "Создание NFT-платформы", color: "green", icon: "🎨" },
                34: { name: "Кругосветное плавание на паруснике", type: "Деньги", cost: 200000, income: 0, description: "Кругосветное плавание на паруснике", color: "yellow", icon: "⛵" },
                35: { name: "Школа иностранных языков", type: "Бизнес", cost: 20000, income: 3000, description: "Открытие школы иностранных языков", color: "green", icon: "🌍" },
                36: { name: "Купить коллекцию суперкаров", type: "Мечта", cost: 1000000, income: 0, description: "Покупка коллекции суперкаров", color: "blue", icon: "🏎️" },
                37: { name: "Создать школу будущего для детей", type: "Бизнес", cost: 300000, income: 10000, description: "Создание школы будущего для детей", color: "green", icon: "🎓" },
                38: { name: "Снять полнометражный фильм", type: "Мечта", cost: 500000, income: 0, description: "Съемка полнометражного фильма", color: "blue", icon: "🎬" },
                39: { name: "Рейдерский захват (Вы теряете бизнес с крупным доходом)", type: "Потеря", cost: 0, income: -1, description: "Рейдерский захват - потеря бизнеса с крупным доходом", color: "red", icon: "⚔️" },
                40: { name: "Стать мировым лидером мнений", type: "Мечта", cost: 1000000, income: 0, description: "Стать мировым лидером мнений", color: "blue", icon: "👑" },
                41: { name: "Сеть автомоек самообслуживания", type: "Бизнес", cost: 120000, income: 3500, description: "Открытие сети автомоек самообслуживания", color: "green", icon: "🚗" },
                42: { name: "Белоснежная Яхта", type: "Мечта", cost: 300000, income: 0, description: "Покупка белоснежной яхты", color: "blue", icon: "⛵" },
                43: { name: "Франшиза \"поток денег\"", type: "Бизнес", cost: 100000, income: 10000, description: "Покупка франшизы \"поток денег\"", color: "green", icon: "💼" },
                44: { name: "Санкции заблокировали все счета", type: "Потеря", cost: 0, income: -1, description: "Санкции заблокировали все счета", color: "red", icon: "🚫" },
                45: { name: "Пекарня с доставкой", type: "Бизнес", cost: 300000, income: 7000, description: "Открытие пекарни с доставкой", color: "green", icon: "🥖" },
                46: { name: "Организовать благотворительный фонд", type: "Мечта", cost: 200000, income: 0, description: "Организация благотворительного фонда", color: "blue", icon: "🤝" },
                47: { name: "Онлайн-образовательная платформа", type: "Бизнес", cost: 200000, income: 5000, description: "Создание онлайн-образовательной платформы", color: "green", icon: "💻" },
                48: { name: "Полёт в космос", type: "Мечта", cost: 250000, income: 0, description: "Полёт в космос", color: "blue", icon: "🚀" }
            };
            
            return outerCellData[cellNumber] || {
                name: `Клетка ${cellNumber}`,
                type: "Пустая",
                cost: 0,
                income: 0,
                description: `Описание клетки ${cellNumber}`,
                color: "gray",
                icon: "⚪"
            };
        }
        // Бросок кубика
        async function rollDice() {
            if (isRolling) return;
            
            // Проверяем, что это ход текущего игрока
            const roomId = getRoomIdFromURL();
            if (!roomId) return;

            const user = localStorage.getItem('user');
            if (!user) return;
            
            const userData = JSON.parse(user);
            
            // Получаем информацию о ходе
            const turnResponse = await fetch(`/api/rooms/${roomId}/turn`);
            const turnData = await turnResponse.json();
            
            if (turnResponse.ok) {
                // Получаем информацию о игроках
                const playersResponse = await fetch(`/api/rooms/${roomId}?user_id=${userData.id}`);
                const playersData = await playersResponse.json();
                
                if (playersResponse.ok && playersData.players) {
                    const playerIndex = playersData.players.findIndex(p => p.user_id.toString() === userData.id);
                    if (playerIndex !== turnData.current_player) {
                        alert('Не ваш ход!');
                        return;
                    }
                }
            }
            
            isRolling = true;
            diceRolled = true;
            const dice = document.getElementById('dice');
            const rollDiceBtn = document.getElementById('rollDiceBtn');
            
            // Сразу делаем кнопку недоступной и меняем текст
            rollDiceBtn.disabled = true;
            rollDiceBtn.innerHTML = '<span>🎲</span><span>Кубик брошен</span>';
            rollDiceBtn.style.opacity = '0.5';

            // Определяем количество кубиков (с учётом благотворительности)
            const diceCount = (fastTrackDiceChoice[currentPlayer] || (playerTracks[currentPlayer] === 'outer' ? 1 : 1));
            // Запрашиваем значение кубика у сервера
            try {
                const rollResp = await fetch(`/api/rooms/${roomId}/roll-dice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_index: currentPlayer, dice_count: diceCount })
                });
                const rollData = await rollResp.json();
                if (!rollResp.ok || !rollData.success) {
                    alert('Ошибка броска кубика');
                    isRolling = false;
                    diceRolled = false;
                    rollDiceBtn.disabled = false;
                    rollDiceBtn.innerHTML = '<span>🎲</span><span>Бросить кубик</span>';
                    rollDiceBtn.style.opacity = '1';
                    return;
                }
                const finalValue = rollData.dice_value;
                // Короткая анимация и показ результата
                dice.classList.add('rolling');
                await new Promise(r => setTimeout(r, 500));
                    dice.classList.remove('rolling');
                dice.textContent = finalValue;

                // Двигаем локально
                await movePlayerToken(finalValue);

                // Сохраняем ход на сервере (для восстановления состояния)
                const user = localStorage.getItem('user');
                if (user) {
                    const userData = JSON.parse(user);
                    await fetch(`/api/rooms/${roomId}/move`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userData.id, steps: finalValue })
                    });
                }

                isRolling = false;
                    turnTransitionTimeout = setTimeout(() => {
                        updateRollButton();
                    }, 10000);
            } catch (e) {
                console.error('Roll error:', e);
                isRolling = false;
                diceRolled = false;
                rollDiceBtn.disabled = false;
                rollDiceBtn.innerHTML = '<span>🎲</span><span>Бросить кубик</span>';
                rollDiceBtn.style.opacity = '1';
                }
        }

        function updateRollButton() {
            const rollDiceBtn = document.getElementById('rollDiceBtn');
            if (diceRolled) {
                rollDiceBtn.innerHTML = '<span>⏭️</span><span>Переход хода</span>';
                rollDiceBtn.disabled = false;
                rollDiceBtn.style.opacity = '1';
                rollDiceBtn.onclick = () => {
                    nextPlayer();
                };
                isRolling = false; // Сбрасываем флаг броска для кнопки "Переход хода"
            }
        }
        // Перемещение фишки игрока
        async function movePlayerToken(steps) {
            const playerToken = document.getElementById(`player${currentPlayer}`);
            if (!playerToken) {
                console.error(`Player token ${currentPlayer} not found`);
                return;
            }
            
            console.log(`🎲 Перемещение игрока ${currentPlayer} на ${steps} клеток`);
            
            // Получаем текущую позицию
            const currentPosition = playerPositions[currentPlayer] || 1; // Начинаем с клетки 1
            const track = playerTracks[currentPlayer] || 'inner';
            
            // Определяем размер трека
            const trackSize = track === 'inner' ? 24 : 44;
            const newPosition = ((currentPosition - 1 + steps) % trackSize) + 1;
            
            console.log(`📍 Текущая позиция: ${currentPosition}, новая позиция: ${newPosition}`);
            
            // Анимированное перемещение по шагам
            for (let i = 1; i <= steps; i++) {
                const stepPosition = ((currentPosition - 1 + i) % trackSize) + 1;
                
                await animateTokenToCell(playerToken, stepPosition, i === steps, track);
                
                // Задержка 0.5 секунды между клетками
                if (i < steps) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            // Обновляем позицию
            playerPositions[currentPlayer] = newPosition;

            // Проверяем условия перехода на большой круг
            try {
                // Условие: дивиденды/пассивный доход игрока превышают расходы (НЕ зарплата)
                const passive = (playerPassiveIncome && playerPassiveIncome[currentPlayer]) ? playerPassiveIncome[currentPlayer] : 0;
                if (track === 'inner' && totalCredit === 0 && passive > monthlyExpenses) {
                    playerTracks[currentPlayer] = 'outer';
                    showNotification('🎉 Вы перешли на Большой круг! Пассивный доход превышает расходы и кредиты погашены.', 'success');
                }
            } catch (e) {
                console.warn('Не удалось проверить условия перехода на большой круг:', e);
            }
            
            // Показываем информацию о клетке
                setTimeout(() => {
                    const track = playerTracks[currentPlayer] || 'inner';
                    showCellPopup(newPosition, track === 'inner');
                }, 500);
            
            console.log(`✅ Игрок ${currentPlayer} перемещен на клетку ${newPosition}`);

            // Спец-событие: Ребенок (малый круг)
            try {
                if (track === 'inner') {
                    const innerCell = innerCellData[newPosition - 1];
                    if (innerCell && innerCell.type === 'Ребенок') {
                        await handleChildEvent();
                    }
                }
            } catch (e) { console.warn('Child event error:', e); }
        }
        // Обработка события "Ребенок" на малом круге
        async function handleChildEvent() {
            const roomId = getRoomIdFromURL();
            if (!roomId) return;
            try {
                // Бросаем один кубик на сервере: 1-4 ребенок родился; 5-6 нет
                const resp = await fetch(`/api/rooms/${roomId}/roll-dice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_index: currentPlayer, dice_count: 1 })
                });
                const data = await resp.json();
                if (!resp.ok || !data.success) return;
                const value = data.dice_value;
                if (value >= 1 && value <= 4) {
                    // Ребенок родился
                    monthlyExpenses += CHILD_MONTHLY_COST;
                    expensesBreakdown.base += CHILD_MONTHLY_COST;
                    currentBalance += 5000; // разовая выплата
                    updateFinancesDisplay();
                    updateBalanceDisplay();
                    showCelebration(`🎉 Поздравляем! У вас родился ребенок. +$5,000 разово и +$${CHILD_MONTHLY_COST.toLocaleString()}/мес к расходам.`);
                } else {
                    showNotification('👶 Ребенок не родился (выпало 5 или 6).', 'info');
                }
            } catch (e) {
                console.warn('Child roll error:', e);
            }
        }
        // Простая анимация конфетти + модальное поздравление
        function showCelebration(message) {
            try {
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.inset = '0';
                overlay.style.zIndex = '2000';
                overlay.style.pointerEvents = 'none';
                document.body.appendChild(overlay);

                // Конфетти
                for (let i = 0; i < 80; i++) {
                    const span = document.createElement('span');
                    span.textContent = '🎉';
                    span.style.position = 'absolute';
                    span.style.left = Math.random() * 100 + 'vw';
                    span.style.top = '-5vh';
                    span.style.fontSize = (12 + Math.random() * 16) + 'px';
                    span.style.transition = 'transform 2.5s linear, opacity 2.5s linear';
                    overlay.appendChild(span);
                    requestAnimationFrame(() => {
                        span.style.transform = `translateY(${110 + Math.random() * 20}vh) rotate(${(Math.random()*720-360)}deg)`;
                        span.style.opacity = '0.8';
                    });
                }

                // Сообщение
                showNotification(message, 'success');
                setTimeout(() => overlay.remove(), 2600);
            } catch (_) {
                alert(message);
            }
        }

        // Анимация перемещения фишки к клетке
        async function animateTokenToCell(token, cellNumber, isLastStep = false, track = 'inner') {
            return new Promise((resolve) => {
                // Для inner и outer оба используют data-cell, но набор клеток разный.
                // На внутреннем круге data-cell 1..24 находятся в .inner-squares.
                // На внешнем – 1..44 находятся в .outer-squares (после наших преобразований нумерация 1..44).
                let targetCell = track === 'inner'
                    ? document.querySelector(`.inner-squares [data-cell="${cellNumber}"]`)
                    : document.querySelector(`.outer-squares [data-cell="${cellNumber}"]`);
                if (!targetCell) {
                    console.warn(`Клетка ${cellNumber} не найдена`);
                    resolve();
                return;
            }
            
                const cellRect = targetCell.getBoundingClientRect();
                const boardRect = document.querySelector('.game-board').getBoundingClientRect();
                const playerIndex = parseInt(token.id.replace('player',''), 10);
                const { x: offsetX, y: offsetY } = getTokenOffsetForPlayer(playerIndex, cellNumber, cellRect.width);

                const x = cellRect.left - boardRect.left + cellRect.width / 2 + offsetX;
                const y = cellRect.top - boardRect.top + cellRect.height / 2 + offsetY;

                // Анимация перемещения
                token.style.transition = 'all 0.3s ease';
                token.style.left = `${x - 20}px`;
                token.style.top = `${y - 20}px`;

                // Эффект прыжка на последнем шаге
                if (isLastStep) {
                    token.style.transform = 'scale(1.2)';
            setTimeout(() => {
                        token.style.transform = 'scale(1)';
                    }, 150);
                }

                setTimeout(resolve, 300);
            });
        }
        // Переход хода через сервер
        async function nextTurn() {
            try {
                const roomId = getRoomIdFromURL();
                if (!roomId) return;

                const user = localStorage.getItem('user');
                if (!user) return;
                
                const userData = JSON.parse(user);
                const response = await fetch(`/api/rooms/${roomId}/next-turn`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userData.id
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Получаем информацию о игроках для проверки
                    const playersResponse = await fetch(`/api/rooms/${roomId}?user_id=${userData.id}`);
                    const playersData = await playersResponse.json();
                    
                    if (playersResponse.ok && playersData.players && playersData.players.length > 0) {
                        // Проверяем, что новый current_player в пределах массива игроков
                        if (data.current_player >= 0 && data.current_player < playersData.players.length) {
                            // Обновляем текущего игрока и таймер
                            currentPlayer = data.current_player;
                            gameTimer = data.turn_duration;
                            maxTimer = data.turn_duration;
                            
                            // Увеличиваем номер хода
                            currentTurn++;
                            
                            // Обновляем UI
                            updateCurrentPlayer();
                            updateTimerDisplay();
                            resetRollButton();
                        } else {
                            console.warn('New current_player out of bounds:', data.current_player, 'Players count:', playersData.players.length);
                        }
                    }
                } else {
                    console.error('Error passing turn:', data.message);
                }
            } catch (error) {
                console.error('Error in nextTurn:', error);
            }
        }

        // Смена игрока (устаревшая функция, теперь используем nextTurn)
        async function nextPlayer() {
            await nextTurn();
        }

        function resetRollButton() {
            const rollDiceBtn = document.getElementById('rollDiceBtn');
            rollDiceBtn.innerHTML = '<span>🎲</span><span>Бросить кубик</span>';
            rollDiceBtn.onclick = rollDice;
            rollDiceBtn.disabled = false;
            rollDiceBtn.style.opacity = '1';
            diceRolled = false;
            isRolling = false; // Сбрасываем флаг броска
        }
        // Обновление информации о текущем игроке
        async function updateCurrentPlayer() {
            try {
                const roomId = getRoomIdFromURL();
                if (!roomId) return;

                const user = localStorage.getItem('user');
                if (!user) return;
                
                const userData = JSON.parse(user);
                const response = await fetch(`/api/rooms/${roomId}?user_id=${userData.id}`);
                
                if (!response.ok) {
                    console.warn('Failed to load room data for updateCurrentPlayer:', response.status);
                    return;
                }
                const data = await response.json();
                
                if (response.ok && data.players && data.players.length > 0) {
                    // Находим индекс текущего пользователя в массиве игроков
                    const currentUserIndex = data.players.findIndex(player => player.user_id.toString() === userData.id);
                    const isCurrentUserTurn = currentUserIndex === currentPlayer;
                    
                    // Управляем кнопкой броска кубика
                    const rollDiceBtn = document.getElementById('rollDiceBtn');
                    if (rollDiceBtn) {
                        if (isCurrentUserTurn) {
                            // Показываем кнопку броска кубика для текущего игрока
                            rollDiceBtn.style.display = 'flex';
                            // Если кубик уже брошен, кнопка остается недоступной
                            if (!diceRolled) {
                                rollDiceBtn.disabled = false;
                                rollDiceBtn.style.opacity = '1';
                            }
                        } else {
                            // Скрываем кнопку для других игроков
                            rollDiceBtn.style.display = 'none';
                        }
                    }
                    
                    // Проверяем, что currentPlayer в пределах массива игроков
                    if (currentPlayer >= 0 && currentPlayer < data.players.length) {
                        const currentPlayerData = data.players[currentPlayer];
                        const currentPlayerInfo = document.getElementById('currentPlayerInfo');
                        
                        if (currentPlayerData && currentPlayerInfo) {
                            // Получаем баланс текущего игрока
                            let playerBalance = 0;
                            if (data.game_data && data.game_data.player_balances && data.game_data.player_balances[currentPlayer] !== undefined) {
                                playerBalance = data.game_data.player_balances[currentPlayer];
                            }
                            
                            currentPlayerInfo.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div class="player-avatar player-${currentPlayer + 1}" style="width: 20px; height: 20px; font-size: 10px;">${currentPlayer + 1}</div>
                                    <div>
                                        <div style="font-weight: bold;">${currentPlayerData.name || `Игрок ${currentPlayer + 1}`}</div>
                                        <div style="font-size: 12px; color: #94a3b8;">Предприниматель</div>
                                    </div>
                                </div>
                                <div style="font-size: 14px; font-weight: bold; color: #10b981;">$${playerBalance.toLocaleString()}</div>
                            `;
                        }
                    } else {
                        console.warn('Current player index out of bounds:', currentPlayer, 'Players count:', data.players.length);
                    }
                }
            } catch (error) {
                console.error('Error updating current player:', error);
            }
        }

        // Открытие банка теперь в банковском модуле

        // Просмотр деталей заменен кнопкой "Кредит" (см. openCreditModal)

        // Обновление баланса банка теперь в банковском модуле

        // Таймер хода
        function startTimer() {
            // Очищаем предыдущий таймер если он есть
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            gameTimer = maxTimer;
            diceRolled = false;
            warningSoundPlayed = false;
            clearTimeout(turnTransitionTimeout);
            
            console.log('Starting timer for player', currentPlayer, 'with', gameTimer, 'seconds');
            
            timerInterval = setInterval(() => {
                gameTimer--;
                updateTimerDisplay();
                
                if (gameTimer <= 0) {
                    clearInterval(timerInterval);
                    // Не вызываем nextPlayer() здесь - сервер сам управляет переходами
                    console.log('Timer expired, waiting for server to handle turn transition');
                }
            }, 1000);
        }

        function resetTimer() {
            gameTimer = maxTimer;
            diceRolled = false;
            warningSoundPlayed = false;
            clearTimeout(turnTransitionTimeout);
            updateTimerDisplay();
        }
        function updateTimerDisplay() {
            const minutes = Math.floor(gameTimer / 60);
            const seconds = gameTimer % 60;
            const maxMinutes = Math.floor(maxTimer / 60);
            const maxSeconds = maxTimer % 60;
            const percentage = maxTimer > 0 ? (gameTimer / maxTimer) * 100 : 0;
            
            const timerFill = document.getElementById('timerFill');
            const timerText = document.getElementById('timerText');
            
            // Обновляем текст
            timerText.textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')} / ${maxMinutes}:${maxSeconds.toString().padStart(2, '0')}`;
            
            // Обновляем прогресс-бар
            timerFill.style.width = `${percentage}%`;
            
            // Цветовая индикация
            timerFill.classList.remove('warning', 'danger');
            
            if (gameTimer <= 20) {
                // Последние 20 секунд - красный + сигнал
                timerFill.classList.add('danger');
                if (!warningSoundPlayed) {
                    playWarningSound();
                    warningSoundPlayed = true;
                }
            } else if (gameTimer <= 60) {
                // Вторая минута - желтый
                timerFill.classList.add('warning');
            }
            // Первая минута - зеленый (по умолчанию)
        }

        function playWarningSound() {
            // Создаем звуковой сигнал
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (error) {
                console.log('Audio not supported:', error);
            }
        }

        // Обработчики событий
        document.getElementById('rollDiceBtn').addEventListener('click', rollDice);
        
        // Обработчик клика на кнопку активов
        document.addEventListener('DOMContentLoaded', () => {
            const assetsButton = document.querySelector('.assets-button');
            if (assetsButton) {
                assetsButton.addEventListener('click', showPlayerAssets);
            }
        });

        // Функции для работы с модальным окном клетки





        // Обработка клеток потерь


        // Вспомогательные функции для работы с балансом
        async function addBalance(amount, description) {
            currentBalance = (currentBalance || 0) + amount;
            try {
                // Синхронизируем через банк (перезагрузка данных банка)
                if (window.bankModule?.loadBankData) {
                    await window.bankModule.loadBankData(true);
                }
            } catch {}
            updateBalanceDisplay();
        }
        async function subtractBalance(amount, description) {
            currentBalance = Math.max(0, (currentBalance || 0) - amount);
            try {
                if (window.bankModule?.loadBankData) {
                    await window.bankModule.loadBankData(true);
                }
            } catch {}
            updateBalanceDisplay();
        }

        function updateBalanceDisplay() {
            // Обновляем отображение баланса в UI
            const balanceElements = document.querySelectorAll('#bankBalance, .balance-amount');
            balanceElements.forEach(el => {
                if (el) el.textContent = `$${(currentBalance || 0).toLocaleString()}`;
            });
        }

        function closeCellModal() {
            document.getElementById('cellModal').style.display = 'none';
        }
        function buyCell(cellNumber) {
            const cell = cellData[cellNumber];
            if (!cell || cell.cost <= 0) return;

            // Определяем тип клетки и вызываем соответствующую функцию
            if (cell.type === 'Бизнес') {
                const success = buyBusiness(cellNumber, currentPlayer);
                if (success) {
                    // Обновляем отображение владельца
                    document.getElementById('cellOwner').textContent = `Игрок ${currentPlayer + 1}`;
                    document.getElementById('buyButton').style.display = 'none';
                    
                    // Обновляем визуальное отображение клетки
                    updateCellDisplay(cellNumber);
                    
                    // Проверяем условия победы
                    checkWinConditions(currentPlayer);
                }
            } else if (cell.type === 'Мечта') {
                const success = buyDream(cellNumber, currentPlayer);
                if (success) {
                    // Обновляем отображение владельца
                    document.getElementById('cellOwner').textContent = `Игрок ${currentPlayer + 1}`;
                    document.getElementById('buyButton').style.display = 'none';
                    
                    // Обновляем визуальное отображение клетки
                    updateCellDisplay(cellNumber);
                    
                    // Проверяем условия победы
                    checkWinConditions(currentPlayer);
                }
            } else {
                // Для других типов клеток (доходы, потери и т.д.)
                alert(`Клетка "${cell.name}" не может быть куплена.`);
            }
        }

        function updateCellDisplay(cellNumber) {
            const square = document.querySelector(`[data-cell-number="${cellNumber}"]`);
            if (!square) return;

            const owner = cellOwners[cellNumber];
            if (owner) {
                // Добавляем индикатор владельца
                square.style.border = '2px solid #10b981';
                square.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.5)';
            }
        }

        // Закрытие модального окна при клике вне его
        window.onclick = function(event) {
            const modal = document.getElementById('cellModal');
            if (event.target === modal) {
                closeCellModal();
            }
        }

        // Функция выхода из игры
        function exitGame() {
            if (confirm('Вы уверены, что хотите выйти из игры? Ваш прогресс будет потерян.')) {
                // Получаем ID комнаты из URL
                const roomId = getRoomIdFromURL();
                
                if (roomId) {
                    // Перенаправляем в лобби
                    window.location.href = '/lobby';
                } else {
                    // Если нет ID комнаты, перенаправляем на главную
                    window.location.href = '/';
                }
            }
        }

        // Загрузка данных игроков из комнаты
        async function loadRoomPlayers() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const roomId = urlParams.get('room');
                
                if (!roomId) return;
                
                // Получаем данные пользователя
                const currentUser = JSON.parse(localStorage.getItem('user'));
                const userId = currentUser && (currentUser.id || currentUser._id);
                if (!userId) return;
                
                const response = await fetch(`/api/rooms/${roomId}?user_id=${userId}`);
                const roomData = await response.json();
                
                if (response.ok && roomData.players) {
                    updatePlayersList(roomData.players, currentPlayer);
                }
            } catch (error) {
                console.error('Error loading room players:', error);
            }
        }
        // Обновление списка игроков
        function updatePlayersList(players, currentPlayerIndex = 0) {
            const playersList = document.querySelector('.players-list');
            if (!playersList) return;
            
            // Очищаем существующий список
            playersList.innerHTML = '';
            
            players.forEach((player, index) => {
                const isCurrentPlayer = index === currentPlayerIndex;
                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${isCurrentPlayer ? 'current' : ''}`;
                playerItem.id = `player${index + 1}Item`;
                
                // Определяем статус игрока
                let statusIcon, statusText, statusClass;
                if (isCurrentPlayer) {
                    statusIcon = '🎲';
                    statusText = 'Ваш ход';
                    statusClass = 'status-your-turn';
                } else {
                    statusIcon = '⏳';
                    statusText = 'Ожидание';
                    statusClass = 'status-waiting-turn';
                }
                
                playerItem.innerHTML = `
                    <div class="player-avatar player-${index + 1}">${index + 1}</div>
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-role">${player.profession || 'Предприниматель'}</div>
                    </div>
                    <div class="player-status ${statusClass}">
                        <span>${statusIcon}</span>
                        <span>${statusText}</span>
                    </div>
                `;
                
                // Открываем карточку игрока по клику
                playerItem.style.cursor = 'pointer';
                playerItem.onclick = () => openPlayerProfile(index, player);

                playersList.appendChild(playerItem);
            });
            
            // Обновляем информацию о текущем игроке
            if (players[currentPlayerIndex]) {
                updateCurrentPlayerInfo(players[currentPlayerIndex]);
            }
        }

        // Обновление информации о текущем игроке
        function updateCurrentPlayerInfo(player) {
            const currentPlayerInfo = document.getElementById('currentPlayerInfo');
            if (!currentPlayerInfo || !player) return;
            
            // Находим номер игрока (индекс + 1)
            const playerNumber = currentPlayer + 1;
            
            // Баланс берется из game_data, не из player.balance
            // Bank logic removed
            
            currentPlayerInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <div class="player-avatar player-${playerNumber}" style="width: 20px; height: 20px; font-size: 10px;">${playerNumber}</div>
                    <div>
                        <div style="font-weight: bold;">${player.name}</div>
                        <div style="font-size: 12px; color: #94a3b8;">${player.profession || 'Предприниматель'}</div>
                    </div>
                </div>
                <div style="font-size: 14px; font-weight: bold; color: #10b981;">$0</div>
            `;
        }

        // Банковские переменные теперь в банковском модуле

        // Профиль игрока (модалка)
        function openPlayerProfile(index, playerData) {
            openPlayerProfileModal(index);
        }
        // Банковские функции теперь в банковском модуле
        // resetTransferForm() - перенесено в bank-module/bank.js


        function buyBusiness(cellNumber, playerIndex) {
            const cell = cellData[cellNumber];
            if (!cell || cell.type !== 'Бизнес') return false;
            
            const currentOwner = cellOwners[cellNumber];
            let cost = cell.cost;
            
            if (currentOwner && currentOwner !== playerIndex) {
                // Перекупка - цена в 2 раза выше
                cost = cell.cost * 2;
            }
            
            if (0 < cost) {
                alert(`Недостаточно средств для покупки. Нужно: $${cost.toLocaleString()}`);
                return false;
            }
            
            // Списываем средства
            // Bank logic removed
            
            // Если был предыдущий владелец, он теряет доход
            if (currentOwner && currentOwner !== playerIndex) {
                const previousOwnerIncome = playerPassiveIncome[currentOwner] || 0;
                playerPassiveIncome[currentOwner] = Math.max(0, previousOwnerIncome - cell.income);
            }
            
            // Новый владелец получает доход
            const currentIncome = playerPassiveIncome[playerIndex] || 0;
            playerPassiveIncome[playerIndex] = currentIncome + cell.income;
            
            // Обновляем владельца
            cellOwners[cellNumber] = playerIndex;
            
            // Добавляем в список бизнесов игрока
            if (!playerBusinesses[playerIndex]) {
                playerBusinesses[playerIndex] = [];
            }
            playerBusinesses[playerIndex].push(cellNumber);
            
            // Обновляем отображение
            // Bank logic removed
            updateCellOwnership(cellNumber, playerIndex);
            
            alert(`Бизнес "${cell.name}" ${currentOwner ? 'перекуплен' : 'куплен'} за $${cost.toLocaleString()}!\nДоход: $${cell.income.toLocaleString()}/ход`);
            
            return true;
        }

        function buyDream(cellNumber, playerIndex) {
            const cell = cellData[cellNumber];
            if (!cell || cell.type !== 'Мечта') return false;
            
            if (0 < cell.cost) {
                alert(`Недостаточно средств для покупки мечты. Нужно: $${cell.cost.toLocaleString()}`);
                return false;
            }
            
            // Списываем средства
            // Bank logic removed
            
            // Добавляем в список мечт игрока
            if (!playerDreams[playerIndex]) {
                playerDreams[playerIndex] = [];
            }
            playerDreams[playerIndex].push(cellNumber);
            
            // Обновляем отображение
            // Bank logic removed
            updateCellOwnership(cellNumber, playerIndex);
            
            alert(`Мечта "${cell.name}" куплена за $${cell.cost.toLocaleString()}!`);
            
            return true;
        }

        function checkWinConditions(playerIndex) {
            const businesses = playerBusinesses[playerIndex] || [];
            const dreams = playerDreams[playerIndex] || [];
            const passiveIncome = playerPassiveIncome[playerIndex] || 0;
            
            // Условие 1: 2 бизнеса + мечта
            const condition1 = businesses.length >= 2 && dreams.length >= 1;
            
            // Условие 2: бизнес + пассивный доход +50k к начальному
            const initialIncome = totalIncome; // Начальный доход с малого круга
            const condition2 = businesses.length >= 1 && passiveIncome >= initialIncome + 50000;
            
            if (condition1 || condition2) {
                alert(`🎉 ПОЗДРАВЛЯЕМ! ИГРОК ${playerIndex + 1} ПОБЕДИЛ! 🎉\n\nУсловие победы: ${condition1 ? '2 бизнеса + мечта' : 'Бизнес + пассивный доход +50k'}`);
                return true;
            }
            
            return false;
        }

        function updateCellOwnership(cellNumber, playerIndex) {
            // Обновляем цвет обводки клетки и ставим сердечко для мечты
            const cellElement = document.querySelector(`[data-cell="${cellNumber}"]`);
            if (cellElement) {
                cellElement.classList.remove('owned-by-player-0', 'owned-by-player-1', 'owned-by-player-2');
                cellElement.classList.add(`owned-by-player-${playerIndex}`);

                // Добавляем сердечко игрока (если ещё нет)
                let heart = cellElement.querySelector(`.cell-heart.p${playerIndex}`);
                if (!heart) {
                    heart = document.createElement('div');
                    heart.className = `cell-heart p${playerIndex}`;
                    heart.textContent = '❤️';
                    cellElement.appendChild(heart);
                }
            }
        }
        // Bank functions removed - keeping design only
        // loadFinancialData() - перенесено в bank-module/bank.js
        
        // updateBankUI() - перенесено в bank-module/bank.js
        
        // updateBalanceDisplay() - перенесено в bank-module/bank.js
        
        // updateFinancialSummary() - перенесено в bank-module/bank.js
        
        // updateCreditInfo() - перенесено в bank-module/bank.js
        // loadRecipients() - перенесено в bank-module/bank.js
        // processTransfer() - перенесено в bank-module/bank.js
        
        // validateTransferForm() - перенесено в bank-module/bank.js
        
        // prepareTransferData() - перенесено в bank-module/bank.js
        
        // sendTransferRequest() - перенесено в bank-module/bank.js
        
        // updateLocalData() - перенесено в bank-module/bank.js
        // updateLocalBalance() - перенесено в bank-module/bank.js
        
        // Функция shouldLoadBankData() удалена - больше не нужна
        
        // showTransferAnimation() - перенесено в bank-module/bank.js
        
        // Функция анимации изменения баланса
        // animateBalanceChange() - перенесено в bank-module/bank.js
        
        // Пример использования для других операций:
        // updateLocalBalance(-100, 'Списание за покупку'); // Списание 100$
        // updateLocalBalance(500, 'Выигрыш в лотерее'); // Пополнение 500$
        // updateLocalBalance(-50, 'Комиссия банка'); // Списание 50$
        // resetTransferForm() - перенесено в bank-module/bank.js

        // updateTransfersHistory() - перенесено в bank-module/bank.js
        
        // createTransferElement() - перенесено в bank-module/bank.js
        
        // getCurrentPlayerIndex() - перенесено в shared-utils.js
        
        // formatTransferTime() - перенесено в bank-module/bank.js
        // Функции для карточки игрока
        function openPlayerProfileModal(playerIndex = 0) {
            const modal = document.getElementById('playerProfileModal');
            if (!modal) return;
            
            // Загружаем данные игрока
            loadPlayerProfileData(playerIndex);
            
            modal.style.display = 'flex';
        }

        function closePlayerProfileModal() {
            const modal = document.getElementById('playerProfileModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function closePlayerProfileModalOnBackdrop(event) {
            if (event.target === event.currentTarget) {
                closePlayerProfileModal();
            }
        }
        // Функция погашения кредита
        async function payOffLoan(loanType) {
            if (isLoading) return;
            
            try {
                // Показываем индикатор загрузки
                showLoadingIndicator();
                isLoading = true;
                
                const roomId = getRoomIdFromURL();
                const user = JSON.parse(localStorage.getItem('user'));
                
                if (!roomId || !user) {
                    throw new Error('Данные комнаты или пользователя не найдены');
                }
                
                // Отправляем запрос на погашение
                const response = await fetch(`/api/rooms/${roomId}/payoff-loan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: user.id,
                        loanType: loanType
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Обновляем локальные данные
                    currentBalance = data.new_balance;
                    
                    // Показываем успех
                    showSuccess(`Кредит "${getLoanName(loanType)}" погашен успешно!`);
                    
                    // Обновляем UI
                    if (bankModule) {
                        bankModule.updateBankUI();
                    } else {
                    updateBankUI();
                    }
                    
                    // Перезагружаем данные профиля
                    if (bankModule) {
                        await bankModule.loadBankData(true); // Принудительное обновление после погашения кредита
                    }
                    
                } else {
                    throw new Error(data.message || 'Ошибка при погашении кредита');
                }
                
            } catch (error) {
                console.error('Payoff loan error:', error);
                showError(error.message);
            } finally {
                hideLoadingIndicator();
                isLoading = false;
            }
        }
        
        function getLoanName(loanType) {
            const names = {
                'car': 'Автокредит',
                'edu': 'Образовательный кредит',
                'mortgage': 'Ипотека',
                'credit': 'Кредитная карта'
            };
            return names[loanType] || 'Кредит';
        }
        
        // Вспомогательные функции UI
        function showLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = 'flex';
            }
        }
        
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        function showSuccess(message) {
            showNotification(message, 'success');
        }
        function showNotification(message, type = 'info') {
            // Создаем элемент уведомления
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Добавляем стили
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '12px 20px',
                borderRadius: '8px',
                color: 'white',
                fontWeight: '500',
                zIndex: '10000',
                transform: 'translateX(100%)',
                transition: 'transform 0.3s ease',
                maxWidth: '300px',
                wordWrap: 'break-word'
            });
            
            // Цвета в зависимости от типа
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6'
            };
            notification.style.backgroundColor = colors[type] || colors.info;
            
            // Добавляем в DOM
            document.body.appendChild(notification);
            
            // Анимация появления
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // Автоматическое скрытие
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // getRoomIdFromURL() - перенесено в shared-utils.js
        
        // Функция открытия модального окна кредита
        // openCreditModal() - перенесено в bank-module/bank.js
        // closeCreditModal() - перенесено в bank-module/bank.js
        // updateCreditModal() - перенесено в bank-module/bank.js
        // setCreditAmount() - перенесено в bank-module/bank.js
        // setMaxCreditAmount() - перенесено в bank-module/bank.js
        // updateCreditPreview() - перенесено в bank-module/bank.js
        // takeCredit() - перенесено в bank-module/bank.js
        // payOffCredit() - перенесено в bank-module/bank.js

        async function loadPlayerProfileData(playerIndex) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const roomId = urlParams.get('room');
                
                if (!roomId) {
                    console.error('Room ID not found in URL');
                    return;
                }

                const response = await fetch(`/api/rooms/${roomId}/player/${playerIndex}/profession`);
                if (!response.ok) {
                    throw new Error('Failed to load profession data');
                }

                const professionData = await response.json();

                // Обновляем элементы карточки
                document.getElementById('playerProfessionName').textContent = professionData.name;
                document.getElementById('playerProfessionDesc').textContent = professionData.description;
                document.getElementById('playerSalary').textContent = `$${professionData.salary.toLocaleString()}`;
                document.getElementById('playerExpenses').textContent = `$${professionData.expenses.toLocaleString()}`;
                document.getElementById('playerCashFlow').textContent = `$${professionData.cashFlow.toLocaleString()}`;
                document.getElementById('playerTaxes').textContent = `$${professionData.taxes.toLocaleString()} (13%)`;
                document.getElementById('playerOtherExpenses').textContent = `$${professionData.otherExpenses.toLocaleString()}`;
                document.getElementById('playerCarLoan').textContent = `$${professionData.carLoan.toLocaleString()}`;
                document.getElementById('playerCarLoanPrincipal').textContent = `$${professionData.carLoanPrincipal.toLocaleString()} (тело)`;
                document.getElementById('playerEduLoan').textContent = `$${professionData.eduLoan.toLocaleString()}`;
                document.getElementById('playerEduLoanPrincipal').textContent = `$${professionData.eduLoanPrincipal.toLocaleString()} (тело)`;
                document.getElementById('playerMortgage').textContent = `$${professionData.mortgage.toLocaleString()}`;
                document.getElementById('playerMortgagePrincipal').textContent = `$${professionData.mortgagePrincipal.toLocaleString()} (тело)`;
                document.getElementById('playerCreditCards').textContent = `$${professionData.creditCards.toLocaleString()}`;
                document.getElementById('playerCreditCardsPrincipal').textContent = `$${professionData.creditCardsPrincipal.toLocaleString()} (тело)`;
                document.getElementById('playerTotalCredits').textContent = `$${professionData.totalCredits.toLocaleString()}`;
            } catch (error) {
                console.error('Error loading player profile data:', error);
                // Fallback to default data
                const professionData = {
                    name: 'Предприниматель',
                    description: 'Владелец успешного бизнеса',
                    salary: 10000,
                    expenses: 6200,
                    cashFlow: 3800,
                    taxes: 1300,
                    otherExpenses: 1500,
                    carLoan: 700,
                    carLoanPrincipal: 14000,
                    eduLoan: 500,
                    eduLoanPrincipal: 10000,
                    mortgage: 1200,
                    mortgagePrincipal: 240000,
                    creditCards: 1000,
                    creditCardsPrincipal: 20000,
                    totalCredits: 284000
                };

                // Обновляем элементы карточки с fallback данными
                document.getElementById('playerProfessionName').textContent = professionData.name;
                document.getElementById('playerProfessionDesc').textContent = professionData.description;
                document.getElementById('playerSalary').textContent = `$${professionData.salary.toLocaleString()}`;
                document.getElementById('playerExpenses').textContent = `$${professionData.expenses.toLocaleString()}`;
                document.getElementById('playerCashFlow').textContent = `$${professionData.cashFlow.toLocaleString()}`;
                document.getElementById('playerTaxes').textContent = `$${professionData.taxes.toLocaleString()} (13%)`;
                document.getElementById('playerOtherExpenses').textContent = `$${professionData.otherExpenses.toLocaleString()}`;
                document.getElementById('playerCarLoan').textContent = `$${professionData.carLoan.toLocaleString()}`;
                document.getElementById('playerCarLoanPrincipal').textContent = `$${professionData.carLoanPrincipal.toLocaleString()} (тело)`;
                document.getElementById('playerEduLoan').textContent = `$${professionData.eduLoan.toLocaleString()}`;
                document.getElementById('playerEduLoanPrincipal').textContent = `$${professionData.eduLoanPrincipal.toLocaleString()} (тело)`;
                document.getElementById('playerMortgage').textContent = `$${professionData.mortgage.toLocaleString()}`;
                document.getElementById('playerMortgagePrincipal').textContent = `$${professionData.mortgagePrincipal.toLocaleString()} (тело)`;
                document.getElementById('playerCreditCards').textContent = `$${professionData.creditCards.toLocaleString()}`;
                document.getElementById('playerCreditCardsPrincipal').textContent = `$${professionData.creditCardsPrincipal.toLocaleString()} (тело)`;
                document.getElementById('playerTotalCredits').textContent = `$${professionData.totalCredits.toLocaleString()}`;
            }
        }

        function openBusinessModal() {
            alert('Функция Business будет реализована позже');
        }

        function openComplexModal() {
            alert('Функция Сложный будет реализована позже');
        }

        // Функции для работы с кредитами
        
        // Взять кредит
        function takeCredit(amount) {
            if (amount <= 0) return;
            
            // Добавляем кредит к балансу
            totalCredit += amount;
            currentBalance += amount;
            
            // Рассчитываем ежемесячный платеж (10% от суммы кредита)
            const newCreditPayment = Math.floor(amount * 0.1);
            creditPayment += newCreditPayment;
            
            // Обновляем расходы и PAYDAY
            monthlyExpenses += newCreditPayment;
            expensesBreakdown.credit += newCreditPayment;
            
            console.log(`💰 Взят кредит: $${amount.toLocaleString()}`);
            console.log(`💸 Ежемесячный платеж: $${newCreditPayment.toLocaleString()}`);
            console.log(`📊 Общий платеж по кредитам: $${creditPayment.toLocaleString()}`);
            console.log(`📊 Новые расходы: $${monthlyExpenses.toLocaleString()}`);
            
            // Обновляем отображение
            updateCreditDisplay();
            updateBalanceDisplay();
            updateFinancesDisplay(); // Обновляем PAYDAY и детализацию
            
            // Показываем уведомление
            alert(`✅ Кредит взят на $${amount.toLocaleString()}\n💸 Ежемесячный платеж: $${newCreditPayment.toLocaleString()}\n📊 Расходы увеличены на $${newCreditPayment.toLocaleString()}`);
        }
        // Погасить кредит
        function payoffCredit() {
            if (totalCredit <= 0) {
                alert('❌ У вас нет активных кредитов');
                return;
            }
            
            const canAfford = currentBalance >= totalCredit;
            if (!canAfford) {
                alert(`❌ Недостаточно средств для погашения кредита.\nНужно: $${totalCredit.toLocaleString()}\nУ вас: $${currentBalance.toLocaleString()}`);
                return;
            }
            
            const confirmPayoff = confirm(`Погасить кредит на $${totalCredit.toLocaleString()}?`);
            if (confirmPayoff) {
                // Списываем кредит с баланса
                currentBalance -= totalCredit;
                
                // Уменьшаем расходы на сумму платежа
                monthlyExpenses -= creditPayment;
                expensesBreakdown.credit = Math.max(0, expensesBreakdown.credit - creditPayment);
                
                console.log(`✅ Кредит погашен: $${totalCredit.toLocaleString()}`);
                console.log(`📊 Расходы уменьшены на: $${creditPayment.toLocaleString()}`);
                
                // Сбрасываем кредитные переменные
                totalCredit = 0;
                creditPayment = 0;
                
                // Обновляем отображение
                updateCreditDisplay();
                updateBalanceDisplay();
                
                alert(`✅ Кредит успешно погашен!\n📊 Расходы уменьшены на $${creditPayment.toLocaleString()}`);
            }
        }
        
        // Обновить отображение кредитов
        function updateCreditDisplay() {
            // Обновляем отображение кредита
            const currentCreditElement = document.getElementById('currentCredit');
            const maxCreditElement = document.getElementById('maxCredit');
            
            if (currentCreditElement) {
                currentCreditElement.textContent = `$${totalCredit.toLocaleString()}`;
            }
            
            if (maxCreditElement) {
                // Максимальный кредит = 10 * месячный доход
                const maxCredit = monthlyIncome * 10;
                maxCreditElement.textContent = `$${maxCredit.toLocaleString()}`;
            }
            
            // Обновляем расходы и PAYDAY
            updateFinancesDisplay();
        }
        // Обновить отображение финансов
        function updateFinancesDisplay() {
            // Находим элементы расходов и PAYDAY
            const expensesElement = document.getElementById('totalExpenses');
            const paydayElement = document.getElementById('monthlyIncome');
            
            if (expensesElement) {
                expensesElement.textContent = `$${monthlyExpenses.toLocaleString()}`;
            }
            
            // Детализация расходов
            const baseEl = document.getElementById('expenseBase');
            const creditEl = document.getElementById('expenseCredit');
            if (baseEl) baseEl.textContent = `$${(expensesBreakdown.base).toLocaleString()}`;
            if (creditEl) creditEl.textContent = `$${(expensesBreakdown.credit).toLocaleString()}`;

            if (paydayElement) {
                // PAYDAY = доход - расходы
                const payday = monthlyIncome - monthlyExpenses;
                paydayElement.textContent = `$${payday.toLocaleString()}/мес`;
                
                // Меняем цвет в зависимости от значения
                if (payday < 0) {
                    paydayElement.style.color = '#ef4444'; // Красный для отрицательного
                } else if (payday > 0) {
                    paydayElement.style.color = '#10b981'; // Зеленый для положительного
                } else {
                    paydayElement.style.color = '#f59e0b'; // Оранжевый для нуля
                }
            }

            // Обновляем видимость кнопки скоростной дороги для текущего игрока
            try {
                const btn = document.getElementById('fastTrackBtn');
                if (btn) {
                    const passive = (playerPassiveIncome && playerPassiveIncome[currentPlayer]) ? playerPassiveIncome[currentPlayer] : 0;
                    const canSwitch = (playerTracks[currentPlayer] === 'inner') && totalCredit === 0 && passive > monthlyExpenses;
                    btn.style.display = canSwitch ? 'block' : 'none';
                }
            } catch (e) {
                console.warn('FastTrack button toggle error:', e);
            }
        }

        // Ручной переход на скоростную дорогу (внешний круг)
        function switchToFastTrack() {
            const passive = (playerPassiveIncome && playerPassiveIncome[currentPlayer]) ? playerPassiveIncome[currentPlayer] : 0;
            if (playerTracks[currentPlayer] !== 'inner') return;
            if (totalCredit !== 0 || passive <= monthlyExpenses) return;
            playerTracks[currentPlayer] = 'outer';
            showNotification('🚀 Вы вышли на Скоростную дорогу!', 'success');
            const btn = document.getElementById('fastTrackBtn');
            if (btn) btn.style.display = 'none';
        }

        function toggleExpensesDetails() {
            const box = document.getElementById('expensesDetails');
            const caret = document.getElementById('expensesCaret');
            if (!box) return;
            const isHidden = box.style.display === 'none' || box.style.display === '';
            box.style.display = isHidden ? 'block' : 'none';
            if (caret) caret.textContent = isHidden ? '▴' : '▾';
        }
        
        // Открыть модальное окно кредитов
        function openCreditModalV3() {
            // Обновляем отображение
            updateCreditDisplay();
            
            // Показываем модальное окно
            document.getElementById('creditModal').style.display = 'block';
        }
        
        // Закрыть модальное окно кредитов
        function closeCreditModal() {
            document.getElementById('creditModal').style.display = 'none';
        }
        
        // Установить сумму кредита
        function setCreditAmount(amount) {
            const creditAmountInput = document.getElementById('creditAmount');
            if (creditAmountInput) {
                creditAmountInput.value = amount;
                updateCreditPreview();
            }
        }
        
        // Установить максимальную сумму кредита
        function setMaxCreditAmount() {
            const maxCredit = monthlyIncome * 10;
            setCreditAmount(maxCredit);
        }
        
        // Обновить предварительный просмотр кредита
        function updateCreditPreview() {
            const creditAmountInput = document.getElementById('creditAmount');
            if (!creditAmountInput) return;
            
            const amount = parseInt(creditAmountInput.value) || 0;
            const monthlyPayment = Math.floor(amount * 0.1);
            
            // Обновляем информацию о кредите
            const maxCreditAmountElement = document.getElementById('maxCreditAmount');
            if (maxCreditAmountElement) {
                const maxCredit = monthlyIncome * 10;
                maxCreditAmountElement.textContent = `$${maxCredit.toLocaleString()}`;
            }
            
            console.log(`Предварительный просмотр кредита: $${amount.toLocaleString()}, платеж: $${monthlyPayment.toLocaleString()}`);
        }
        // Запросить кредит
        function requestCredit() {
            const creditAmountInput = document.getElementById('creditAmount');
            if (!creditAmountInput) return;
            
            const amount = parseInt(creditAmountInput.value) || 0;
            
            if (amount <= 0) {
                alert('❌ Введите сумму кредита');
                return;
            }
            
            if (amount < 1000) {
                alert('❌ Минимальная сумма кредита: $1,000');
                return;
            }
            
            if (amount % 1000 !== 0) {
                alert('❌ Сумма кредита должна быть кратна $1,000');
                return;
            }
            
            // Проверяем максимальный кредит (учитываем уже взятые кредиты)
            const maxCredit = monthlyIncome * 10;
            const availableCredit = maxCredit - totalCredit;
            
            if (amount > availableCredit) {
                alert(`❌ Максимальная доступная сумма кредита: $${availableCredit.toLocaleString()}\n💳 Уже взято: $${totalCredit.toLocaleString()}\n📊 Максимум: $${maxCredit.toLocaleString()}`);
                return;
            }
            
            // Берем кредит
            takeCredit(amount);
            
            // Закрываем модальное окно
            closeCreditModal();
            // Обновляем финансы, чтобы PAYDAY и детализация обновились немедленно
            updateFinancesDisplay();
        }
        // Функции для работы с поп-апами клеток
        // Показать поп-ап клетки
        function showCellPopup(cellNumber, isInnerCell = false) {
            // Определяем, из какого круга клетка
            let cell;
            
            // Проверяем, является ли клетка внутренней (малый круг)
            if (isInnerCell || (cellNumber >= 1 && cellNumber <= 24 && !isOuterCell(cellNumber))) {
                // Малый круг (1-24)
                cell = innerCellData[cellNumber - 1];
                console.log(`Показываем поп-ап для внутренней клетки ${cellNumber}:`, cell);
            } else if (cellNumber >= 1 && cellNumber <= 44) {
                // Внешний периметр (1-44) - новые данные
                cell = getOuterCellDataNew(cellNumber);
                console.log(`Показываем поп-ап для внешней клетки ${cellNumber}:`, cell);
            } else {
                console.warn(`Неизвестный номер клетки: ${cellNumber}`);
                return;
            }
            
            // Проверяем наличие клетки
            function isOuterCell(cellNum) {
                // Проверяем, есть ли такая клетка во внешнем периметре
                return getOuterCellDataNew(cellNum) !== null;
            }
            
            if (!cell) return;

            // Специальная обработка для клеток "Возможность" (сделки)
            if (cell.type === 'Возможность') {
                showDealChoiceModal();
                return;
            }
            
            if (cell.type === 'Рынок') {
                showMarketModal();
                return;
            }
            
            if (cell.type === 'Расходы' || cell.type === 'Трата' || cell.isExpense) {
                showExpenseModal();
                return;
            }

            // Заполняем поп-ап данными
            const titleEl = document.getElementById('cellPopupTitle');
            if (titleEl) {
                // Для PayDay показываем короткий заголовок без цвета
                if (cell.type === 'PayDay') {
                    titleEl.textContent = 'PayDay';
                } else if (cell.type === 'Благотворительность') {
                    titleEl.textContent = 'Благотворительность';
                } else {
                    titleEl.textContent = cell.name;
                }
            }
            
            // Заполняем цвет клетки – показываем цветной бейдж вместо текста
            const colorValue = (cell.color || '').toLowerCase();
            const colorToHex = {
                green: '#10b981',
                blue: '#3b82f6',
                yellow: '#f59e0b',
                pink: '#ec4899',
                red: '#ef4444',
                orange: '#f97316',
                purple: '#8b5cf6',
                black: '#111827',
                gray: '#6b7280',
                charity: '#ff6b6b'
            };
            const colorBadge = document.createElement('span');
            colorBadge.className = 'color-badge';
            colorBadge.style.background = colorToHex[colorValue] || '#6b7280';
            const colorCell = document.getElementById('cellPopupColor');
            colorCell.textContent = '';
            colorCell.appendChild(colorBadge);
            document.getElementById('cellPopupType').textContent = cell.type;
            document.getElementById('cellPopupCost').textContent = cell.cost > 0 ? `$${cell.cost.toLocaleString()}` : 'Бесплатно';
            
            // Отображение дохода или потерь
            if (cell.loss) {
                document.getElementById('cellPopupIncome').textContent = cell.loss;
            } else if (cell.income > 0) {
                document.getElementById('cellPopupIncome').textContent = `$${cell.income.toLocaleString()}/мес`;
            } else if (typeof cell.income === 'string') {
                document.getElementById('cellPopupIncome').textContent = cell.income;
            } else if (cell.income < 0) {
                document.getElementById('cellPopupIncome').textContent = `$${cell.income.toLocaleString()}/мес`;
            } else {
                document.getElementById('cellPopupIncome').textContent = 'Нет дохода';
            }
            
            // PayDay: это доход. Показываем сумму в поле «Доход», «Стоимость» — Бесплатно
            if (cell.type === 'PayDay') {
                const paydayAmount = Math.max(0, (monthlyIncome || 0) - (monthlyExpenses || 0));
                document.getElementById('cellPopupDescription').textContent = `Получить зарплату: $${paydayAmount.toLocaleString()}`;
                document.getElementById('cellPopupCost').textContent = 'Бесплатно';
                document.getElementById('cellPopupIncome').textContent = `$${paydayAmount.toLocaleString()}`;
                // Начисляем PAYDAY сразу после попадания на клетку
                try {
                    if (paydayAmount > 0) {
                        addBalance(paydayAmount, 'PayDay');
                        showNotification(`💵 PAYDAY: +$${paydayAmount.toLocaleString()}`, 'success');
                    } else if (paydayAmount < 0) {
                        subtractBalance(Math.abs(paydayAmount), 'Отрицательный PayDay');
                        showNotification(`⚠️ PAYDAY отрицательный: -$${Math.abs(paydayAmount).toLocaleString()}`, 'warning');
                    }
                } catch (e) { console.warn('PayDay apply failed:', e); }
            } else {
                document.getElementById('cellPopupDescription').textContent = cell.description;
            }

            // Спец-логика для Благотворительности
            const extraArea = document.getElementById('cellPopupExtra');
            if (extraArea) extraArea.innerHTML = '';
            if (cell.type === 'Благотворительность') {
                const container = document.createElement('div');
                container.style.marginTop = '10px';
                const isOuter = !isInnerCell && (cellNumber >= 1 && cellNumber <= 44);
                if (isOuter) {
                    container.innerHTML = `
                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <button class="modern-btn secondary" id="charityPayOuter">Оплатить $100,000</button>
                            <span style="opacity:.8">После оплаты сможете выбирать 1, 2 или 3 кубика перед броском</span>
                        </div>
                        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                            <span>Кубики на ход:</span>
                            <button class="modern-btn" data-dice="1">1</button>
                            <button class="modern-btn" data-dice="2">2</button>
                            <button class="modern-btn" data-dice="3">3</button>
                        </div>
                    `;
                    setTimeout(() => {
                        const payBtn = document.getElementById('charityPayOuter');
                        if (payBtn) payBtn.onclick = () => {
                            if ((currentBalance || 0) >= 100000) {
                                subtractBalance(100000, 'Благотворительность (большой круг)');
                                showNotification('✅ Оплата $100,000 принята. Доступно 1-3 кубика.', 'success');
                            } else {
                                alert('Недостаточно средств: нужно $100,000');
                            }
                        };
                        container.querySelectorAll('button[data-dice]')
                            .forEach(btn => btn.onclick = () => {
                                const n = parseInt(btn.getAttribute('data-dice'));
                                fastTrackDiceChoice[currentPlayer] = n;
                                showNotification(`🎲 Выбрано кубиков: ${n}`, 'info');
                            });
                    }, 0);
                } else {
                    // Малый круг
                    const tenPercent = Math.floor((monthlyIncome || 0) * 0.10);
                    container.innerHTML = `
                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <button class="modern-btn secondary" id="charityPayInner">Оплатить $${tenPercent.toLocaleString()}</button>
                            <button class="modern-btn credit" id="charityCreditBtn">Взять кредит</button>
                        </div>
                        <div style="margin-top:8px; font-size:12px; opacity:0.8;">
                            💡 10% от дохода $${(monthlyIncome || 0).toLocaleString()} = $${tenPercent.toLocaleString()}
                        </div>
                        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                            <span>Кубики на ход:</span>
                            <button class="modern-btn" data-dice="1">1</button>
                            <button class="modern-btn" data-dice="2">2</button>
                        </div>
                    `;
                    setTimeout(() => {
                        const payBtn = document.getElementById('charityPayInner');
                        if (payBtn) payBtn.onclick = () => {
                            // Рассчитываем 10% от общего дохода (до вычета расходов)
                            const tenPercent = Math.floor((monthlyIncome || 0) * 0.10);
                            const paydayElement = document.getElementById('monthlyIncome');
                            const currentPayday = monthlyIncome - monthlyExpenses;
                            
                            if ((currentBalance || 0) >= tenPercent) {
                                subtractBalance(tenPercent, `Благотворительность (10% от дохода $${monthlyIncome.toLocaleString()})`);
                                showNotification(`✅ Оплата $${tenPercent.toLocaleString()} принята. Доступно 1-2 кубика.`, 'success');
                                
                                // Обновляем отображение
                                if (paydayElement) {
                                    const newPayday = monthlyIncome - monthlyExpenses;
                                    paydayElement.textContent = `$${newPayday.toLocaleString()}/мес`;
                                }
                            } else {
                                alert(`Недостаточно средств: нужно $${tenPercent.toLocaleString()}\nВаш баланс: $${(currentBalance || 0).toLocaleString()}`);
                            }
                        };
                        const creditBtn = document.getElementById('charityCreditBtn');
                        if (creditBtn) creditBtn.onclick = () => openCreditModalV3();
                        container.querySelectorAll('button[data-dice]')
                            .forEach(btn => btn.onclick = () => {
                                const n = parseInt(btn.getAttribute('data-dice'));
                                fastTrackDiceChoice[currentPlayer] = n;
                                showNotification(`🎲 Выбрано кубиков: ${n}`, 'info');
                            });
                    }, 0);
                }
                if (extraArea) extraArea.appendChild(container);
            }

            // Показываем кнопку покупки только если клетка имеет стоимость
            const buyButton = document.getElementById('cellBuyButton');
            if (cell.cost > 0) {
                buyButton.style.display = 'inline-block';
                buyButton.onclick = () => buyCellFromPopup(cellNumber);
            } else {
                buyButton.style.display = 'none';
            }

            // Показываем поп-ап
            document.getElementById('cellPopupModal').style.display = 'block';
        }

        // Закрыть поп-ап клетки
        function closeCellPopup() {
            document.getElementById('cellPopupModal').style.display = 'none';
        }
        // Покупка клетки из поп-апа
        function buyCellFromPopup(cellNumber) {
            const cell = getOuterCellDataNew(cellNumber);
            if (!cell || cell.cost <= 0) return;

            const canAfford = (currentBalance || 0) >= cell.cost;
            if (canAfford) {
                const buy = confirm(`Купить "${cell.name}" за $${cell.cost.toLocaleString()}?`);
                if (buy) {
                    subtractBalance(cell.cost, `Покупка: ${cell.name}`);
                    
                    if (cell.type === 'Бизнес' && cell.income > 0) {
                        addMonthlyIncome(cell.income, `Бизнес: ${cell.name}`);
                        alert(`🏢 Поздравляем! Вы купили бизнес: ${cell.name}\nДоход: $${cell.income}/мес`);
                    } else if (cell.type === 'Мечта') {
                        alert(`🎯 Поздравляем! Вы реализовали мечту: ${cell.name}`);
                    }
                    
                    closeCellPopup();
                }
            } else {
                alert(`❌ Недостаточно средств для покупки.\nНужно: $${cell.cost.toLocaleString()}\nУ вас: $${(currentBalance || 0).toLocaleString()}`);
            }
        }

        // Закрытие поп-апа при клике на фон
        window.onclick = function(event) {
            const modal = document.getElementById('cellPopupModal');
            if (event.target === modal) {
                closeCellPopup();
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            loadRoomPlayers();
            // Подписка на события комнаты (SSE)
            try {
                const roomId = getRoomIdFromURL();
                if (roomId) {
                    const evtSource = new EventSource(`/api/rooms/${roomId}/events`);
                    evtSource.onmessage = (e) => {
                        try {
                            const msg = JSON.parse(e.data || '{}');
                            if (msg.type === 'player-move' && Array.isArray(msg.player_positions)) {
                                // Обновляем локальные позиции (0..23 → 1..24)
                                for (let i = 0; i < msg.player_positions.length; i++) {
                                    const zeroBased = msg.player_positions[i];
                                    // Позиция 0 = клетка 1 (старт), позиция 1+ = соответствующие клетки
                                    playerPositions[i] = (zeroBased % 24) + 1;
                                }
                                updatePlayerTokenPositions();
                            }
                        } catch (err) { console.warn('Bad SSE message', err); }
                    };
                }
            } catch (e) { console.warn('SSE init failed:', e); }
        });
    </script>

    <!-- Cell Popup Modal -->
    <div id="cellPopupModal" class="cell-popup-modal">
        <div class="cell-popup-content">
            <div class="cell-popup-header">
                <h3 id="cellPopupTitle">Информация о клетке</h3>
                <span class="cell-popup-close" onclick="closeCellPopup()">&times;</span>
            </div>
            <div class="cell-popup-body">
                <div class="cell-popup-info">
                    <div class="cell-info-row">
                        <span class="cell-label">Цвет:</span>
                        <span class="cell-value" id="cellPopupColor">-</span>
                    </div>
                    <div class="cell-info-row">
                        <span class="cell-label">Тип:</span>
                        <span class="cell-value" id="cellPopupType">-</span>
                    </div>
                    <div class="cell-info-row">
                        <span class="cell-label">Стоимость:</span>
                        <span class="cell-value" id="cellPopupCost">-</span>
                    </div>
                    <div class="cell-info-row">
                        <span class="cell-label">Доход:</span>
                        <span class="cell-value" id="cellPopupIncome">-</span>
                    </div>
                    <div class="cell-info-row">
                        <span class="cell-label">Описание:</span>
                        <span class="cell-value" id="cellPopupDescription">-</span>
                    </div>
                </div>
                <div class="cell-popup-actions">
                    <button class="cell-btn-primary" onclick="buyCellFromPopup()" id="cellBuyButton" style="display: none;">Купить</button>
                    <button class="cell-btn-secondary" onclick="refuseCellFromPopup()" id="cellRefuseButton" style="display: none;">Отказаться</button>
                    <button class="cell-btn-secondary" onclick="transferCellFromPopup()" id="cellTransferButton" style="display: none;">Передать карточку</button>
                    <button class="cell-btn-secondary" onclick="closeCellPopup()">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Credit Modal -->
    <div id="creditModal" class="modal">
        <div class="modal-content credit-modal">
            <div class="modal-header">
                <h2>💳 Кредитование</h2>
                <button class="close-btn" onclick="closeCreditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="credit-info">
                    <div class="info-item">
                        <span class="label">Денежный поток:</span>
                        <span class="value" id="currentCashFlow">$0</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Максимальный кредит:</span>
                        <span class="value" id="maxCreditAmount">$0</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Текущий кредит:</span>
                        <span class="value" id="currentCreditAmount">$0</span>
                    </div>
                </div>
                
                <div class="credit-form">
                    <div class="form-group">
                        <label for="creditAmount">Сумма кредита (кратно 1000$):</label>
                        <div class="amount-input">
                            <input type="number" id="creditAmount" min="1000" step="1000" placeholder="1000" oninput="updateCreditPreview()" onchange="updateCreditPreview()">
                            <div class="amount-buttons">
                                <button type="button" onclick="setCreditAmount(1000)">1K</button>
                                <button type="button" onclick="setCreditAmount(5000)">5K</button>
                                <button type="button" onclick="setCreditAmount(10000)">10K</button>
                                <button type="button" onclick="setCreditAmount(50000)">50K</button>
                                <button type="button" onclick="setMaxCreditAmount()">Макс</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credit-preview">
                        <div class="preview-item">
                            <span>Новый денежный поток:</span>
                            <span id="newCashFlow">$0</span>
                        </div>
                        <div class="preview-item">
                            <span>Ежемесячный платеж:</span>
                            <span id="monthlyPayment">$0</span>
                        </div>
                    </div>
                </div>
                
                <div class="credit-actions">
                    <button class="modern-btn primary" onclick="requestCredit()">
                        <span class="btn-icon">💳</span>
                        Взять кредит
                    </button>
                    <button class="modern-btn secondary" onclick="payOffCredit()">
                        <span class="btn-icon">💰</span>
                        Погасить кредит
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Bank v3 modal will be loaded dynamically -->
    
    <!-- Общие утилиты и константы -->
    <script src="shared-constants.js"></script>
    <script src="shared-utils.js"></script>
    
    <!-- Bank v3 module -->
    <script src="bank-module-v2/BankCore.js"></script>
    <script src="bank-module-v2/BankApiService.js"></script>
    <script src="bank-module-v2/BankUIService.js"></script>
    <script src="bank-module-v2/BankModule.js"></script>
    <script src="bank-module-v3/bank-module-v3.js"></script>
    
    <!-- Deal Choice Modal -->
    <div id="dealChoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎯 Выберите тип сделки</h2>
                <button class="close-btn" onclick="closeDealChoiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="deal-choice-container">
                    <div class="deal-option" onclick="chooseSmallDeal()">
                        <div class="deal-icon">🏠</div>
                        <h3>Малая сделка</h3>
                        <p>Инвестиции от $1,000 до $8,000</p>
                        <div class="deal-count">Карт в колоде: <span id="smallDealCount">8</span></div>
                    </div>
                    <div class="deal-option" onclick="chooseBigDeal()">
                        <div class="deal-icon">🏢</div>
                        <h3>Большая сделка</h3>
                        <p>Инвестиции от $30,000 до $200,000</p>
                        <div class="deal-count">Карт в колоде: <span id="bigDealCount">8</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Modal -->
    <div id="cardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="cardTitle">Карточка сделки</h2>
                <button class="close-btn" onclick="closeCardModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card-info">
                    <div class="card-info-row">
                        <span class="card-label">Стоимость:</span>
                        <span class="card-value" id="cardCost">$0</span>
                    </div>
                    <div class="card-info-row">
                        <span class="card-label">Доход:</span>
                        <span class="card-value" id="cardIncome">$0/мес</span>
                    </div>
                    <div class="card-info-row">
                        <span class="card-label">Описание:</span>
                        <span class="card-value" id="cardDescription">-</span>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="modern-btn primary" onclick="buyCard()" id="cardBuyButton">Купить</button>
                    <button class="modern-btn secondary" onclick="refuseCard()" id="cardRefuseButton">Отказаться</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Board Modules -->
    <script src="game-board/GameBoardService.js"></script>
    <script src="game-board/GameBoardUI.js"></script>
</body>
</html>