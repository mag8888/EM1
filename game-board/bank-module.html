<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –º–æ–¥—É–ª—å - Game Board v2.0</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: radial-gradient(circle at 15% 20%, rgba(0, 234, 255, 0.18) 0%, transparent 55%),
                        radial-gradient(circle at 78% 82%, rgba(255, 0, 128, 0.18) 0%, transparent 55%),
                        linear-gradient(150deg, #0c1424 0%, #181f32 50%, #0a101f 100%);
            color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .bank-container {
            background: linear-gradient(160deg, #151d30 0%, #111527 45%, #0f1422 100%);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 40px 120px rgba(0, 0, 0, 0.6), inset 0 0 60px rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            width: 100%;
            max-width: 600px;
            position: relative;
            overflow: hidden;
        }

        .bank-container::before {
            content: '';
            position: absolute;
            inset: 16px;
            border-radius: 16px;
            background: radial-gradient(circle at 50% 42%, rgba(255, 205, 64, 0.12) 0%, transparent 60%),
                        linear-gradient(200deg, rgba(32, 48, 78, 0.7) 0%, rgba(16, 22, 34, 0.95) 62%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            pointer-events: none;
            z-index: 1;
        }

        .bank-header {
            text-align: center;
            margin-bottom: 32px;
            position: relative;
            z-index: 2;
        }

        .bank-title {
            font-size: 28px;
            font-weight: 900;
            color: #ffd15a;
            text-shadow: 0 0 20px rgba(255, 196, 0, 0.55);
            margin-bottom: 8px;
        }

        .bank-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .balance-section {
            background: linear-gradient(135deg, rgba(22, 247, 158, 0.1) 0%, rgba(6, 185, 115, 0.05) 100%);
            border: 1px solid rgba(22, 247, 158, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .balance-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 900;
            color: #16f79e;
            text-shadow: 0 0 20px rgba(22, 247, 158, 0.5);
        }

        .transfer-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            z-index: 2;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
            color: #ffffff;
            transition: all 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #16f79e;
            box-shadow: 0 0 0 3px rgba(22, 247, 158, 0.2);
        }

        .form-group select option {
            background: #1a1d24;
            color: #ffffff;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #16f79e 0%, #06b973 100%);
            color: #03110a;
            box-shadow: 0 14px 26px rgba(6, 185, 115, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(6, 185, 115, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .history-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            z-index: 2;
        }

        .credit-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(59, 130, 246, 0.03) 100%);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            flex: 1;
        }

        .history-amount {
            font-weight: 700;
            color: #16f79e;
        }

        .history-amount.outgoing {
            color: #ff6b6b;
        }

        .history-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #ffffff;
            font-size: 18px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 3;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .error-message {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(255, 71, 87, 0.05) 100%);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            color: #ff6b6b;
            font-size: 14px;
            display: none;
        }

        .success-message {
            background: linear-gradient(135deg, rgba(22, 247, 158, 0.1) 0%, rgba(6, 185, 115, 0.05) 100%);
            border: 1px solid rgba(22, 247, 158, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            color: #16f79e;
            font-size: 14px;
            display: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .bank-container {
                padding: 24px;
                margin: 10px;
            }

            .balance-amount {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="bank-container">
        <button class="close-btn" onclick="closeBankModule()">‚úï</button>
        
        <div class="bank-header">
            <div class="bank-title">üè¶ –ë–ê–ù–ö–û–í–°–ö–ò–ï –û–ü–ï–†–ê–¶–ò–ò</div>
            <div class="bank-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –≤ –∏–≥—Ä–µ</div>
        </div>

        <div class="balance-section">
            <div class="balance-label">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
            <div class="balance-amount" id="currentBalance">$0</div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="transfer-section">
            <div class="section-title">
                <span>üí∏</span>
                <span>–ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</span>
            </div>
            
            <div class="form-group">
                <label for="recipientSelect">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                <select id="recipientSelect">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="transferAmount">–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞</label>
                <input type="number" id="transferAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" min="1">
            </div>
            
            <button class="btn btn-primary" id="transferBtn" onclick="makeTransfer()">
                üí≥ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞
            </button>
        </div>

        <div class="history-section">
            <div class="section-title">
                <span>üìã</span>
                <span>–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤</span>
            </div>
            <div class="history-list" id="historyList">
                <div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 20px;">
                    –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –ø—É—Å—Ç–∞
                </div>
            </div>
        </div>

        <div class="credit-section">
            <div class="section-title">
                <span>üè¶</span>
                <span>–ö—Ä–µ–¥–∏—Ç</span>
            </div>
            <div class="form-group">
                <label>–î–æ—Å—Ç—É–ø–Ω—ã–π –ª–∏–º–∏—Ç</label>
                <div id="creditLimit" style="font-weight:700;color:#16f79e">‚Äî</div>
            </div>
            <div class="form-group">
                <label for="creditAmount">–°—É–º–º–∞ (–∫—Ä–∞—Ç–Ω–æ $1000)</label>
                <input type="number" id="creditAmount" step="1000" min="1000" placeholder="1000">
            </div>
            <div class="form-group" style="display:flex;gap:10px;">
                <button class="btn btn-primary" style="flex:1" onclick="takeCredit()">–í–∑—è—Ç—å</button>
                <button class="btn" style="flex:1;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2)" onclick="repayCredit()">–ü–æ–≥–∞—Å–∏—Ç—å</button>
            </div>
            <div style="font-size:12px;color:rgba(255,255,255,0.6)">–ö–∞–∂–¥—ã–µ $1000 –∫—Ä–µ–¥–∏—Ç–∞ —É–º–µ–Ω—å—à–∞—é—Ç PAYDAY –Ω–∞ $100/–º–µ—Å</div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser;
        let currentRoom;
        let currentBalance = 0;
        let roomPlayers = [];
        let creditStatus = { loanAmount: 0, maxAvailable: 0, cashflow: 0 };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
            try {
                const storedUser = localStorage.getItem('user');
                if (storedUser) {
                    const parsed = JSON.parse(storedUser);
                    currentUser = parsed.username || (parsed.email ? parsed.email.split('@')[0] : '–ì–æ—Å—Ç—å');
                } else {
                    currentUser = localStorage.getItem('username') || '–ì–æ—Å—Ç—å';
                }
            } catch (_) {
                currentUser = localStorage.getItem('username') || '–ì–æ—Å—Ç—å';
            }
            const roomData = localStorage.getItem('currentRoom');
            
            if (!roomData) {
                showError('–í—ã –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ–º–Ω–∞—Ç–µ');
                return;
            }
            
            currentRoom = JSON.parse(roomData);
            roomPlayers = currentRoom.players || [];
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥—É–ª—å
            initializeBankModule();
        });

        function initializeBankModule() {
            loadBalance();
            loadPlayers();
            loadTransferHistory();
            loadCreditStatus();
        }

        async function loadBalance() {
            try {
                const response = await fetch(`/api/bank/balance/${currentUser}/${currentRoom.id}`);
                const data = await response.json();
                currentBalance = data.amount;
                updateBalanceDisplay();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞');
            }
        }

        function loadPlayers() {
            const select = document.getElementById('recipientSelect');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞...</option>';
            
            roomPlayers.forEach(player => {
                if (player.name !== currentUser) {
                    const option = document.createElement('option');
                    option.value = player.name;
                    option.textContent = player.name;
                    select.appendChild(option);
                }
            });
        }

        async function loadTransferHistory() {
            try {
                const response = await fetch(`/api/bank/history/${currentRoom.id}`);
                const history = await response.json();
                updateHistoryDisplay(history);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            }
        }

        function updateBalanceDisplay() {
            document.getElementById('currentBalance').textContent = `$${currentBalance}`;
        }

        async function loadCreditStatus() {
            try {
                const res = await fetch(`/api/bank/credit/status/${currentUser}/${currentRoom.id}`);
                creditStatus = await res.json();
                document.getElementById('creditLimit').textContent = `–¢–µ–∫—É—â–∏–π –¥–æ–ª–≥: $${creditStatus.loanAmount.toLocaleString()} ‚Ä¢ –õ–∏–º–∏—Ç: $${creditStatus.maxAvailable.toLocaleString()}`;
            } catch (e) {
                console.error('Credit status error', e);
            }
        }

        function updateHistoryDisplay(history) {
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 20px;">–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –ø—É—Å—Ç–∞</div>';
                return;
            }
            
            historyList.innerHTML = history.slice(-10).reverse().map(transfer => {
                const isOutgoing = transfer.from === currentUser;
                const isIncoming = transfer.to === currentUser;
                
                let displayText = '';
                let amountClass = '';
                let reasonText = '';
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏—á–∏–Ω—É –æ–ø–µ—Ä–∞—Ü–∏–∏
                if (transfer.reason) {
                    reasonText = `<div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">${transfer.reason}</div>`;
                }
                
                if (isOutgoing) {
                    displayText = `–ü–µ—Ä–µ–≤–æ–¥ –∏–≥—Ä–æ–∫—É ${transfer.to}`;
                    amountClass = 'outgoing';
                } else if (isIncoming) {
                    displayText = `–ü–æ–ª—É—á–µ–Ω–æ –æ—Ç ${transfer.from}`;
                    amountClass = '';
                } else {
                    displayText = `${transfer.from} ‚Üí ${transfer.to}`;
                    amountClass = '';
                }
                
                const time = new Date(transfer.timestamp).toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="history-item">
                        <div class="history-info">
                            <div>${displayText}${reasonText}</div>
                            <div class="history-time">${time}</div>
                        </div>
                        <div class="history-amount ${amountClass}">
                            ${isOutgoing ? '-' : '+'}$${transfer.amount}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function makeTransfer() {
            const recipient = document.getElementById('recipientSelect').value;
            const amount = parseInt(document.getElementById('transferAmount').value);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!recipient) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è');
                return;
            }
            
            if (!amount || amount <= 0) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }
            
            if (amount > currentBalance) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            const transferBtn = document.getElementById('transferBtn');
            transferBtn.disabled = true;
            transferBtn.textContent = '–ü–µ—Ä–µ–≤–æ–¥–∏–º...';
            
            try {
                const response = await fetch('/api/bank/transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        from: currentUser,
                        to: recipient,
                        amount: amount,
                        roomId: currentRoom.id
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess('–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    currentBalance = result.newBalance.amount;
                    updateBalanceDisplay();
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('recipientSelect').value = '';
                    document.getElementById('transferAmount').value = '';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
                    loadTransferHistory();
                } else {
                    showError(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            } finally {
                transferBtn.disabled = false;
                transferBtn.textContent = 'üí≥ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞';
            }
        }

        async function takeCredit() {
            const amount = parseInt(document.getElementById('creditAmount').value || '0', 10);
            if (!amount || amount % 1000 !== 0) {
                showError('–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫—Ä–∞—Ç–Ω–∞ $1000');
                return;
            }
            try {
                const res = await fetch('/api/bank/credit/take', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, roomId: currentRoom.id, amount })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –∫—Ä–µ–¥–∏—Ç–∞');
                currentBalance = data.newBalance.amount;
                updateBalanceDisplay();
                await loadCreditStatus();
                showSuccess('–ö—Ä–µ–¥–∏—Ç –≤—ã–¥–∞–Ω');
            } catch (e) {
                showError(e.message);
            }
        }

        async function repayCredit() {
            const amount = parseInt(document.getElementById('creditAmount').value || '0', 10);
            if (!amount || amount % 1000 !== 0) {
                showError('–°—É–º–º–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫—Ä–∞—Ç–Ω–∞ $1000');
                return;
            }
            try {
                const res = await fetch('/api/bank/credit/repay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, roomId: currentRoom.id, amount })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è');
                currentBalance = data.newBalance.amount;
                updateBalanceDisplay();
                await loadCreditStatus();
                showSuccess('–ö—Ä–µ–¥–∏—Ç –ø–æ–≥–∞—à–µ–Ω');
            } catch (e) {
                showError(e.message);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function closeBankModule() { window.close(); }
    </script>
</body>
</html>
